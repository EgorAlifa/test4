import { IQueryVariableInfo, IQuerySortInfo, IQueryFilterInfo, IQueryMetricCustomInfo, IDatasetQueryMetricCustom } from '../utils';
import { IDatasetQuery } from '../types.d.ts';
import { DrilldownService, IDatasetQueryDrilldown } from './drilldown';

export class QueryModelBase {
    /**
     * @type {IDatasetQuery}
     */
    private _query: IDatasetQuery;

    constructor(query: IDatasetQuery);

    /**
     *
     * @type {IDatasetQuery}
     */
    public readonly raw: IDatasetQuery;

    /**
     * @type {string}
     */
    public from: string;

    /**
     * @type {string[]}
     */
    public fields: string[];

    /**
     * @type {string[]}
     */
    public metrics: string[];

    /**
     * @type {string[]}
     */
    public dimensions: string[];

    /**
     * @type {IQueryFilterInfo[]}
     */
    public filters: IQueryFilterInfo[];

    /**
     * @type {IQueryVariableInfo[]}
     */
    public variables: IQueryVariableInfo[];

    /**
     * variable names
     */
    public variableNames: `@${string}`[];

    /**
     * @type {IDatasetQueryMetricCustom[]}
     */
    public metricsCustom: IDatasetQueryMetricCustom[];

    /**
     * @type {IQuerySortInfo[]}
     */
    public sort: IDatasetQuerySortInfo[];

    /**
     * @type {IDatasetQueryDrilldown[]}
     */
    public drilldowns: IDatasetQueryDrilldown[];
}

export class QueryModelExtended extends QueryModelBase {
    public readonly prepared: Partial<IDatasetQuery>;

    _build(query: IDatasetQuery): IDatasetQuery;

    /**
     * @return {string[]}
     */
    public order: string[];

    /**
     * @return {IDatasetQueryDrilldown[]}
     */
    public drilldowns: IDatasetQueryDrilldown[];

    hasFilter(filter: IQueryFilterInfo | string): boolean;

    hasSort(sort: IQuerySortInfo | string): boolean;

    getParamName(param: string): string | null;

    /**
     *
     * @return {import('../utils').IQueryFilterInfo}
     */
    createBlankFilter(): IQueryFilterInfo;

    /**
     *
     * @returns {import('../utils').IQuerySortInfo}
     */
    createBlankSort(): IQuerySortInfo;

    filterGetInfo(name: IQueryFilterInfo['name']): IQueryFilterInfo | undefined;

    filterAdd({ name, operator, value }: IQueryFilterInfo, forceUpdate = true): boolean;

    filterRemove(name: IQueryFilterInfo['name']): boolean;

    filterRemoveAll(): void;

    sortAdd({ name, direction }: IQuerySortInfo, forceUpdate: boolean = true): void;

    sortRemove(sortInfo: IQuerySortInfo['name']): void;

    sortRemoveAll(): void;

    variableGetInfo(name: IQueryVariableInfo['name']): IQueryVariableInfo | undefined;

    variableAdd({ name, value }: IQueryVariableInfo, forceUpdate: boolean = true): void;

    variableRemove(variableInfo: IQueryVariableInfo['name']): void;

    metricCustomAdd({ name, field, func }: IQueryMetricCustomInfo, forceUpdate: boolean = true): boolean;

    metricCustomRemove(name: IQueryMetricCustomInfo['name']): boolean;

    metricCustomRemoveAll(): void;

    createResultQueryParamMap(): Record<string, string>;
}

export class QueryModel extends QueryModelExtended {
    private _drilldown: DrilldownService;

    private readonly _raw: IDatasetQuery;

    public readonly drilldown: DrilldownService;

    private _initDrilldown();

    getBaseModel(): QueryModelBase;
}

export function DatasetQueryModelFactory(query: IDatasetQuery): QueryModel;
