import { ProjectDataProviderRepository } from '@goodt-common/dremio';
import { CoreError } from '@goodt-wcore/errors';
import { QueryModel } from './query-model';

export class RequestBuilder {
    /** @type {Omit<import('./types').IDatasetRequestProps, 'query'>} */
    _options;

    /** @type {import('@goodt-common/data').QueryModel} */
    _queryModel;

    /**
     * @param {import('@goodt-common/data').IDatasetRequestProps} options
     */
    constructor(options) {
        this.options = options;
    }

    /**
     * @param {import('@goodt-common/data').IDatasetRequestProps} options
     */
    set options(options) {
        const { name, dataProviderId, limit, query } = options;
        this._options = { name, dataProviderId, limit };
        this._queryModel = new QueryModel(query);
    }

    /**
     * @return {Omit<import('./types').IDatasetRequestProps, 'query'>}
     */
    get options() {
        return this._options;
    }

    /**
     * @returns {import('./query-model').QueryModel}
     */
    get queryModel() {
        return this._queryModel;
    }

    /**
     * @returns {import('./client').IDatasetRequest}
     */
    build() {
        const { dataProviderId, limit } = this._options;
        const query = this._queryModel.prepared;
        const dataProvider =
            ProjectDataProviderRepository.getById(dataProviderId) ?? ProjectDataProviderRepository.getDefault();
        if (dataProvider == null) {
            throw new CoreError(
                `Data provider with id "${dataProviderId}" not found in "ProjectDataProviderRepository"`
            );
        }

        const { url } = dataProvider.connector;
        // @NOTE а если нет даже дефолта, что делать? Exception?
        return { query, url, limit };
    }
}
