import { ComponentOptions } from 'vue';
import {
    Request,
    QueryModel,
    IDatasetResult,
    IDatasetRequestProps,
    IDatasetPanelOptions,
    DataClientRequestError,
    IDatasetQueryFilterInfo,
    Drilldown,
    IDeviationRule
} from '@goodt-common/data';
import { HttpTransportRequestCancel } from '@goodt-common/net';
import { DATASET_PROP } from '../consts.d.ts';
import { DatasetQueryFilterInfoStoreable } from '../models/query-filter';
import { CancelToken } from './utils';

interface IElemDatasetWatchStoreMixinInstance {
    queryParamsByRequest: WeakMap<Request, string[]>;
    watchStoreState: boolean;
    readonly $storeWatchHandlerVars: string[];
    readonly $storeWatchHandlerQueryParams: string[];

    $storeWatchHandler(filterParams: Record<string, any>);
    $storeApplyQueryFilters(filterParams: Record<string, any>): (Request | null)[];
    $queryInitParamsStoreFilters(newRequests: (Request | null)[], oldRequests?: (Request | null)[] = []);
    $queryUpdateParamsByRequest(newRequests: (Request | null)[], oldRequests?: (Request | null)[] = []);
    /**
     * Update this.descriptor.vars
     *
     * @param {WeakMap<import('@goodt-common/data').Request, string[]>} queryParamsByRequest
     */
    $storeUpdateDescriptorVars(queryParamsByRequest: WeakMap<Request, string[]>);
}

interface IElemDatasetDrilldownMixinInstance {
    readonly $drilldown: {
        state: Record<
            string,
            Drilldown
        >;
        canPopAny: boolean;
        canPushAny: boolean;
        setIndex(drilldownName, index: number): boolean;
        pop(drilldownName: string): boolean;
        push(drilldownName: string, value: any): boolean;
        getDimension(drilldownName: string): string;
        hasQueryFilter(drilldownName: string): boolean;
        canPop(drilldownName: string): boolean;
        canPush(drilldownName: string): boolean;
    };
    readonly drilldowns: string[];
}

interface IElemDatasetDeviationsMixinInstance {
    readonly deviations: {
        rows: Record<string, any>[];
        schema: { name: string }[];
    }
    //static
    DEVIATIONS_PROP: string;

    loadData(requests?: (Request | null)[] = this.requests): Promise<void>;
    loadDeviationsData(requests: (Request | null)[], refResult: IDatasetResult): Promise<(IDatasetResult|null)[]>;
    postprocessDeviationResults(results: (IDatasetResult|null)[], refResult: IDatasetResult): (IDatasetResult|null)[];
    createContext(rows: Record<string, any>[]): Record<string, () => number>
    calcDeviation(rule: IDeviationRule, context: Record<string, () => number>): Record<string, any>;
}

interface IElemDatasetBaseMixinInstance
    extends IElemDatasetWatchStoreMixinInstance,
        IElemDatasetDeviationsMixinInstance,
        IElemDatasetDrilldownMixinInstance {
    // hooks
    loadDataHooks: {
        readonly before?: (cancel?: CancelToken.cancel) => void;
        readonly then?: (r: IDatasetResult) => void;
        readonly catch?: (error: DataClientRequestError | HttpTransportRequestCancel | Error) => void;
        readonly finally?: () => void;
    };

    // static
    DATASET_PROP: string;

    // data
    requests: (Request | null)[];
    results: (IDatasetResult | null)[];
    isLoading: boolean;
    error: DataClientRequestError | Error | null;


    // computed
    readonly $placeholder: {
        show: boolean;
        toggle?: boolean;
        content?: string | ComponentOptions;
    };

    readonly hasDataset: boolean;
    readonly datasetRequests: (IDatasetRequestProps | null)[];
    readonly metrics: string[];
    readonly dimensions: string[];
    readonly fields: string[];

    loadData(requests?: (Request | null)[] = this.requests): Promise<void>;

    /**
     * @deprecated
     * @param requests
     */
    cancelRequests(requests?: (Request | null)[] = this.requests);

    $requestCancel(requests?: Request | null | (Request | null)[]);

    $requestChanged(requests: Request | null | (Request | null)[]);

    $queryGetParams(params: string[]): string[];

    $queryGetParamName(param: string): string | null;

    $queryHasFilter(param: string): boolean;

    $queryCreateStoreFilter(options: IDatasetQueryFilterInfo): DatasetQueryFilterInfoStoreable
}

export const ElemDatasetBaseMixinTypes: IElemDatasetBaseMixinInstance = undefined;

interface IElemDatasetMixinInstance extends IElemDatasetBaseMixinInstance {
    // data
    result: IDatasetResult | null;
    isLoading: boolean;

    // computed
    offset: number;
    page: number;
    readonly request: Request | null;
    readonly limit: number;
    readonly pages: number;
    readonly rowCount: number;

    // methods
    loadData(request?: Request | null | (Request | null)[] = this.request): Promise<void>;
}

export const ElemDatasetMixinTypes: IElemDatasetMixinInstance = undefined;

export function useElemDatasetBaseMixin({
    prop = DATASET_PROP,
    panel = {},
    drilldown = false,
    deviations = false,
    fetchEvent = { methodName: 'loadData' }
}?: {
    prop?: string;
    panel?: IDatasetPanelOptions | false;
    drilldown?: boolean;
    deviations?: boolean;
    fetchEvent?: { methodName?: string };
}): ComponentOptions;

export function useElemDatasetMixin({
    prop = DATASET_PROP,
    panel = {},
    drilldown = false,
    deviations = false,
    fetchEvent = { methodName: 'loadData' }
}?: {
    prop?: string;
    panel?: IDatasetPanelOptions | false;
    drilldown?: boolean;
    deviations?: boolean;
    fetchEvent?: { methodName?: string };
}): ComponentOptions;

export interface IPanelDatasetWatchStoreMixinInstance {
    $queryParams: string[];

    $queryUpdateParams(newQueryModels: QueryModel[], oldQueryModels: QueryModel[]): void;

    $storeUpdateDescriptorVars(addedParams: string[], deletedParams: string[]);

    $storeUpdateVarAliases(deletedParams: string[]): void;
}

export interface IPanelDatasetMixinInstance {
    readonly datasetRequests: (IDatasetRequestProps | null)[];
    queryModels: (QueryModel | null)[];
    readonly queryModel: QueryModel | null;
    readonly dimensionsMetrics: string[];
    readonly metrics: string[];
    readonly dimensions: string[];
    readonly fields: string[];
    readonly drilldowns: string[];
    readonly deviations: string[];
    readonly $drilldown: {
        dimensions: string[],
        getDimensions(drilldownName: string): string[]
    };

    // static
    DATASET_PROP: string;
    DEVIATIONS_PROP: string;

    buildOptions(
        items: string[],
        { empty = false } = {}
    ): {
        label: string;
        value: any;
    }[];
}

export const PanelDatasetMixinTypes: IPanelDatasetMixinInstance = undefined;

export function usePanelDatasetMixin({ prop = DATASET_PROP }?: { prop?: string }): ComponentOptions;
