import { ISafeResult } from '@goodt-common/utils';
import { BaseApiService } from '@goodt-common/api';
import {
    IAdapter,
    IAdapterManager,
    IConnection,
    IDataset,
    IDatasetEntity,
    IDatasetEntityTemplate,
    IDatasetEntityTemplateFolder,
    IDatasetEntityTemplateProject,
    IDatasetFolder,
    IDatasetMaterialization,
    IDatasetMeta,
    IDatasetResultExtended,
    IFolderChildCount,
    IExternalSourceSchemaSchemaResult,
    IExternalSourceTableSchemaResult,
    IExternalSourceTableFieldSchemaResult,
    IDatasetMaterializationPlannerSchedule,
    IDatasetVariable,
    IDatasetResult,
    IDatasetQuery
} from '../types';

export const DatasetType: {
    DATASET: 1;
    REST: 2;
} = {
    DATASET: 1,
    REST: 2
};

export const DatasetEntityType: {
    METRIC: 1;
    DIMENSION: 2;
} = {
    METRIC: 1,
    DIMENSION: 2
};

export const MaterializationType: {
    DEFAULT: 1;
} = {
    DEFAULT: 1
};

export const MaterializationStatus: {
    INPROGRESS: 'INPROGRESS';
    COMPLETED: 'COMPLETED';
    FAILED: 'FAILED';
} = {
    INPROGRESS: 'INPROGRESS',
    COMPLETED: 'COMPLETED',
    FAILED: 'FAILED'
};

export const MaterializationPlannerCronType: {
    RAW: 1;
    INTERVAL: 2;
    TIMESTAMP: 3;
} = {
    RAW: 1,
    INTERVAL: 2,
    TIMESTAMP: 3
};

/**
 * @param {IDatasetEntityTemplateProject|IDatasetEntityTemplate} entity
 * @param {number} type
 * @return {boolean}
 */
export function compareEntityType(
    entity: IDatasetEntityTemplateProject | IDatasetEntityTemplate,
    type: number
): boolean;

/**
 * DataClientService class
 */
export class DataClientService extends BaseApiService {
    /**
     * @param {{ url:string }} options
     * @return {DataClientService}
     */
    context({ url }: { url: string }): DataClientService;

    readonly adapter: {
        getAll(): Promise<ISafeResult<IAdapter[]>>;
    };

    readonly adapterManager: {
        getAll(): Promise<ISafeResult<IAdapterManager[]>>;
    };

    readonly connection: {
        getAll(): Promise<ISafeResult<IConnection[]>>;
        get(id: IConnection['id']): Promise<ISafeResult<IConnection>>;
        create(connection: IConnection): Promise<ISafeResult<IConnection>>;
        update(connection: IConnection): Promise<ISafeResult<IConnection>>;
        delete(id: IConnection['id']): Promise<ISafeResult>;
        clone(id: IConnection['id']): Promise<ISafeResult<IConnection>>;
        restore(id: IConnection['id']): Promise<ISafeResult<IConnection>>;
        codeExists({
            code,
            excludeId
        }: {
            code: string;
            excludeId: IConnection['id'] | null;
        }): Promise<ISafeResult<IConnection>>;
        changeOwner({ id, ownerGroupId }: { id: string | number; ownerGroupId: string | number }): Promise<ISafeResult>;
    };

    readonly dataset: {
        getByCode({ code }: { code: IDatasetMeta['code'] }): Promise<ISafeResult<IDataset>>;
        get({ id }: { id: IDatasetMeta['id'] }): Promise<ISafeResult<IDataset>>;
        upload({
            name,
            file,
            folderId,
            config,
            onUploadProgress
        }: {
            name: IDatasetFolder['name'];
            file: File;
            folderId: IDatasetFolder['id'];
            config: object;
            onUploadProgress: (event: ProgressEvent) => void;
        }): Promise<ISafeResult<IDataset>>;
        clone({
            id,
            name,
            folderId
        }: {
            id: IDataset['id'];
            name: IDataset['name'];
            folderId: IDataset['folderId'];
        }): Promise<ISafeResult<IDataset>>;
        create(dataset: IDataset): Promise<ISafeResult<IDataset>>;
        update(dataset: IDataset): Promise<ISafeResult<IDataset>>;
        delete(id: string | number): Promise<ISafeResult>;
        preview({
            dataset,
            metrics = [],
            dimensions = [],
            variables = [],
            order = [],
            limit,
            offset
        }: {
            dataset: IDataset;
            metrics: Pick<IDatasetEntity, 'name' | 'definition'>[];
            dimensions: Pick<IDatasetEntity, 'name' | 'definition'>[];
            variables: Pick<IDatasetVariable, 'name' | 'defaultValue' | 'typeId' | 'isNullable'>[];
            order: IDatasetQuery['$order'];
            limit: IDatasetResult['limit'];
            offset: IDatasetResult['offset'];
        }): Promise<ISafeResult<IDatasetResultExtended>>;
        codeExists({
            code,
            excludeId
        }: {
            code: IDataset['code'];
            excludeId: IDataset['id'];
        }): Promise<ISafeResult<boolean>>;
        changeOwner({ id, ownerGroupId }: { id: string | number; ownerGroupId: string | number }): Promise<ISafeResult>;
    };

    readonly datasetMeta: {
        get({ id }: { id: IDatasetMeta['id'] }): Promise<ISafeResult<IDatasetMeta>>;
        getAll({ folderId }: { folderId: string }): Promise<ISafeResult<IDatasetMeta[]>>;
        search({
            query,
            templateId
        }: {
            query: string;
            templateId: IDatasetEntity['templateId'];
        }): Promise<ISafeResult<IDatasetMeta[]>>;
        countChildren({ folderIds }: { folderIds: IDataset['folderId'][] }): Promise<ISafeResult<IFolderChildCount[]>>;
    };

    readonly datasetFolder: {
        getAll({
            parentFolderId
        }?: {
            parentFolderId: IDatasetFolder['parentId'] | null;
        }): Promise<ISafeResult<IDatasetFolder[]>>;
        get({ id }: { id: IDatasetFolder['id'] }): Promise<ISafeResult<IDatasetFolder>>;
        create(folder: IDatasetFolder): Promise<ISafeResult<IDatasetFolder>>;
        update(folder: IDatasetFolder): Promise<ISafeResult<IDatasetFolder>>;
        delete({ id }: { id: IDatasetFolder['id'] }): Promise<ISafeResult<IDatasetFolder>>;
        countChildren({
            parentIds
        }: {
            parentIds: IDatasetFolder['parentId'][];
        }): Promise<ISafeResult<IFolderChildCount[]>>;
        codeExists({
            code,
            excludeId
        }: {
            code: IDatasetFolder['code'];
            excludeId: IDatasetFolder['id'] | null;
        }): Promise<ISafeResult<boolean>>;
        changeOwner({ id, ownerGroupId }: { id: string | number; ownerGroupId: string | number }): Promise<ISafeResult>;
    };

    readonly datasetEntity: {
        getAll({ datasetId }: { datasetId: IDatasetEntity['datasetId'] }): Promise<ISafeResult<IDatasetEntity[]>>;
        batchUpdate({
            datasetId,
            metrics,
            dimensions
        }: {
            datasetId: IDatasetEntity['datasetId'];
            metrics: Partial<IDatasetEntity>[];
            dimensions: Partial<IDatasetEntity>[];
        }): Promise<{ metrics: IDatasetEntity[]; dimensions: IDatasetEntity[] }>;
        codeExists({
            code,
            excludeId
        }: {
            code: IDatasetEntity['code'];
            excludeId: IDatasetEntity['id'] | null;
        }): Promise<ISafeResult<boolean>>;
    };

    readonly variable: {
        getAll({ datasetId }: { datasetId: IDatasetVariable['datasetId'] }): Promise<ISafeResult<IDatasetVariable[]>>;
        batchUpdate({
            datasetId,
            variables
        }: {
            datasetId: IDatasetVariable['datasetId'];
            variables: Partial<IDatasetVariable>[];
        }): Promise<ISafeResult<IDatasetVariable[]>>;
    };

    readonly datasetEntityTemplate: {
        getAll({
            folderId
        }?: {
            folderId?: IDatasetEntityTemplate['folderId'] | null;
        }): Promise<ISafeResult<IDatasetEntityTemplate[]>>;
        get({ id }: { id: string }): Promise<ISafeResult<IDatasetEntityTemplate>>;
        clone({
            id,
            name,
            folderId
        }: {
            id: IDatasetEntityTemplate['id'];
            name: IDatasetEntityTemplate['name'];
            folderId: IDatasetEntityTemplate['folderId'];
        }): Promise<ISafeResult<IDatasetEntityTemplate>>;
        create(entityTemplate: IDatasetEntityTemplate): Promise<ISafeResult<IDatasetEntityTemplate>>;
        update(entityTemplate: IDatasetEntityTemplate): Promise<ISafeResult<IDatasetEntityTemplate>>;
        delete({ id }: { id: IDatasetEntityTemplate['id'] }): Promise<ISafeResult<IDatasetEntityTemplate>>;
        search({ query }: { query: string }): Promise<ISafeResult<IDatasetEntityTemplate[]>>;
        countChildren({
            folderIds
        }: {
            folderIds: IDatasetEntityTemplate['folderId'][];
        }): Promise<ISafeResult<IFolderChildCount[]>>;
        codeExists({
            code,
            excludeId
        }: {
            code: IDatasetEntityTemplate['code'];
            excludeId: IDatasetEntityTemplate['id'] | null;
        }): Promise<ISafeResult<boolean>>;
        changeOwner({ id, ownerGroupId }: { id: string | number; ownerGroupId: string | number }): Promise<ISafeResult>;
    };

    readonly datasetEntityTemplateFolder: {
        getAll({
            parentFolderId
        }?: {
            parentFolderId?: IDatasetEntityTemplateFolder['parentId'] | null;
        }): Promise<ISafeResult<IDatasetEntityTemplateFolder[]>>;
        get({ id }: { id: IDatasetEntityTemplateFolder['id'] }): Promise<ISafeResult<IDatasetEntityTemplateFolder>>;
        create(folder: IDatasetEntityTemplateFolder): Promise<ISafeResult<IDatasetEntityTemplateFolder>>;
        update(folder: IDatasetEntityTemplateFolder): Promise<ISafeResult<IDatasetEntityTemplateFolder>>;
        delete({ id }: { id: IDatasetEntityTemplateFolder['id'] }): Promise<ISafeResult<IDatasetEntityTemplateFolder>>;
        countChildren({
            parentIds
        }: {
            parentIds: IDatasetEntityTemplateFolder['parentId'][];
        }): Promise<ISafeResult<IFolderChildCount[]>>;
        codeExists({
            code,
            excludeId
        }: {
            code: IDatasetEntityTemplateFolder['code'];
            excludeId: IDatasetEntityTemplateFolder['id'] | null;
        }): Promise<ISafeResult<boolean>>;
        changeOwner({ id, ownerGroupId }: { id: string | number; ownerGroupId: string | number }): Promise<ISafeResult>;
    };

    readonly datasetEntityProject: {
        getAll(): Promise<ISafeResult<IDatasetEntityTemplateProject[]>>;
    };

    readonly externalSource: {
        getTableSchema({
            connectionId,
            schema = []
        }: {
            connectionId: IConnection['id'];
            schema?: string[];
        }): Promise<ISafeResult<IExternalSourceSchemaSchemaResult & IExternalSourceTableSchemaResult>>;
        getFieldSchema({
            connectionId,
            path = []
        }: {
            connectionId: IConnection['id'];
            path?: string[];
        }): Promise<ISafeResult<IExternalSourceTableFieldSchemaResult>>;
    };

    readonly materialization: {
        getAll({
            datasetId
        }: {
            datasetId: IDatasetMaterialization['datasetId'];
        }): Promise<ISafeResult<IDatasetMaterialization[]>>;
        create(materialization: IDatasetMaterialization): Promise<ISafeResult<IDatasetMaterialization>>;
        update(materialization: IDatasetMaterialization): Promise<ISafeResult<IDatasetMaterialization>>;
        delete({ id }: { id: IDatasetMaterialization['id'] }): Promise<ISafeResult<IDatasetMaterialization>>;
    };

    readonly materializationPlanner: {
        getSchedule({
            materializationId
        }: {
            materializationId: IDatasetMaterialization['id'];
        }): Promise<ISafeResult<IDatasetMaterializationPlannerSchedule[]>>;

        updateSchedule({
            materializationId,
            schedule
        }: {
            materializationId: IDatasetMaterialization['id'];
            schedule: IDatasetMaterializationPlannerSchedule[];
        }): Promise<ISafeResult<IDatasetMaterializationPlannerSchedule[]>>;

        refresh({
            materializationId
        }: {
            materializationId: IDatasetMaterialization['id'];
        }): Promise<ISafeResult<IDatasetMaterializationPlannerSchedule[]>>;
    };
}

export function createDataClientService({
    client,
    options,
    transport
}?: {
    client: ApiHttpClient;
    options: IApiServiceOptions;
    transport: ITransport;
}): DataClientService;
