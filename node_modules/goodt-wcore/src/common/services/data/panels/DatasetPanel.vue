<template>
    <w-panel>
        <ui-panel-container>
            <div class="dataset-grid">
                <div v-if="canAddDataset" class="dataset-grid__head">
                    <ui-button @click="onDatasetCreate">Настроить источник данных</ui-button>
                    <ui-button type="ghost" icon class="color-grey" @click="isDatasetImportShown = true">
                        <div class="icon">
                            <i class="mdi mdi-18px mdi-database-import" />
                        </div>
                    </ui-button>
                </div>

                <div v-for="(dataset, i) in datasetRequests" :key="i" class="dataset-grid__item">
                    <ui-button type="ghost" icon class="color-grey" @click="onDatasetRequestPropsCopy(dataset)">
                        <div class="icon">
                            <i class="mdi mdi-18px mdi-content-copy" />
                        </div>
                    </ui-button>
                    <ui-button
                        type="secondary"
                        :title="getDatasetName(dataset)"
                        class="text-truncate color-primary"
                        @click="onDatasetEdit(dataset, i)">
                        <div class="icon mar-right-2">
                            <i class="mdi mdi-18px mdi-database" />
                        </div>
                        <div class="text-truncate text-left text-sm flex-grow">
                            {{ getDatasetName(dataset) }}
                        </div>
                    </ui-button>
                    <ui-button type="ghost" icon class="color-grey" @click="onDatasetDelete(i)">
                        <div class="icon">
                            <i class="mdi mdi-18px mdi-delete-outline" />
                        </div>
                    </ui-button>
                </div>
            </div>

            <ui-dataset-editor
                v-if="isDatasetEditorShown"
                v-bind="{ dataset: editDataset, dataProviders, dataProviderDefaultId }"
                :show="isDatasetEditorShown"
                :dataset="editDataset"
                @close="onDatasetEditorClose"
                @save="onDatasetEditorSave" />

            <ui-dataset-import-popup
                :show="isDatasetImportShown"
                @close="isDatasetImportShown = false"
                @import="onDatasetImport" />
        </ui-panel-container>

        <ui-portal>
            <transition name="toast" appear>
                <div
                    v-if="toast.isActive"
                    class="toast pos-fixed pos-bot-center mar-bot-l5"
                    :class="toast.type"
                >{{ toast.text }}
                </div>
            </transition>
        </ui-portal>
    </w-panel>
</template>
<script>
import { Panel } from '@goodt-wcore/core';
import { Portal as UiPortal, UiButton } from '@goodt-wcore/components';
import { ProjectDataProviderRepository } from '@goodt-common/dremio';
// eslint-disable-next-line import/named
import { PanelDatasetMixin } from '../mixins/PanelDatasetMixin';
import { DatasetWatchStoreMixin } from './mixins/DatasetWatchStoreMixin';
import PropChangeContextMixin from './mixins/PropChangeContextMixin';
import { DATASET_PROP } from '../consts';
import UiDatasetEditor from './components/DatasetEditor.vue';
import UiDatasetImportPopup from './components/DatasetImportPopup.vue';
import { ToastMessage } from './const';

export default {
    extends: Panel,
    components: { UiPortal, UiDatasetEditor, UiDatasetImportPopup, UiButton },
    mixins: [PanelDatasetMixin, DatasetWatchStoreMixin, PropChangeContextMixin],

    inject: {
        $shared: {
            default: null
        }
    },
    meta: { name: 'Источник', icon: 'database' },

    static: {
        DATASET_PROP,
        toastOptions: {
            delay: 3000
        }
    },
    provide() {
        const { showToast: $showToast } = this;
        return {
            $showToast
        };
    },
    props: {
        isMultiple: {
            type: Boolean,
            default: false
        }
    },
    data: () => ({
        isDatasetEditorShown: false,
        isDatasetImportShown: false,
        /** @type {import('../types').IDatasetRequestProps} */
        editDataset: null,
        editDatasetIndex: -1,
        toast: {
            id: null,
            isActive: false,
            text: ''
        }
    }),
    computed: {
        datasetRequests: {
            /**
             * @return {import('../types').IDatasetRequestProps[]}
             */
            get() {
                return this.props[this.DATASET_PROP] ?? [];
            },
            /**
             * @param {import('../types').IDatasetRequestProps[]} val
             */
            set(val) {
                this.props[this.DATASET_PROP] = val;
            }
        },
        dataProviders() {
            return ProjectDataProviderRepository.get();
        },
        dataProviderDefaultId() {
            const dataProvider = ProjectDataProviderRepository.getDefault();
            return dataProvider?.id ?? null;
        },
        canAddDataset() {
            const { isMultiple, datasetRequests } = this;
            return isMultiple ? true : datasetRequests.length < 1;
        }
    },
    methods: {
        saveDatasets(datasetRequests, datasetRequestsOld) {
            // from DatasetPanelChangeNotifyMixin
            const context = this.onDatasetRequestsChanged(datasetRequests, datasetRequestsOld);
            this.propChanged(this.DATASET_PROP, context);
        },
        /**
         * @param {import('../types').IDatasetRequestProps} dataset
         * @return {string}
         */
        getDatasetName(dataset) {
            return dataset.name;
        },
        onDatasetEditorClose() {
            this.isDatasetEditorShown = false;
            this.editDataset = null;
            this.editDatasetIndex = -1;
        },
        /**
         * @param {import('../types').IDatasetRequestProps} datasetRequest
         */
        onDatasetEditorSave(datasetRequest) {
            const { datasetRequests, editDatasetIndex } = this;
            if (editDatasetIndex >= 0) {
                const datasetRequestsMutable = [...datasetRequests];
                datasetRequestsMutable.splice(editDatasetIndex, 1, datasetRequest);
                // reassign is mandatory instead of array mutation (splice) for watcher
                this.datasetRequests = datasetRequestsMutable;
            } else {
                // reassign is mandatory instead of array mutation (push) for watcher
                this.datasetRequests = [...datasetRequests, datasetRequest];
            }
            this.saveDatasets(this.datasetRequests, datasetRequests);
            this.isDatasetEditorShown = false;
        },
        //
        onDatasetCreate() {
            this.editDataset = null;
            this.editDatasetIndex = -1;
            this.isDatasetEditorShown = true;
        },
        /**
         * @param {import('../types').IDatasetRequestProps} datasetRequest
         * @param {number} index
         */
        onDatasetEdit(datasetRequest, index) {
            this.editDataset = datasetRequest;
            this.editDatasetIndex = index;
            this.isDatasetEditorShown = true;
        },
        /**
         * @param {number} index
         */
        onDatasetDelete(index) {
            const { datasetRequests } = this;
            const datasetRequestsMutable = [...datasetRequests];
            datasetRequestsMutable.splice(index, 1);
            // reassign is mandatory instead of array mutation for watcher
            this.datasetRequests = datasetRequestsMutable;
            this.saveDatasets(this.datasetRequests, datasetRequests);
        },
        /**
         * @param {import('../types').IDatasetRequestProps} datasetRequest
         */
        onDatasetImport(datasetRequest) {
            const { datasetRequests } = this;
            // reassign is mandatory instead of array mutation (push) for watcher
            this.datasetRequests = [...datasetRequests, datasetRequest];
            this.saveDatasets(this.datasetRequests, datasetRequests);
            this.isDatasetImportShown = false;
            this.showToast({ text: ToastMessage.IMPORTED_SUCCESSFULLY() });
        },
        /**
         * @param {import('../types').IDatasetRequestProps} datasetRequest
         */
        onDatasetRequestPropsCopy(datasetRequest) {
            try {
                this.$shared.clipboard(datasetRequest);
            } catch {
                window.navigator.clipboard.writeText(JSON.stringify(datasetRequest, null, 2));
                this.showToast({ text: ToastMessage.COPIED_TO_CLIPBOARD() });
            }
        },
        /**
         * @param {{ text:string }} options
         */
        showToast({ text, type = '' }) {
            const { delay } = this.toastOptions;
            const { toast } = this;

            if (toast.id) {
                clearTimeout(toast.id);
            }
            toast.id = setTimeout(() => {
                toast.isActive = false;
            }, delay);
            toast.text = text;
            toast.type = type;
            toast.isActive = true;
        }
    }
};
</script>
<style lang="pcss" scoped>
@b dataset-grid {
    display: grid;
    gap: 1rem;
    @e item {
        display: grid;
        grid-template-columns: auto 1fr auto;
        gap: 0.5rem;
    }
    @e head {
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 0.5rem;
    }
}
.toast {
    z-index: 10000;

    &-enter-active,
    &-leave-active {
        transition: opacity 0.2s ease;
    }

    &-enter,
    &-leave-to {
        opacity: 0;
    }

    &.error {
        background-color: var(--color-red);
        color: white;
    }
}
</style>
