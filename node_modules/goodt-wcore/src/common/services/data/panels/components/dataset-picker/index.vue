<template>
    <ui-grid-layout>
        <template #left>
            <div class="aside pad-top-l1">
                <ul class="tabs tabs-grow text-center">
                    <li :class="{ active: view === currentView }" v-for="{ label, view } in viewOptions" :key="view">
                        <a href="#" @click.prevent="setView(view)">{{ label }}</a>
                    </li>
                </ul>

                <div class="pad-l1">
                    <template v-if="currentView === View.DATASET">
                        <ui-search-input
                            v-model="datasets.searchByQuery.query"
                            placeholder="Поиск по названию"></ui-search-input>
                    </template>
                    <template v-if="currentView === View.LIBRARY">
                        <ui-search-input
                            v-model="entityTemplate.search.query"
                            placeholder="Поиск по названию"></ui-search-input>
                    </template>
                </div>

                <div class="flex-grow scroll-y h-0">
                    <template v-if="currentView === View.DATASET">
                        <ui-dataset-folder-tree
                            v-bind="{
                                selectedId: folder.selectedId,
                                selectNode: setDatasetFolderSelected,
                                getNodes: fetchDatasetFolders,
                                key: `folder-tree-${dataProviderId}`
                            }"></ui-dataset-folder-tree>
                    </template>

                    <template v-if="currentView === View.LIBRARY">
                        <template v-if="entityTemplate.search.isActive">
                            <div class="pad-h-l1" v-if="entityTemplate.search.isLoading">
                                <div class="preloader"></div>
                            </div>
                            <div class="pad-h-l1" v-else-if="entityTemplate.search.data.length === 0">
                                По запросу
                                <em class="color-primary">{{ entityTemplate.search.query }}</em>
                                ничего не найдено
                                <br />
                                <br />
                                <span class="link" @click="resetEntityTemplateSearch">Сбросить поиск</span>
                            </div>
                            <ui-entity-template
                                v-for="entity in entityTemplate.search.data"
                                v-bind="{
                                    entity,
                                    selectedEntityId: entityTemplate.selectedId,
                                    selectEntity: setEntityTemplateSelected,
                                    key: entity.id
                                }"></ui-entity-template>
                        </template>
                        <template v-else>
                            <ui-project-list
                                v-bind="{
                                    selectedEntityId: entityTemplate.selectedId,
                                    selectEntity: setEntityTemplateSelected,
                                    getEntities: fetchEntityTemplates,
                                    getFolders: fetchEntityTemplateFolders,
                                    getProjects: fetchEntityProjects,
                                    key: `project-list-${dataProviderId}`
                                }"></ui-project-list>
                        </template>
                    </template>
                </div>
            </div>
        </template>

        <template #center>
            <div class="content-grid">
                <div class="preloader" v-if="areDatasetResultsLoading"></div>
                <template v-else>
                    <template v-if="datasetsSeach.isActive">
                        <div class="p">
                            <template v-if="datasetsSeach.data.length">
                                Результаты поиска
                                <em class="color-primary">{{ datasetsSeach.query }}</em>
                            </template>
                            <template v-else>
                                По запросу
                                <em class="color-primary">{{ datasetsSeach.query }}</em>
                                ничего не найдено
                                <br />
                                <br />
                                <span class="link" @click="resetDatasetsSearchByQuery">Сбросить поиск</span>
                            </template>
                        </div>
                    </template>
                    <ui-dataset-tiles-header v-if="datasetsResults.length"></ui-dataset-tiles-header>
                    <ui-dataset-tile
                        v-for="{ dataset, metrics, dimensions } in datasetsResults"
                        :key="dataset.id"
                        v-bind="{
                            dataset,
                            metrics,
                            dimensions,
                            selectedId: datasets.selected.id
                        }"
                        @click.native="setDatasetSelected({ dataset, metrics, dimensions })"></ui-dataset-tile>
                </template>
            </div>
        </template>

        <template #right>
            <ui-dataset-card
                v-bind="{
                    meta: datasets.selected.meta,
                    isLoading: datasets.selected.isLoading
                }"
                @select="confirmDatasetSelected"
                v-if="datasets.selected.id"></ui-dataset-card>
        </template>
    </ui-grid-layout>
</template>
<script>
import UiGridLayout from '../shared/GridLayout.vue';
import UiDatasetFolderTree from './dataset/FolderTree.vue';
import UiDatasetCard from './dataset/DatasetCard.vue';
import UiDatasetTile from './dataset/DatasetTile.vue';
import UiDatasetTilesHeader from './dataset/DatasetTilesHeader.vue';
import UiProjectList from './library/ProjectList.vue';
import UiEntityTemplate from './library/EntityTemplateNode.vue';
import UiSearchInput from '../shared/SearchInput.vue';

/**
 * @typedef {import('../../../types').IDataset} IDataset
 * @typedef {import('../../../types').IDatasetMeta} IDatasetMeta
 * @typedef {import('../../../types').IDatasetFolder} IDatasetFolder
 * @typedef {import('../../../types').IDatasetFieldSchema} IDatasetFieldSchema
 * @typedef {import('../../../types').IDatasetEntity} IDatasetEntity
 * @typedef {import('../../../types').IDatasetEntityTemplate} IDatasetEntityTemplate
 * @typedef {import('../../../types').IDatasetEntityTemplateProject} IDatasetEntityTemplateProject
 * @typedef {import('../../../types').IDatasetEntityTemplateFolder} IDatasetEntityTemplateFolder
 * @typedef {import('../../../service').DataClientService} DataClientService
 */
const View = {
    DATASET: 'dataset',
    LIBRARY: 'library'
};

export default {
    components: {
        UiGridLayout,
        UiDatasetFolderTree,
        UiDatasetCard,
        UiDatasetTile,
        UiDatasetTilesHeader,
        UiProjectList,
        UiEntityTemplate,
        UiSearchInput
    },
    inject: ['$handleError', '$service'],
    props: {
        dataProviderId: {
            type: [String, Number],
            default: null
        },
        dataProviderUrl: {
            type: String,
            default: ''
        }
    },
    static: {
        View,
        viewOptions: [
            { label: 'Датасеты', view: View.DATASET },
            { label: 'Библиотека', view: View.LIBRARY }
        ]
    },
    data() {
        return {
            currentView: View.DATASET,
            datasets: {
                data: [],
                isLoading: false,
                selected: {
                    id: null,
                    /** @type {IDatasetMeta} */
                    meta: null,
                    isLoading: false
                },
                searchByQuery: {
                    isActive: false,
                    isLoading: false,
                    data: [],
                    query: '',
                    minLength: 2
                }
            },
            folder: {
                selectedId: null
            },
            entityTemplate: {
                selectedId: null,
                search: {
                    isActive: false,
                    isLoading: false,
                    data: [],
                    query: '',
                    minLength: 2
                }
            }
        };
    },
    computed: {
        areDatasetResultsLoading() {
            const { datasets } = this;
            return datasets.isLoading || datasets.searchByQuery.isLoading;
        },
        datasetsResults() {
            const { datasets, currentView } = this;
            const { searchByQuery } = datasets;
            if (currentView === View.DATASET && searchByQuery.isActive) {
                return searchByQuery.data;
            }
            return datasets.data;
        },
        datasetsSeach() {
            const { datasets, currentView } = this;
            if (currentView === View.LIBRARY) {
                return {
                    isLoading: false,
                    isActive: false,
                    data: []
                };
            }
            const { isLoading, isActive, data, query } = datasets.searchByQuery;
            return {
                isLoading,
                isActive,
                data,
                query
            };
        }
    },
    watch: {
        dataProviderId() {
            const { datasets, folder, entityTemplate } = this;
            datasets.data = [];
            datasets.selected.id = null;
            datasets.meta = null;
            folder.selectedId = null;
            entityTemplate.selectedId = null;
            this.$handleError();
        },
        ['datasets.searchByQuery.query']() {
            this.handleDatasetSearchByQuery();
        },
        ['entityTemplate.search.query']() {
            this.handleEntityTemplateSearch();
        }
    },
    methods: {
        /**
         * @return {DataClientService}
         */
        getService() {
            /** @type {{ $service:DataClientService }} */
            const { $service, dataProviderUrl: url } = this;
            return $service.context({ url });
        },
        /**
         * @param {string} view
         */
        setView(view) {
            this.currentView = view;
        },
        /**
         * @emits 'select'
         */
        confirmDatasetSelected() {
            const { meta } = this.datasets.selected;
            this.$emit('select', meta);
        },
        /**
         * @param {string|number} id
         */
        async setDatasetFolderSelected(id) {
            const { folder, datasets } = this;
            // reset search
            this.resetDatasetsSearchByQuery();

            if (folder.selectedId === id) {
                return;
            }

            folder.selectedId = id;
            datasets.selected.id = null;
            datasets.isLoading = true;
            datasets.data = await this.fetchDatasets(id);
            datasets.isLoading = false;
        },
        async setDatasetSelected({ dataset, metrics, dimensions }) {
            const { selected } = this.datasets;
            if (selected.id === dataset.id) {
                return;
            }
            selected.id = dataset.id;
            selected.meta = { dataset, metrics, dimensions };
        },
        async setEntityTemplateSelected({ id }) {
            const { entityTemplate, datasets } = this;
            if (entityTemplate.selectedId === id) {
                return;
            }
            entityTemplate.selectedId = id;
            datasets.isLoading = true;
            datasets.data = await this.searchDatasetsByQuery({ templateId: id });
            datasets.isLoading = false;
        },
        async handleDatasetSearchByQuery() {
            const { searchByQuery } = this.datasets;
            const { query, minLength } = searchByQuery;
            searchByQuery.isActive = query.length >= minLength;

            if (query.length === 0) {
                searchByQuery.data = [];
                return;
            }
            if (!searchByQuery.isActive) {
                return;
            }
            searchByQuery.isLoading = true;
            searchByQuery.data = [];
            searchByQuery.data = await this.searchDatasetsByQuery({ query });
            searchByQuery.isLoading = false;
        },
        async handleEntityTemplateSearch() {
            const {
                entityTemplate: { search }
            } = this;
            const { query, minLength } = search;
            search.isActive = query.length >= minLength;

            if (query.length === 0) {
                search.results = [];
                return;
            }
            if (!search.isActive) {
                return;
            }
            search.isLoading = true;
            search.data = [];
            search.data = await this.searchEntityTemplatesByQuery(query);
            search.isLoading = false;
        },
        resetDatasetsSearchByQuery() {
            const {
                datasets: { searchByQuery }
            } = this;
            searchByQuery.isActive = false;
            searchByQuery.isLoading = false;
            searchByQuery.data = [];
            searchByQuery.query = '';
        },
        resetEntityTemplateSearch() {
            const { search } = this.entityTemplate;
            search.isActive = false;
            search.query = '';
            search.data = [];
        },

        // //////////////////////////////
        //
        // Data-related methods below
        //
        // //////////////////////////////

        /**
         * // @NOTE done
         * @param {string|number} parentFolderId
         * @return {Promise.<IDatasetFolder[]>}
         */
        async fetchDatasetFolders(parentFolderId) {
            const service = this.getService();
            const safeResult = await service.datasetFolder.getAll({ parentFolderId });
            if (safeResult.isError) {
                this.$handleError(safeResult.error);
                return [];
            }
            return safeResult.result;
        },
        /**
         * // @NOTE done
         * @param {string|number} datasetId
         * @return {Promise.<IDatasetFieldSchema[]>}
         */
        async fetchDatasetSchema(datasetId) {
            const service = this.getService();
            const safeResult = await service.dataset.getSchema({ datasetId });
            if (safeResult.isError) {
                this.$handleError(safeResult.error);
                return [];
            }
            return safeResult.result;
        },
        /**
         * // @NOTE done
         * @param {string|number} folderId
         * @return {Promise.<IDatasetMeta[]>}
         */
        async fetchDatasets(folderId) {
            const service = this.getService();
            const safeResult = await service.datasetMeta.getAll({ folderId });
            if (safeResult.isError) {
                this.$handleError(safeResult.error);
                return [];
            }
            return safeResult.result;
        },
        /**
         * // @NOTE done
         * @param {string|number} folderId
         * @return {Promise.<IDatasetEntityTemplate[]>}
         */
        async fetchEntityTemplates(folderId) {
            const service = this.getService();
            const safeResult = await service.datasetEntityTemplate.getAll({ folderId });
            if (safeResult.isError) {
                this.$handleError(safeResult.error);
                return [];
            }
            return safeResult.result;
        },
        /**
         * // @NOTE done
         * @return {Promise.<IDatasetEntityTemplateProject[]>}
         */
        async fetchEntityProjects() {
            const service = this.getService();
            const safeResult = await service.datasetEntityProject.getAll();
            if (safeResult.isError) {
                this.$handleError(safeResult.error);
                return [];
            }
            return safeResult.result;
        },
        /**
         * // @NOTE done
         * @param {string|number} parentFolderId
         * @return {Promise.<IDatasetEntityTemplateFolder[]>}
         */
        async fetchEntityTemplateFolders(parentFolderId) {
            const service = this.getService();
            const safeResult = await service.datasetEntityTemplateFolder.getAll({ parentFolderId });
            if (safeResult.isError) {
                this.$handleError(safeResult.error);
                return [];
            }
            return safeResult.result;
        },
        /**
         * // @NOTE done
         * @param {{ query?:string, templateId?:string|number }} options
         * @return {Promise.<IDatasetMeta[]>}
         */
        async searchDatasetsByQuery({ query = null, templateId = null }) {
            const service = this.getService();
            const safeResult = await service.datasetMeta.search({ query, templateId });
            if (safeResult.isError) {
                this.$handleError(safeResult.error);
                return [];
            }
            return safeResult.result;
        },
        /**
         * // @NOTE done
         * @param {string} query
         * @return {Promise.<IDatasetEntityTemplate[]>}
         */
        async searchEntityTemplatesByQuery(query) {
            const service = this.getService();
            const safeResult = await service.datasetEntityTemplate.search({ query });
            if (safeResult.isError) {
                this.$handleError(safeResult.error);
                return [];
            }
            return safeResult.result;
        }
    }
};
</script>
<style lang="less" scoped>
.aside {
    display: flex;
    flex-direction: column;
    width: 25rem;
    height: 100%;
}
.content-grid {
    display: grid;
    gap: 0.5rem;
}
</style>
