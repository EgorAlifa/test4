<template>
    <ui-portal>
        <div class="layout" v-show="$root.isSandbox || currentView === View.EDIT">
            <div class="layout__header header pad-left-l1 pad-right-l4 pad-top-l1 pad-bot-l1 shadow">
                <div class="layout-controls text-truncate">
                    <template v-if="$root.isSandbox && currentView === View.PICK">
                        <h3 class="last">Выбор датасета</h3>
                    </template>
                    <template v-if="currentView === View.EDIT">
                        <ui-button
                            icon="arrow-left"
                            type="ghost-alt"
                            title="Выбор датасета"
                            @click="nextView"></ui-button>
                        <h3 :title="datasetPropsMutable.name" class="last text-truncate">
                            {{ datasetPropsMutable.name }}
                        </h3>
                        <ui-button
                            icon="table-edit"
                            type="ghost-alt"
                            class="color-green"
                            title="Редактирование датасета"
                            :disabled="errors.length > 0 || datasetQueryEditor.browseDataset === null"
                            @click="onBrowseDataset"></ui-button>
                    </template>
                </div>

                <ui-group>
                    <template v-if="currentView !== View.NO_DATA_PROVIDERS">
                        <span
                            class="badge badge-error text-xsmall cursor-pointer"
                            v-if="hasError"
                            @click="isErrorShown = !isErrorShown">
                            ошибка
                        </span>
                        <ui-select
                            class="layout-controls__dataproviders"
                            v-model="dataProviderId"
                            :options="dataProviderOptions"
                            @change="onDataProviderChange"></ui-select>
                    </template>
                    <ui-button type="secondary" @click="onClose">Отменить</ui-button>
                    <template v-if="currentView === View.EDIT">
                        <ui-button type="primary" :disabled="hasError || !isChanged" @click="onSave">
                            Сохранить
                        </ui-button>
                    </template>
                </ui-group>
            </div>

            <div class="layout__content bg-grey-lighter">
                <template v-if="$root.isSandbox && currentView === View.PICK">
                    <ui-dataset-picker
                        v-bind="{ dataProviderId, dataProviderUrl }"
                        @select="(meta) => onDatasetMetaSelect(meta, dataProviderId)"></ui-dataset-picker>
                </template>

                <template v-if="currentView === View.EDIT">
                    <ui-dataset-query-editor
                        v-bind="{ datasetProps: datasetPropsMutable, dataProviderUrl }"
                        @api="onDatasetQueryEditorApi"
                        @change="onDatasetPropsChanged"></ui-dataset-query-editor>
                </template>

                <template v-if="currentView === View.NO_DATA_PROVIDERS">
                    <div class="w-100 h-100 d-flex flex-center bg-white">
                        <div class="text-h2 text-muted">У вас нет ни одного провайдера данных.</div>
                    </div>
                </template>
            </div>

            <ui-popup :visible.sync="isErrorShown">
                <template #body>
                    <div class="debug-info">
                        <h3>Ошибка</h3>
                        <div
                            v-for="error in [...errors, ...datasetQueryEditor.errors]"
                            class="alert alert-error mar-bot-l1">
                            <div class="alert-body text-xsmall">{{ $t(error.message) }}</div>
                            <div class="pos-abs pos-bot-right mar-1">
                                <ui-button
                                    icon="content-copy"
                                    type="secondary"
                                    size="small"
                                    @click="writeToClipboard(error.toString())"></ui-button>
                            </div>
                        </div>
                    </div>
                </template>
                <template #footer>
                    <ui-group justify="end" class="w-100">
                        <ui-button type="secondary" @click="onClearError">Очистить</ui-button>
                        <ui-button type="primary" @click="isErrorShown = false">Закрыть</ui-button>
                    </ui-group>
                </template>
            </ui-popup>
        </div>
        <div
            v-if="!$root.isSandbox && [View.BROWSE, View.PICK].includes(currentView)"
            class="w-100 h-100 d-flex flex-center pos-abs pos-top">
            <ui-preloader size="large"></ui-preloader>
        </div>
    </ui-portal>
</template>
<script>
import { cloneDeep, isEqual, noop } from 'lodash';
import { Select as UiSelect } from 'goodteditor-ui';
import { DatasetManager } from '@goodt-wcore/managers';
import { useBrowserHistory } from '@goodt-wcore/utils';
import {
    createDataset as createDatasetRequestProps,
    DatasetQueryModelFactory,
    lang,
    DatasetEditorMessages
} from '@goodt-common/data';
import { MessageI18n } from '@goodt-common/utils';
import {
    Portal as UiPortal,
    Popup as UiPopup,
    UiIcon,
    UiButtonBase as UiButton,
    UiGroup,
    UiPreloader,
    UiShim
} from '@goodt-wcore/components';
import UiDatasetPicker from './dataset-picker/index.vue';
import UiDatasetQueryEditor from './dataset-editor/index.vue';
import { createDataClientService } from '../../services';
import { ToastMessage } from '../const';

/**
 * @typedef {import('@goodt-common/data').IDataset} IDataset
 * @typedef {import('@goodt-common/data').IDatasetMeta} IDatasetMeta
 * @typedef {import('@goodt-common/data').IDatasetFieldSchema} IDatasetFieldSchema
 * @typedef {import('@goodt-common/data').IDatasetRequestProps} IDatasetRequestProps
 * @typedef {import('@goodt-common/data').IProjectDataProvider} IProjectDataProvider
 * @typedef {import('@goodt-common/data').IProjectDataProviderConnector} IProjectDataProviderConnector
 * @typedef {import('@goodt-wcore/components').ISelectOption} ISelectOption
 */

const WIDGET_PANEL_NAME = 'DatasetPanel';

export default {
    components: {
        UiPortal,
        UiPopup,
        UiSelect,
        UiDatasetPicker,
        UiDatasetQueryEditor,
        UiIcon,
        UiButton,
        UiGroup,
        UiPreloader,
        UiShim
    },
    inject: ['$showToast', '$shared'],
    provide() {
        const $service = createDataClientService();
        const { handleError: $handleError, writeToClipboard: $writeToClipboard } = this;
        return {
            $service,
            $handleError,
            $writeToClipboard
        };
    },
    props: {
        show: {
            type: Boolean
        },
        /** @type {import('vue').PropOptions<IDatasetRequestProps>} */
        dataset: {
            type: Object,
            default: null
        },
        /** @type {import('vue').PropOptions<IProjectDataProvider[]>} */
        dataProviders: {
            type: Array,
            default: () => []
        },
        /** @type {import('vue').PropOptions<IProjectDataProvider['id']>} */
        dataProviderDefaultId: {
            type: [String, Number],
            default: null
        }
    },
    static: {
        popupOptions: {
            modal: false,
            fullscreen: true,
            usePadding: false,
            showCloseButton: false
        },
        View: {
            START: 'start',
            NO_DATA_PROVIDERS: 'noDataProviders',
            PICK: 'pick',
            BROWSE: 'browse',
            EDIT: 'edit',
            END: 'end'
        },
        disposals: []
    },
    data() {
        return {
            /** @type {IDatasetRequestProps} */
            datasetPropsMutable: null,
            /** @type {string|null} */
            currentView: null,
            /** @type {Error[]} */
            errors: [],
            isErrorShown: false,
            datasetQueryEditor: {
                browseDataset: null,
                errors: []
            }
        };
    },
    computed: {
        /**
         * @return {IProjectDataProviderConnector['id']}
         */
        connectorId() {
            const { dataProviderId, dataProviders } = this;
            /** @type {IProjectDataProvider} */
            const dataProvider = dataProviders.find(({ id }) => id === dataProviderId);
            return dataProvider?.connector?.id ?? null;
        },
        /**
         *
         * @return {IProjectDataProvider|null}
         */
        dataProvider() {
            /** @type {IProjectDataProvider} */
            const dataProvider = this.dataProviders.find(({ id }) => id === this.dataProviderId);
            return dataProvider ?? null;
        },
        /**
         * @return {IProjectDataProviderConnector['url']}
         */
        dataProviderUrl() {
            return this.dataProvider?.connector.url ?? null;
        },
        /**
         * @return {ISelectOption[]}
         */
        dataProviderOptions() {
            return this.dataProviders.map(({ id: value, name: label }) => ({ label, value }));
        },
        dataProviderId: {
            get() {
                return this.datasetPropsMutable?.dataProviderId;
            },
            set(val) {
                const { datasetPropsMutable } = this;
                if (datasetPropsMutable != null) {
                    datasetPropsMutable.dataProviderId = val;
                }
            }
        },
        /**
         * @return {boolean}
         */
        hasError() {
            return this.errors.length > 0 || this.datasetQueryEditor.errors.length > 0;
        },
        isChanged() {
            return !isEqual(
                createDatasetRequestProps(
                    this.dataset ?? {
                        dataProviderId: this.dataProviderDefaultId
                    }
                ),
                this.datasetPropsMutable
            );
        }
    },
    watch: {
        dataset: {
            handler(val) {
                const { dataProviderDefaultId } = this;
                /** @type {IDatasetRequestProps} */
                const datasetProps = createDatasetRequestProps(val == null ? {} : cloneDeep(val));
                datasetProps.dataProviderId = datasetProps?.dataProviderId ?? dataProviderDefaultId;
                this.setDatasetProps(datasetProps);
            },
            immediate: true
        },
        dataProvider: {
            handler(dataProvider) {
                if (dataProvider === null) {
                    this.handleError([new Error(DatasetEditorMessages.DATASET_DATAPROVIDER_NOT_EXISTS_IN_PROJECT)]);
                }
            },
            immediate: true
        }
    },
    created() {
        this.init();
    },
    mounted() {
        this.$shared?.toggleRouteView?.(false);
    },
    destroyed() {
        this.disposals.forEach((dispose) => dispose());
        this.$shared?.toggleRouteView?.(true);
    },
    methods: {
        init() {
            this.$i18n.mergeLocaleMessage('ru', lang.messages.ru);
            // @todo remove, move in editor's Application.js
            MessageI18n.handler = (...args) => this.$t(...args);
            this.initTransitions();
            this.initHistoryNavigationHandle();
        },
        initTransitions() {
            const { View, setView, nextView, dataProviderId, dataProvider, dataset, dataProviderDefaultId } = this;
            const viewTransition = {
                [View.START]: {
                    enter: noop,
                    next: () => {
                        if (dataProviderDefaultId == null) {
                            setView(View.NO_DATA_PROVIDERS);
                            return;
                        }
                        setView(dataset == null ? View.PICK : View.EDIT);
                    }
                },
                [View.NO_DATA_PROVIDERS]: {
                    enter: noop,
                    next: () => {
                        setView(View.START);
                    }
                },
                [View.BROWSE]: {
                    enter: async () => {
                        const { connectorId } = this;
                        await this.datasetQueryEditor.browseDataset({ connectorId });
                        nextView();
                    },
                    next: () => {
                        setView(View.EDIT);
                    }
                },
                [View.PICK]: {
                    enter: async () => {
                        if (this.$root.isSandbox) {
                            return;
                        }

                        const pickedDatasetData = await DatasetManager.instance.pick({
                            dataProviderId: dataProvider == null ? dataProviderDefaultId : dataProviderId
                        });

                        if (pickedDatasetData != null) {
                            const { dataProviderId, datasetMeta } = pickedDatasetData;
                            this.onDatasetMetaSelect(datasetMeta, dataProviderId);
                            return;
                        }

                        if (dataset != null) {
                            nextView();
                            return;
                        }

                        setView(View.END);
                    },
                    next: () => {
                        setView(View.EDIT);
                    }
                },
                [View.EDIT]: {
                    enter: () => {},
                    next: () => {
                        setView(View.PICK);
                    }
                },
                [View.END]: {
                    enter: () => {
                        this.onClose();
                    }
                }
            };
            this.viewTransition = viewTransition;
            this.setView(View.START);
            this.nextView();
        },
        initHistoryNavigationHandle() {
            const { View, } = this;

            const { pushState, replaceState, onPopState, forward, getCurrentState } = useBrowserHistory();
            // just replace state to ensure it is not null
            replaceState();
            if (getCurrentState()?.widgetPanel?.name !== WIDGET_PANEL_NAME) {
                pushState({
                    widgetPanel: { name: WIDGET_PANEL_NAME }
                });
            }
            const dispose = onPopState((_, { isForward }) => {
                const { currentView } = this;

                if (isForward) {
                    return;
                }
                if (currentView === View.EDIT) {
                    this.onClose();
                }
                if ([View.BROWSE, View.PICK].includes(currentView)) {
                    DatasetManager.instance.cancel();
                }
                forward();
            });

            this.disposals.push(() => {
                dispose();
            });
        },
        setView(currentView) {
            this.currentView = currentView;
            const view = this.viewTransition[currentView];
            view.enter();
        },
        nextView() {
            const { currentView, viewTransition } = this;
            const transition = viewTransition[currentView];
            transition.next();
        },
        /**
         * @param {IDatasetRequestProps} datasetProps
         */
        setDatasetProps(datasetProps) {
            this.datasetPropsMutable = datasetProps;
        },
        onDatasetQueryEditorApi(editorApi) {
            this.datasetQueryEditor = {
                ...this.datasetQueryEditor,
                ...editorApi
            };
        },
        onBrowseDataset() {
            this.setView(this.View.BROWSE);
        },
        onSave() {
            /** @type {{ datasetPropsMutable:IDatasetRequestProps }} */
            const { datasetPropsMutable } = this;
            this.$emit('save', datasetPropsMutable);
        },
        onClose() {
            if (this.isChanged && this.$shared) {
                return this.$shared
                    .confirm({
                        text: 'Вы уверены, что хотите выйти? Все несохраненные изменения будут потеряны'
                    })
                    .yes(() => {
                        this.$emit('close');
                    });
            }
            // sandbox back compatibility where there is no provided $shared
            this.$emit('close');
            return Promise.resolve(true);
        },
        handleError(errors = [], clear = true, source) {
            if (source === 'dataset-query-editor') {
                this.datasetQueryEditor.errors = errors;
                return;
            }

            if (clear) {
                this.errors = [];
            }
            errors = [errors].flat();
            this.errors = [...this.errors, ...errors];
            if (errors.length === 0) {
                return;
            }

            let text = ToastMessage.ERROR_OCCURED();
            const error = errors.pop();
            const humanReadable = this.$t(error.message);
            if (humanReadable !== error.message) {
                text = `${text}: ${humanReadable}`;
            }
            this.$showToast({ text, type: 'error' });
        },
        async writeToClipboard(any) {
            try {
                const str = typeof any !== 'string' ? JSON.stringify(any) : any;
                await navigator.clipboard.writeText(str);
                this.$showToast({ text: ToastMessage.COPIED_TO_CLIPBOARD() });
            } catch (error) {
                // error
            }
        },
        datasetMetaSelect(meta, dataProviderId) {
            const { schema } = meta.dataset;
            const datasetProps = createDatasetRequestProps({ name: meta.dataset.name, dataProviderId });

            const queryModel = DatasetQueryModelFactory(datasetProps.query);

            queryModel.from = meta.dataset.code;
            queryModel.fields = schema.fields.map(({ name }) => name);
            queryModel.dimensions = meta.dimensions.map(({ name }) => name);
            queryModel.metrics = meta.metrics.map(({ name }) => name);

            datasetProps.query = queryModel.raw;

            this.setDatasetProps(datasetProps);
        },
        /**
         * @param {IDatasetMeta} meta
         * @param {string} dataProviderId
         */
        onDatasetMetaSelect(meta, dataProviderId) {
            if (meta !== null) {
                this.datasetMetaSelect(meta, dataProviderId);
            }
            this.nextView();
        },
        /**
         * @param {IDatasetRequestProps} datasetProps
         */
        onDatasetPropsChanged(datasetProps) {
            this.setDatasetProps(datasetProps);
        },
        onDataProviderChange() {
            /** @type {IProjectDataProvider} */
            const dataProvider = this.dataProviders.find(({ id }) => id === this.dataProviderId);
            this.$showToast({ text: ToastMessage.DATA_PROVIDER_CHANGED(dataProvider) });
        },
        onClearError() {
            this.errors = [];
            this.isErrorShown = false;
        }
    }
};
</script>
<style lang="pcss" scoped>
.layout {
    position: absolute;
    top: 0;
    display: flex;
    flex-direction: column;
    width: 100%;
    height: 100%;

    &__header {
        display: grid;
        grid-template-columns: 1fr auto;
        align-items: center;
        /*padding: 1rem;*/
    }

    &__content {
        flex: 1 0 auto;
    }
}

.layout-controls {
    display: flex;
    flex-direction: row;
    align-items: center;
    gap: var(--spacer3);

    &__dataproviders {
        min-width: 15rem;
    }
}

.debug-info {
    min-width: 60vw;
    min-height: 40vh;

    &__code {
        max-height: 40vh;
        overflow: auto;
    }
}
</style>
