<template>
    <div class="layout radius shadow scroll-none">
        <div class="flex-grow pos-rel h-0 scroll-x scroll-y">
            <table class="table table-borders table-hover table-vmid w-100 h-100 text-small">
                <thead>
                    <tr>
                        <th class="table-w-auto">
                            <div class="text-center text-bold">#</div>
                        </th>
                        <th v-for="(column, columnIndex) in header" :key="column.id" :style="headerCellStyle">
                            <slot
                                name="header-cell"
                                v-bind="{
                                    isLoading,
                                    column,
                                    letter: getLetter(columnIndex),
                                    onSortChange: (direction) => onHeaderSortChange(column.name, direction),
                                    onFilterChange: (target) => onHeaderFilterChange(column.name, target)
                                }">
                                <ui-header-cell
                                    v-bind="{
                                        isLoading,
                                        letter: getLetter(columnIndex),
                                        ...column
                                    }"
                                    @sort-change="(direction) => onHeaderSortChange(column.name, direction)"
                                    @filter-change="(target) => onHeaderFilterChange(column.name, target)">
                                    <b>{{ column.name }}</b>
                                    <template #type>{{ column.type }}</template>
                                </ui-header-cell>
                            </slot>
                        </th>
                    </tr>
                </thead>
                <tbody>
                    <tr v-for="rowIndex in limit" :key="rowIndex">
                        <td class="text-center text-bold">{{ offset + rowIndex }}</td>
                        <template v-if="rowIndex > rows.length">
                            <td v-for="column in header" :key="`${rowIndex}-${column.id}`"></td>
                        </template>
                        <template v-else>
                            <td v-for="column in header" :key="`${rowIndex}-${column.id}`">
                                <template v-if="column.name && rows[rowIndex - 1][column.name] === undefined">
                                    <div class="skeleton skeleton-small"></div>
                                </template>
                                <template v-else>
                                    {{ rows[rowIndex - 1][column.name] }}
                                </template>
                            </td>
                        </template>
                    </tr>
                </tbody>
            </table>
            <ui-preloader size="xlarge" class="pos-abs pos-center" v-if="isLoading"></ui-preloader>
        </div>
        <div class="layout__footer pad-l1 text-xsmall">
            <div>
                <slot name="footer"></slot>
                <div>Записей: {{ rowCount }} / страниц: {{ pages }}</div>
            </div>
            <ui-pagination v-bind="{ page, pages }" @change="onPageChange"></ui-pagination>
        </div>
        <ui-shim overlay v-if="columns.length === 0">
            <ui-hero-placeholder type="vertical" icon="view-grid-plus-outline">
                <div class="text-center">
                    <b>Настройте метрики и измерения в датасете</b>
                    <div class="font-normal text-center">
                        Для быстрого перехода в датасет
                        <br />
                        кликните по кнопке в левом верхнем углу экрана
                    </div>
                </div>
            </ui-hero-placeholder>
        </ui-shim>
    </div>
</template>
<script>
import { Popup as UiPopup } from '@goodt-wcore/components';
import { Pagination as UiPagination } from 'goodteditor-ui';
import { UiShim, UiHeroPlaceholder, UiPreloader } from '@goodt-wcore/components';
import { getCellLetter } from '../../../utils';
import UiHeaderCell from './HeaderCell.vue';
import { isEqual } from 'lodash';

/**
 * @typedef {object} ITableHeaderColumn
 * @property {symbol} id
 * @property {string} name
 * @property {string} alias
 * @property {string} type
 * @property {?string} sortDirection
 * @property {boolean} isSortable
 * @property {boolean} isFiltered
 * @property {boolean} canFilter
 *
 * @typedef {object} ITableColumnInfo
 * @property {string} name
 * @property {string} alias
 *
 * @typedef {import('@goodt-common/data').IDatasetRequestProps} IDatasetRequestProps
 * @typedef {import('@goodt-common/data').IQuerySortInfo} IQuerySortInfo
 * @typedef {import('@goodt-common/data').IQueryFilterInfo} IQueryFilterInfo
 * @typedef {import('@goodt-common/data').IDatasetFieldSchema} IDatasetFieldSchema
 */
export default {
    components: { UiPagination, UiPopup, UiHeaderCell, UiShim, UiHeroPlaceholder, UiPreloader },
    props: {
        /** @type {import('vue').PropOptions<IQuerySortInfo[]>} */
        sort: {
            type: Array,
            default: () => []
        },
        /** @type {import('vue').PropOptions<IQueryFilterInfo[]>} */
        filters: {
            type: Array,
            default: () => []
        },
        /** @type {import('vue').PropOptions<IDatasetFieldSchema[]>} */
        schema: {
            type: Array,
            default: () => []
        },
        /** @type {import('vue').PropOptions<ITableColumnInfo[]>} */
        columns: {
            type: Array,
            default: () => []
        },
        /** @type {import('vue').PropOptions<Record<string, any>[]>} */
        rows: {
            type: Array,
            default: () => []
        },
        limit: {
            type: Number,
            default: 20
        },
        offset: {
            type: Number,
            default: 0
        },
        rowCount: {
            type: Number,
            default: 0
        },
        columnCount: {
            type: Number,
            default: 10
        },
        isLoading: {
            type: Boolean,
            default: false
        }
    },
    data() {
        return {
            id: 0,
            header: this.buildHeader()
        };
    },
    watch: {
        headerProps(newValue, oldValue) {
            if (!isEqual(newValue, oldValue)) {
                this.header = this.buildHeader();
            }
        }
    },
    computed: {
        headerProps() {
            const { sort, filters, schema, columns } = this;
            return {
                sort,
                filters,
                schema,
                columns
            };
        },
        /**
         * @return {object}
         */
        headerCellStyle() {
            const { length } = this.header;
            return { width: `${100 / length}%` };
        },
        /**
         *
         */
        pages() {
            const { limit, rowCount } = this;
            return Math.ceil(rowCount / limit);
        },
        /**
         * @return {number}
         */
        page() {
            const { limit, offset } = this;
            return offset / limit + 1;
        }
    },
    methods: {
        /**
         * @return {ITableHeaderColumn[]}
         */
        buildHeader() {
            /** @type {{ columnCount:number, sort:IQuerySortInfo[], filters:IQueryFilterInfo[], schema:IDatasetFieldSchema[], columns:ITableColumnInfo[] }} */
            const { columnCount, sort, filters, schema, columns } = this;
            if (columns.length > 0) {
                const header = columns.map(({ name, alias }) => {
                    const sortInfo = sort.find(({ name }) => name === alias);
                    const filterInfo = filters.find(({ name }) => name === alias);
                    const typeInfo = schema.find(({ name }) => name === alias);
                    return {
                        id: name,
                        name,
                        alias,
                        type: typeInfo?.type ?? '',
                        sortDirection: sortInfo?.direction ?? null,
                        isSortable: true,
                        isFiltered: filterInfo != null,
                        canFilter: true
                    };
                });
                return header;
            }
            return Array(columnCount)
                .fill(null)
                .map((_, index) => ({
                    id: index,
                    name: '',
                    alias: '',
                    type: '',
                    sortDirection: null,
                    isSortable: false,
                    isFiltered: false,
                    canFilter: false
                }));
        },
        getLetter(index) {
            return getCellLetter(index + 1);
        },
        onPageChange(page) {
            const offset = (page - 1) * this.limit;
            this.$emit('page-change', { page, offset });
        },
        onHeaderSortChange(name, direction) {
            this.$emit('sort-change', { name, direction });
        },
        onHeaderFilterChange(name, target) {
            this.$emit('filter-change', { name, target });
        }
    }
};
</script>
<style lang="less" scoped>
.layout {
    position: relative;
    display: flex;
    height: 100%;
    flex-direction: column;
    background: var(--color-white);

    &__footer {
        display: grid;
        grid-template-columns: 1fr auto;
        border-top: 1px solid var(--color-border);
    }
}

.table {
    --bg-header: #edf4fe;

    thead {
        position: sticky;
        top: 0;
        z-index: 1;
    }

    th,
    td {
        padding-inline: 1rem;
    }

    th {
        padding-block: 0.75rem;
        background: var(--bg-header);
        border-right: 1px solid var(--color-border);
    }

    td {
        border-right: 1px solid var(--color-border);

        &:first-child {
            position: sticky;
            left: 0;
            background: var(--bg-header);
        }
    }
}

.is-hidden {
    visibility: hidden;
}
</style>
