<template>
    <div class="grid">
        <ui-has-two-columns v-if="variableBinds.length > 0">
            <template #left>
                <ui-button type="secondary" class="w-100" @click="onAllVariablesToggle(true)">Выбрать все</ui-button>
            </template>
            <template #right>
                <ui-button type="secondary" class="w-100" @click="onAllVariablesToggle(false)">Сбросить все</ui-button>
            </template>
        </ui-has-two-columns>
        <div class="grid">
            <div
                v-for="{ variable, isSelected } in variableBinds"
                :class="[variable ? 'grid-item' : '']"
                :key="variable ? variable.name : 'divider'">
                <hr v-if="variable == null">
                <ui-checkbox v-else :value="isSelected" @change="onVariableToggle(variable, isSelected)">
                    <ui-destruct :of="$getQueryEntityError([EntityType.VARIABLE], variable.name) || {}">
                        <template #is="{ message }">
                            <ui-entity-badge-error v-if="message" :message="message">
                                @{{ variable.name }}
                            </ui-entity-badge-error>
                            <ui-entity-badge v-else type="variable">@{{ variable.name }}</ui-entity-badge>
                        </template>
                    </ui-destruct>
                </ui-checkbox>
            </div>
        </div>
    </div>
</template>
<script>
import { UiButton, UiHasTwoColumns, UiCheckbox } from '@goodt-wcore/panel-ui';
import { Destruct as UiDestruct } from '@goodt-wcore/components';
import UiEntityBadge from '../../shared/EntityBadge.vue';
import UiEntityBadgeError from '../../shared/EntityBadgeError.vue';
import { EntityType } from "../../../const";

/**
 * @typedef {import('@goodt-common/data').IDatasetVariable} IDatasetVariable
 * @typedef {import('@goodt-common/data').IQueryVariableInfo} IQueryVariableInfo
 * @typedef {{ variable: { name: IQueryVariableInfo['name']|IDatasetVariable['name'] }, isSelected: boolean }} IQueryVariableBinds
 */

export default {
    components: {
        UiButton,
        UiCheckbox,
        UiHasTwoColumns,
        UiEntityBadge,
        UiEntityBadgeError,
        UiDestruct
    },
    inject: ['$getQueryEntityError'],
    props: {
        /**
         * @type {import('vue').PropOptions<IQueryVariableInfo[]>}
         */
        variables: {
            type: Array,
            default: () => []
        },
        /** @type {import('vue').PropOptions<IDatasetVariable[]>} */
        availableVariables: {
            type: Array,
            default: () => []
        }
    },
    static: {
        EntityType
    },
    data() {
        return {};
    },
    computed: {
        /**
         * @return {IQueryVariableBinds[]}
         */
        variableBinds() {
            const { availableVariables, variables, buildVariableBinds } = this;
            const freeVariables = availableVariables.filter(
                ({ name }) => !variables.some((variableInfo) => variableInfo.name === name)
            );
            const hasDivider = freeVariables.length > 0 && variables.length > 0;
            return [
                ...buildVariableBinds(variables, { isSelected: true }),
                ...(hasDivider ? [{}] : []),
                ...buildVariableBinds(freeVariables, { isSelected: false })
            ];
        }
    },
    methods: {
        /**
         *
         * @param {IDatasetVariable[]|IQueryVariableInfo[]} list
         * @param {{ isSelected: boolean }} defaults
         * @return {IQueryVariableBinds[]}
         */
        buildVariableBinds(list, defaults) {
            return list.map(({ name }) => ({ variable: { name }, ...defaults }));
        },
        /**
         * @param {Pick<IQueryVariableInfo, 'name'>} options
         * @param {boolean} isSelected
         */
        onVariableToggle({ name }, isSelected) {
            const { variables } = this;
            const updatedVariables =
                isSelected === false
                    ? [...variables, { name }]
                    : variables.filter((variableInfo) => variableInfo.name !== name);
            this.emitChange(updatedVariables);
        },
        /**
         * @param {boolean} isSelected
         */
        onAllVariablesToggle(isSelected) {
            const { availableVariables } = this;
            const variables = isSelected ? availableVariables.map(({ name }) => ({ name })) : [];
            this.emitChange(variables);
        },
        /**
         * @param {IQueryVariableInfo[]} queryVariableInfos
         */
        emitChange(queryVariableInfos) {
            this.$emit('change', queryVariableInfos);
        }
    }
};
</script>
<style lang="pcss" scoped>
.grid {
    display: grid;
    gap: 1rem;

    &-item {
        display: grid;
        align-items: center;
        grid-template-columns: auto 1fr;
        gap: 0.5rem;
    }
}
</style>
