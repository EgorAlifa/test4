<template>
    <div class="pos-abs">
        <ui-popover v-bind="popoverBinds" ref="popover">
            <div class="panel events-all">
                <div class="panel-header cursor-move" @mousedown="onPanelHeaderMouseDown">
                    <div class="close cursor-pointer pos-abs pos-top-right mar-2" @click="onClose">
                        <i class="mdi mdi-close color-grey" />
                    </div>
                </div>
                <div class="panel-body u-select-none">
                    <slot></slot>
                </div>
            </div>
        </ui-popover>
    </div>
</template>
<script>
import { Popover as UiPopover } from 'goodteditor-ui';

export default {
    components: { UiPopover },
    props: {
        target: { type: String, default: '' },
        position: { type: String, default: 'right' }
    },
    data() {
        return { dragStart: { x: 0, y: 0 }, panelPos: { x: 0, y: 0 } };
    },
    computed: {
        popoverBinds() {
            const { position, target, panelStyle } = this;
            return {
                appendToBody: true,
                shouldRespondToPointerEvents: false,
                show: true,
                position,
                target,
                style: panelStyle,
                zIndex: 1
            };
        },
        panelStyle() {
            const { x, y } = this.panelPos;
            return { transform: `translate3d(${x}px, ${y}px, 0)` };
        }
    },
    mounted() {
        setTimeout(() => {
            const rect = this.$refs.popover.$el.getBoundingClientRect();
            this.panelPos = { x: rect.x, y: rect.y };
        });
    },
    beforeDestroy() {
        this.removeEvents();
    },
    methods: {
        addEvents() {
            document.addEventListener('mousemove', this.onDocMouseMove);
            document.addEventListener('mouseup', this.onDocMouseUp);
        },
        removeEvents() {
            document.removeEventListener('mousemove', this.onDocMouseMove);
            document.removeEventListener('mouseup', this.onDocMouseUp);
        },
        onClose() {
            this.$emit('close');
        },
        onPanelHeaderMouseDown({ offsetX: x, offsetY: y }) {
            this.dragStart = { x, y };
            this.removeEvents();
            this.addEvents();
        },
        onDocMouseMove({ pageX, pageY }) {
            const { x, y } = this.dragStart;
            this.panelPos = { x: pageX - x, y: pageY - y };
        },
        onDocMouseUp() {
            this.removeEvents();
        }
    }
};
</script>
<style lang="less" scoped>
.panel {
    &-header {
        position: relative;
        height: 2rem;
        padding: 0;
    }
    &-body {
        padding-top: 0;
    }
}
</style>
