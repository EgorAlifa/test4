<template>
    <div class="filter-item">
        <div class="filter-item__def text-small text-truncate">
            <ui-entity-badge-error v-if="error" :message="error.message">{{ filter.name }}</ui-entity-badge-error>
            <ui-entity-badge v-else :type="type" :multiline="false" :title="filter.name">
                <span>{{ filter.name }}</span>
            </ui-entity-badge>
            <span class="pad-h-3 nobr">{{ getOperatorLabel(filter.operator) }}</span>
            <div
                class="badge bg-disabled text-truncate"
                :class="[filterValue === '' ? 'text-xsmall color-grey' : 'text-small']"
                :title="filterValue">
                {{ filterValue === '' ? '&lt;пустая строка&gt;' : filterValue }}
            </div>
        </div>
        <ui-icon name="pencil" @click="onEdit"></ui-icon>
        <ui-icon name="delete" @click="onDelete"></ui-icon>
    </div>
</template>
<script>
import { UiIcon } from '@goodt-wcore/components';
import UiEntityBadge from '../../shared/EntityBadge.vue';
import UiEntityBadgeError from '../../shared/EntityBadgeError.vue';
import { EntityType } from '../../../const';

/**
 * @typedef {import('@goodt-common/domain').ValidationError} ValidationError
 * @typedef {import('@goodt-common/data').IQueryFilterInfo} IQueryFilterInfo
 * @typedef {typeof import('../../const').EntityType} EntityTypeEnum
 * @typedef {import('@goodt-wcore/components').ISelectOption} ISelectOption
 */
export default {
    components: {
        UiEntityBadge,
        UiEntityBadgeError,
        UiIcon
    },
    inject: ['$getQueryEntityType', '$getQueryEntityError'],
    props: {
        /** @type {import('vue').PropType<IQueryFilterInfo>} */
        filter: {
            type: Object,
            default: null
        },
        /** @type {import('vue').PropType<ISelectOption[]>} */
        operators: {
            type: Array,
            default() {
                return [];
            }
        }
    },
    computed: {
        /**
         * @return {EntityType[keyof EntityType]}
         */
        type() {
            return this.$getQueryEntityType(this.filter.name);
        },
        filterValue() {
            const { value } = this.filter;
            return Array.isArray(value) ? value.join(',') : null;
        },
        /**
         * @return {ValidationError}
         */
        error() {
            return this.$getQueryEntityError([EntityType.FILTER], this.filter.name);
        }
    },
    methods: {
        /**
         * @param valueToFind
         * @return {string}
         */
        getOperatorLabel(valueToFind) {
            const { operators } = this;
            const operator = operators.find(({ value }) => value === valueToFind);
            return operator?.label ?? valueToFind;
        },
        onEdit() {
            this.$emit('edit');
        },
        onDelete() {
            this.$emit('delete');
        }
    }
};
</script>
<style lang="pcss" scoped>
.filter-item {
    display: grid;
    grid-template-columns: 1fr auto auto;
    align-items: start;

    &__def {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
    }
}
</style>
