<template>
    <div class="grid">
        <ui-button id="sort-add" @click="onSortAdd">Добавить сортировку</ui-button>
        <ui-draggable class="grid" v-model="sortMutable" v-bind="dragOptions" @change="sortChanged">
            <ui-sort-item
                v-for="(sort, i) in sortMutable"
                v-bind="{
                    id: `sort-${i}`,
                    sort,
                    names,
                    directions
                }"
                :key="i"
                @edit="() => onSortEdit(i)"
                @delete="() => onSortDelete(i)" />
        </ui-draggable>
        <ui-float-panel :target="editorTarget" @close="isEditorShown = false" v-if="isEditorShown">
            <ui-sort-panel
                v-bind="{
                    sort: editSort,
                    sorts: sort,
                    directions,
                    names
                }"
                @save="onEditorSave"></ui-sort-panel>
        </ui-float-panel>
    </div>
</template>
<script>
import UiDraggable from 'vuedraggable';
import { UiButton } from '@goodt-wcore/components';
import { cloneDeep } from 'lodash';
import UiSortItem from './SortItem.vue';
import UiSortPanel from './SortPanel.vue';
import UiFloatPanel from '../../shared/FloatPanel.vue';

/**
 * @typedef {import('@goodt-common/data').IDatasetQuerySort} IDatasetQuerySort
 * @typedef {object} IOption
 * @property {string} value
 * @property {string} label
 */
export default {
    components: { UiButton, UiSortItem, UiSortPanel, UiFloatPanel, UiDraggable },
    props: {
        names: {
            /** @type {import('vue').PropType<IOption[]>} */
            type: Array,
            default() {
                return [];
            }
        },
        directions: {
            /** @type {import('vue').PropType<IOption[]>} */
            type: Array,
            default() {
                return [];
            }
        },
        sort: {
            /** @type {import('vue').PropType<IDatasetQuerySort[]>} */
            type: Array,
            default() {
                return [];
            }
        }
    },
    data() {
        return {
            /** @type {IDatasetQuerySort[]} */
            sortMutable: [],
            editSort: null,
            editSortIndex: -1,
            editorTarget: '',
            isEditorShown: false
        };
    },
    static: {
        dragOptions: {
            animation: 200,
            handle: '.cursor-move'
        }
    },
    watch: {
        sort: {
            handler(val) {
                this.sortMutable = cloneDeep(val);
            },
            immediate: true
        }
    },
    methods: {
        sortChanged() {
            const { sortMutable } = this;
            this.$emit('change', cloneDeep(sortMutable));
        },
        showEditor({ sort = null, index = -1, target }) {
            this.editSort = sort;
            this.editSortIndex = index;
            this.editorTarget = target;
            this.isEditorShown = true;
        },
        onEditorSave({ sort, isNew }) {
            const { editSortIndex, sortMutable } = this;
            if (isNew) {
                sortMutable.push(sort);
            } else {
                sortMutable.splice(editSortIndex, 1, sort);
            }
            this.editSort = null;
            this.isEditorShown = false;
            this.sortChanged();
        },
        onSortAdd() {
            this.showEditor({ target: '#sort-add' });
        },
        onSortEdit(index) {
            const sort = cloneDeep(this.sortMutable[index]);
            this.showEditor({ sort, index, target: `#sort-${index}` });
        },
        onSortDelete(index) {
            this.sortMutable.splice(index, 1);
            this.sortChanged();
        }
    }
};
</script>
<style lang="less" scoped>
.grid {
    display: grid;
    gap: 1rem;
}
</style>
