<template>
    <ui-panel class="filter-panel w-f3" :groups="[{ name: 'Фильтр', slot: 'default' }]">
        <ui-container>
            <ui-has-two-columns :left="8" :right="4">
                <template #left>
                    <ui-select
                        v-model="filterMutable.name"
                        :title="filterMutable.name"
                        :options="namesAvailableForEdit">
                        <template #select:label="{ index, label, value }">
                            <ui-entity-badge
                                class="filter-panel__badge"
                                v-if="index > -1"
                                :type="resolveEntityTypeByValue(value)">
                                {{ label }}
                            </ui-entity-badge>
                        </template>
                        <template #select:option-label="{ label, value, isSelected }">
                            <ui-entity-badge
                                class="filter-panel__badge"
                                :type="isSelected ? 'field' : resolveEntityTypeByValue(value)">
                                {{ label }}
                            </ui-entity-badge>
                        </template>
                        Поле
                    </ui-select>
                </template>
                <template #right>
                    <ui-select v-model="filterMutable.operator" :title="filterMutable.operator" :options="operators">
                        Оператор
                    </ui-select>
                </template>
            </ui-has-two-columns>
            <div class="pos-rel">
                <div class="pos-rel">
                    <ui-textarea
                        v-model="filterMutableValue"
                        :placeholder="filterValuePlaceholder"
                        class="filter-panel__textarea">
                        <ui-group class="w-100" justify="between" align="end">
                            <div>
                                Значение
                                <span
                                    id="filter-editor-value-placeholder-icon"
                                    class="color-primary text-small text-bold cursor-pointer"
                                    @click="arePlaceholdersShown = !arePlaceholdersShown">
                                    (x)
                                </span>
                                <!--
                                <ui-icon
                                    id="filter-editor-value-placeholder-icon"
                                    clickable
                                    :box="false"
                                    name="variable"
                                    @click="arePlaceholdersShown = !arePlaceholdersShown" />
                                -->
                            </div>
                        </ui-group>
                    </ui-textarea>
                    <span
                        class="filter-panel__badge badge text-xsmall bg-border pos-abs pos-top-right mar-top-6 mar-right-1"
                        v-if="filterNameType">
                        {{ filterNameType }}
                    </span>
                    <ui-popover target="#filter-editor-value-placeholder-icon" :show.sync="arePlaceholdersShown">
                        <ui-datalist
                            :options="placeholders"
                            size="small"
                            @select-option="onPlaceholderSelect"></ui-datalist>
                    </ui-popover>
                </div>
            </div>
            <ui-has-two-columns v-if="deletable && !isNew">
                <template #left>
                    <ui-button type="secondary" @click="onDelete">Удалить</ui-button>
                </template>
                <template #right>
                    <ui-button :disabled="!isValid" @click="onSave">Сохранить</ui-button>
                </template>
            </ui-has-two-columns>
            <ui-button :disabled="!isValid" @click="onSave" v-else>Сохранить</ui-button>
        </ui-container>
    </ui-panel>
</template>
<script>
import { cloneDeep } from 'lodash';
import { Datalist as UiDatalist, Popover as UiPopover } from 'goodteditor-ui';
import { UiSelect, UiTextarea, UiButton, UiPanel, UiHasTwoColumns, UiContainer } from '@goodt-wcore/panel-ui';
import { UiIcon, UiGroup } from '@goodt-wcore/components';
import { QueryFilterOperatorPlaceholder } from '../../../const';
import { createFilterInfo, formatFilterOperatorValue } from '../../../utils';
import UiEntityBadge from '../../shared/EntityBadge.vue';

/**
 * @typedef {import('@goodt-common/data').IDatasetQueryFilter} IDatasetQueryFilter
 * @typedef {import('@goodt-common/data').IQueryFilterInfo} IQueryFilterInfo
 *
 * @typedef {object} Option
 * @property {string} label
 * @property {any} value
 *
 * @typedef {Option | { type: string, entityType: string }} OptionTyped
 */
export default {
    components: {
        UiSelect,
        UiTextarea,
        UiButton,
        UiPanel,
        UiContainer,
        UiHasTwoColumns,
        UiDatalist,
        UiPopover,
        UiGroup,
        UiEntityBadge,
        UiIcon
    },
    props: {
        nameDefault: {
            type: String,
            default: ''
        },
        filter: {
            /** @type {import('vue').PropType<IDatasetQueryFilter>} */
            type: Object,
            default() {
                return null;
            }
        },
        filters: {
            /** @type {import('vue').PropType<IDatasetQueryFilter[]>} */
            type: Array,
            default() {
                return [];
            }
        },
        /** @type {import('vue').PropOptions<OptionTyped[]>} */
        names: {
            type: Array,
            default() {
                return [];
            }
        },
        operators: {
            /** @type {import('vue').PropType<Option[]>} */
            type: Array,
            default() {
                return [];
            }
        },
        placeholders: {
            /** @type {import('vue').PropType<Option[]>} */
            type: Array,
            default() {
                return [];
            }
        },
        deletable: {
            type: Boolean,
            default: false
        }
    },
    data() {
        return {
            /** @type {IQueryFilterInfo} */
            filterMutable: null,
            arePlaceholdersShown: false
        };
    },
    computed: {
        isNew() {
            return this.filter == null;
        },
        isValid() {
            const { name, operator } = this.filterMutable;
            return name.length > 0 && operator.length > 0;
        },
        /**
         * @return {IOption[]}
         */
        namesAvailable() {
            const { names, filters } = this;
            return names.filter((opt) => filters.find((item) => item.name === opt.value) == null);
        },
        /**
         * @return {IOption[]}
         */
        namesAvailableForEdit() {
            const { namesAvailable, filter, isNew } = this;
            if (isNew) {
                return namesAvailable;
            }
            const { name } = filter;
            return [{ value: name, label: name }, ...namesAvailable];
        },
        filterMutableValue: {
            get() {
                const { filterMutable } = this;
                return filterMutable?.value.join(',') ?? '';
            },
            set(val) {
                const { filterMutable } = this;
                if (filterMutable != null) {
                    filterMutable.value = val.split(',');
                }
            }
        },
        filterNameType() {
            /** @type {{ names:OptionTyped[] }} */
            const { names } = this;
            const { name } = this.filterMutable;
            const typeInfo = names.find(({ value }) => value === name);
            return typeInfo?.type ?? '';
        },
        filterValuePlaceholder() {
            const { filterNameType } = this;
            const { operator } = this.filterMutable;
            const placeholder = QueryFilterOperatorPlaceholder[operator];
            const template = formatFilterOperatorValue('value', filterNameType);
            const out = placeholder ? placeholder(template) : [template];
            return out.join(',');
        }
    },
    watch: {
        filter: {
            handler(val) {
                const { nameDefault: name } = this;
                const filter = val == null ? createFilterInfo({ name }) : cloneDeep(val);
                this.filterMutable = filter;
            },
            deep: true,
            immediate: true
        }
    },
    methods: {
        /**
         * @param {string} theValue
         * @return {string}
         */
        resolveEntityTypeByValue(theValue) {
            /** @type {{ names: OptionTyped[] }} */
            const { names } = this;
            const option = names.find(({ value }) => value === theValue);
            return option?.entityType ?? '';
        },
        onPlaceholderSelect({ option }) {
            this.filterMutableValue += option;
            this.arePlaceholdersShown = false;
        },
        onSave() {
            const { filterMutable: filter, isNew } = this;
            this.$emit('save', { filter, isNew });
        },
        onDelete() {
            this.$emit('delete');
        }
    }
};
</script>
<style lang="pcss" scoped>
.filter-panel {
    &__textarea:deep(.textarea) {
        min-height: 5rem;
        max-height: 20rem;
    }

    &__badge {
        height: 1.225rem;
    }
}
</style>
