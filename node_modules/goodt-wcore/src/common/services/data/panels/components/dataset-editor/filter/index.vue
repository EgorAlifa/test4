<template>
    <div class="grid">
        <ui-button id="filter-add" @click="onFilterAdd">Добавить фильтр</ui-button>
        <ui-filter-item
            v-for="(filter, i) in filters"
            v-bind="{
                id: `filter-${i}`,
                filter,
                operators
            }"
            :key="i"
            @edit="() => onFilterEdit(i)"
            @delete="() => onFilterDelete(i)" />

        <ui-float-panel :target="editorTarget" @close="isEditorShown = false" v-if="isEditorShown">
            <ui-filter-panel
                v-bind="{
                    filter: editFilter,
                    filters,
                    names,
                    operators,
                    placeholders
                }"
                @save="onEditorSave"></ui-filter-panel>
        </ui-float-panel>
    </div>
</template>
<script>
import { UiButton } from '@goodt-wcore/components';
import { cloneDeep } from 'lodash';
import UiFilterItem from './FilterItem.vue';
import UiFilterPanel from './FilterPanel.vue';
import UiFloatPanel from '../../shared/FloatPanel.vue';

/**
 * @typedef {import('@goodt-common/data').IDatasetQueryFilter} IDatasetQueryFilter
 */
export default {
    components: {
        UiFilterItem,
        UiButton,
        UiFilterPanel,
        UiFloatPanel
    },
    props: {
        names: {
            /** @type {import('vue').PropType<{ value:string, label:string, type:string }[]>} */
            type: Array,
            default() {
                return [];
            }
        },
        operators: {
            /** @type {import('vue').PropType<{ value:string, label:string }[]>} */
            type: Array,
            default() {
                return [];
            }
        },
        placeholders: {
            /** @type {import('vue').PropType<{ value:string, label:string }[]>} */
            type: Array,
            default() {
                return [];
            }
        },
        filters: {
            /** @type {import('vue').PropType<IDatasetQueryFilter[]>} */
            type: Array,
            default() {
                return [{ name: '', operator: '$eq', value: [''] }];
            }
        }
    },
    data() {
        return {
            /** @type {IDatasetQueryFilter[]} */
            filtersMutable: [],
            /** @type {IDatasetQueryFilter} */
            editFilter: null,
            editFilterIndex: -1,
            editorTarget: '',
            isEditorShown: false,
            areEditorPlaceholdersShown: false
        };
    },
    watch: {
        filters: {
            handler(val) {
                this.filtersMutable = cloneDeep(val);
            },
            immediate: true
        }
    },
    methods: {
        filtersChanged() {
            const { filtersMutable } = this;
            this.$emit('change', cloneDeep(filtersMutable));
        },
        showEditor({ filter = null, index = -1, target }) {
            this.editFilter = filter;
            this.editFilterIndex = index;
            this.editorTarget = target;
            this.isEditorShown = true;
        },
        onEditorSave({ filter, isNew }) {
            const { editFilterIndex, filtersMutable } = this;
            if (isNew) {
                filtersMutable.push(filter);
            } else {
                filtersMutable.splice(editFilterIndex, 1, filter);
            }
            this.editFilter = null;
            this.isEditorShown = false;
            this.filtersChanged();
        },
        onFilterAdd() {
            this.showEditor({ target: '#filter-add' });
        },
        onFilterEdit(index) {
            const filter = cloneDeep(this.filtersMutable[index]);
            this.showEditor({ filter, index, target: `#filter-${index}` });
        },
        onFilterDelete(index) {
            this.filtersMutable.splice(index, 1);
            this.filtersChanged();
        }
    }
};
</script>
<style lang="less" scoped>
.grid {
    display: grid;
    gap: 1rem;
}
</style>
