<template>
    <ui-panel class="drilldown-panel" :groups="[{ name: 'Сложное измерение', slot: 'default' }]">
        <ui-container>
            <ui-input
                v-model="drilldownMutable.name"
                :invalid="!isNameValid && drilldownMutable.name.length > 0"></ui-input>
            <ui-draggable class="grid" v-model="drilldownMutableDimensions" v-bind="dragOptions">
                <div class="entity" v-for="item in drilldownMutableDimensions" :key="item.name">
                    <input class="checkbox checkbox-small" type="checkbox" v-model="item.isSelected" />
                    <div class="text-truncate">
                        <ui-destruct :of="$getQueryEntityError([EntityType.DIMENSION], item.name) || {}">
                            <template #is="{ message }">
                                <ui-entity-badge-error
                                    v-if="message"
                                    :message="message"
                                    class="cursor-move text-truncate">
                                    {{ item.name }}
                                </ui-entity-badge-error>
                                <ui-entity-badge
                                    v-else
                                    class="cursor-move text-truncate"
                                    :multiline="false"
                                    :type="EntityType.DIMENSION">
                                    <i
                                        v-if="$hasEntityTemplate(item.name)"
                                        class="mdi mdi-library-shelves mar-right-2 color-grey"></i>
                                    <span>{{ item.name }}</span>
                                </ui-entity-badge>
                            </template>
                        </ui-destruct>
                    </div>
                </div>
            </ui-draggable>
            <ui-button :disabled="!isNameValid || !isDimensionsValid" @click="onSave">Сохранить</ui-button>
        </ui-container>
    </ui-panel>
</template>
<script>
import { cloneDeep } from 'lodash';
import UiDraggable from 'vuedraggable';
import { UiInput, UiButton, UiPanel, UiContainer, Destruct as UiDestruct } from '@goodt-wcore/components';
import { createDrilldown } from '../../../utils';
import UiEntityBadge from '../../shared/EntityBadge.vue';
import UiEntityBadgeError from '../../shared/EntityBadgeError.vue';
import { EntityType } from '../../../const';

/**
 * @typedef {import('@goodt-common/data').IDatasetQueryDrilldown} IDatasetQueryDrilldown
 *
 * @typedef {object} Option
 * @property {string} label
 * @property {any} value
 *
 * @typedef {Option | { type:string }} OptionTyped
 */
export default {
    components: {
        UiInput,
        UiButton,
        UiContainer,
        UiPanel,
        UiEntityBadge,
        UiDraggable,
        UiEntityBadgeError,
        UiDestruct
    },
    inject: ['$hasEntityTemplate', '$getQueryEntityError'],
    props: {
        drilldown: {
            /** @type {import('vue').PropType<IDatasetQueryDrilldown>} */
            type: Object,
            default() {
                return null;
            }
        },
        /** @type {import('vue').PropOptions<string[]>} */
        drilldownNames: {
            type: Array,
            default: () => []
        },
        /** @type {import('vue').PropOptions<string[]>} */
        dimensionNames: {
            type: Array,
            default: () => []
        },
        /** @type {import('vue').PropOptions<string[]>} */
        dimensionNamesFree: {
            type: Array,
            default: () => []
        },
        /** @type {import('vue').PropOptions<string[]>} */
        metricNames: {
            type: Array,
            default: () => []
        }
    },
    data() {
        return {
            nameOld: '',
            /** @type {IDatasetQueryDrilldown} */
            drilldownMutable: null,
            /** @type {{ name:string, isSelected:boolean }[]} */
            drilldownMutableDimensions: []
        };
    },
    computed: {
        isNameValid() {
            const { dimensionNames, metricNames, drilldownNames, nameOld } = this;
            const { name } = this.drilldownMutable;
            if (name.length < 1) {
                return false;
            }
            if ([...dimensionNames, ...metricNames].includes(name)) {
                return false;
            }
            const foundIndex = drilldownNames.indexOf(name);

            if (foundIndex >= 0 && name !== nameOld) {
                return false;
            }
            return true;
        },
        isDimensionsValid() {
            const { drilldownMutableDimensions } = this;
            const numSelected = drilldownMutableDimensions.reduce(
                (acc, { isSelected }) => (isSelected ? acc + 1 : acc),
                0
            );
            return numSelected > 1;
        }
    },
    static: {
        EntityType,
        dragOptions: {
            animation: 200,
            handle: '.cursor-move'
        }
    },
    watch: {
        drilldown: {
            /**
             * @param {IDatasetQueryDrilldown} val
             */
            handler(val) {
                /** @type {IDatasetQueryDrilldown} */
                const drilldown = val == null ? createDrilldown() : cloneDeep(val);
                this.drilldownMutable = drilldown;
                this.nameOld = drilldown.name;
            },
            deep: true,
            immediate: true
        }
    },
    created() {
        this.$watch(() => {
            const { dimensionNamesFree, drilldown } = this;
            const { dimensions = [] } = drilldown ?? {};
            this.drilldownMutableDimensions = [...dimensions, ...dimensionNamesFree].map((name) => ({
                name,
                isSelected: dimensions.includes(name)
            }));
        });
    },
    methods: {
        emitChanges() {
            const { drilldownMutable, drilldownMutableDimensions, nameOld } = this;
            const drilldown = {
                name: drilldownMutable.name,
                dimensions: drilldownMutableDimensions.filter(({ isSelected }) => isSelected).map(({ name }) => name)
            };
            this.$emit('save', { drilldown, nameOld });
        },
        onSave() {
            this.emitChanges();
        }
    }
};
</script>
<style lang="less" scoped>
.drilldown-panel {
    width: 22rem;
}

.grid {
    display: grid;
    gap: 0.5rem;
}

.entity {
    display: grid;
    gap: 0.5rem;
    grid-template-columns: auto 1fr;
    align-items: center;
}
</style>
