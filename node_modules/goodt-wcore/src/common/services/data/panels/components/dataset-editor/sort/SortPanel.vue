<template>
    <ui-panel class="sort-panel w-f3" :groups="[{ name: 'Сортировка', slot: 'default' }]">
        <ui-container>
            <ui-has-two-columns :left="8" :right="4">
                <template #left>
                    <ui-select v-model="sortMutable.name" :title="sortMutable.name" :options="namesAvailableForEdit">
                        <template #select:label="{ index, label, value }">
                            <ui-entity-badge class="sort-panel__badge" v-if="index > -1" :type="resolveEntityTypeByValue(value)">
                                {{ label }}
                            </ui-entity-badge>
                        </template>
                        <template #select:option-label="{ label, value, isSelected }">
                            <ui-entity-badge class="sort-panel__badge" :type="isSelected ? 'field' : resolveEntityTypeByValue(value)">
                                {{ label }}
                            </ui-entity-badge>
                        </template>
                        Поле
                    </ui-select>
                </template>
                <template #right>
                    <ui-select v-model="sortMutable.direction" :title="sortMutable.direction" :options="directions">
                        Направление
                    </ui-select>
                </template>
            </ui-has-two-columns>
            <ui-button :disabled="!isValid" @click="onSave">Сохранить</ui-button>
        </ui-container>
    </ui-panel>
</template>
<script>
import { cloneDeep } from 'lodash';
import { UiSelect, UiButton, UiPanel, UiContainer, UiHasTwoColumns } from '@goodt-wcore/panel-ui';
import { createSortInfo } from '../../../utils';
import UiEntityBadge from '../../shared/EntityBadge.vue';

/**
 * @typedef {import('@goodt-common/data').IDatasetQuerySort} IDatasetQuerySort
 */
export default {
    components: {
        UiEntityBadge,
        UiSelect,
        UiButton,
        UiPanel,
        UiContainer,
        UiHasTwoColumns
    },
    props: {
        sort: {
            /** @type {import('vue').PropType<IDatasetQuerySort>} */
            type: Object,
            default() {
                return null;
            }
        },
        sorts: {
            /** @type {import('vue').PropType<IDatasetQuerySort[]>} */
            type: Array,
            default() {
                return [];
            }
        },
        names: {
            /** @type {import('vue').PropType<{ value:string, label:string }[]>} */
            type: Array,
            default() {
                return [];
            }
        },
        directions: {
            /** @type {import('vue').PropType<{ value:string, label:string }[]>} */
            type: Array,
            default() {
                return [];
            }
        }
    },
    data() {
        return { sortMutable: null };
    },
    computed: {
        isNew() {
            return this.sort == null;
        },
        isValid() {
            const { name, direction } = this.sortMutable;
            return name.length > 0 && direction.length > 0;
        },
        /**
         * @return {IOption[]}
         */
        namesAvailable() {
            const { names, sorts } = this;
            return names.filter((opt) => sorts.find((item) => item.name === opt.value) == null);
        },
        /**
         * @return {IOption[]}
         */
        namesAvailableForEdit() {
            const { namesAvailable, sort, isNew } = this;
            if (isNew) {
                return namesAvailable;
            }
            const { name } = sort;
            return [{ value: name, label: name }, ...namesAvailable];
        }
    },
    watch: {
        sort: {
            handler(val) {
                const sort = val == null ? createSortInfo() : cloneDeep(val);
                this.sortMutable = sort;
            },
            deep: true,
            immediate: true
        }
    },
    methods: {
        /**
         * @param {string} theValue
         * @return {string}
         */
        resolveEntityTypeByValue(theValue) {
            /** @type {{ names: OptionTyped[] }} */
            const { names } = this;
            const option = names.find(({ value }) => value === theValue);
            return option?.entityType ?? '';
        },
        onSave() {
            const { sortMutable: sort, isNew } = this;
            this.$emit('save', { sort, isNew });
        }
    }
};
</script>
<style lang="less" scoped>
.sort-panel {
    &__badge {
        height: 1.225rem;
    }
}
</style>
