<script>
import { VariablePanelAsync } from '@goodt-wcore/panels';
import VariablePanelMixin from './mixins/VariablePanelMixin';
import UiBadge from './components/variable/Badge.vue';
import UiHeaderActions from './components/variable/HeaderActions.vue';
import { EntityType } from './const';

const { default: VariablePanel } = await VariablePanelAsync();

export default {
    extends: VariablePanel,
    components: { UiBadge, UiHeaderActions },
    mixins: [VariablePanelMixin],
    data: () => ({
        hasRestore: true
    }),
    methods: {
        resolveBadge(variable) {
            return {
                is: this.$options.components.UiBadge,
                text: variable.name,
                description: this.$t(variable.description),
                type: this.resolveType(variable)
            };
        },
        resolveScopeTitle(scope) {
            const isVisible = scope !== 'undefined' && this.scopes.length > 1;
            return isVisible
                ? {
                      is: this.$options.components.UiScopeTitle,
                      title: scope,
                      icon: 'database'
                  }
                : null;
        },
        resolveType(variable) {
            const { scopes, name } = variable;
            if (scopes === undefined) {
                return 'default';
            }
            if (this.variables.includes(name)) {
                return EntityType.VARIABLE;
            }
            if (this.metrics.includes(name)) {
                return EntityType.METRIC;
            }
            if (this.dimensions.includes(name)) {
                return EntityType.DIMENSION;
            }
            // order make sense, "fields" must order after "dimensions" due name intersections
            if (this.fields.includes(name)) {
                return EntityType.FIELD;
            }
            return 'default';
        },
        /**
         * @param {string} scope
         * @return {function(a, b): number}
         */
        createSortVariableInfos(scope) {
            if (scope === 'undefined') {
                return () => 0;
            }
            return this.$createVarAliasSortForDatasetRequest(scope);
        },
        /**
         * @override {VariablePanel.onRestore}
         */
        onRestore() {
            this.$restoreAutoMapVarAliases();
        }
    }
};
</script>
