<template>
    <w-panel>
        <ui-container>
            <ui-select :prop="getPropPath('refDatasetIndex')" :options="datasetRequestsOptions"></ui-select>
            <ui-select
                :prop="getPropPath('refDatasetKey')"
                :options="buildDimensionsOptions(deviationsProp.refDatasetIndex)"></ui-select>
            <ui-has-panel>
                <ui-label label-size="small" :prop="getPropPath('datasets')"></ui-label>
                <template #panel>
                    <ui-panel :groups="[{ name: 'Настройки источников', slot: 'default'}]">
                        <ui-container>
                            <ui-collapse v-for="(dataset, index) of deviationsProp.datasets" :key="index">
                                <template #header>
                                    <div class="row">
                                        <div class="col col-vmid">Источник {{ index }}</div>
                                        <div class="col col-vmid col-auto">
                                            <i class="mdi mdi-trash-can-outline color-red" @click.stop="onDeviationDatasetDelete(index)"></i>
                                        </div>
                                    </div>
                                </template>
                                <ui-container>
                                    <ui-select
                                        :prop="getPropPath(`datasets[${index}].index`)"
                                        :options="deviationDatasetOptions">
                                    </ui-select>
                                    <ui-select
                                        :prop="getPropPath(`datasets[${index}].key`)"
                                        :options="buildDimensionsOptions(dataset.index)"></ui-select>
                                </ui-container>
                            </ui-collapse>
                            <ui-button @click="onDeviationDatasetCreate">Создать источник отклонения</ui-button>
                        </ui-container>
                    </ui-panel>
                </template>
            </ui-has-panel>
            <ui-has-panel>
                <ui-label label-size="small" :prop="getPropPath('rules')"></ui-label>
                <template #panel>
                    <ui-panel :groups="[{ name: 'Настройки отклонений', slot: 'default'}]">
                        <ui-container>
                            <ui-collapse v-for="(rule, index) of deviationsProp.rules" :key="index">
                                <template #header>
                                    <div class="row">
                                        <div class="col col-vmid">{{ rule.name }}</div>
                                        <div class="col col-vmid col-auto">
                                            <i class="mdi mdi-content-copy mr-2" @click.stop="onDeviationRuleCopy(rule)"></i>
                                            <i class="mdi mdi-trash-can-outline color-red" @click.stop="onDeviationRuleDelete(index)"></i>
                                        </div>
                                    </div>
                                </template>
                                <ui-container>
                                    <ui-input
                                        :value="deviationsProp.rules[index].name"
                                        @change="(val) => onRuleNameChange(val, index)"></ui-input>
                                    <ui-textarea
                                        :value="deviationsProp.rules[index].formula"
                                        placeholder="КВДТ($('0.Метр') - $('1.Метр'))"
                                        @change="(val) => onFormulaChange(val, index)">
                                        <template #hint>
                                            <div>Для написания формулы доступны все арифметические операции (+-*/).</div>
                                            <p>И следующие функции:</p>
                                            <div class="grid">
                                                <template v-for="({ name, summary }) in DeviationContext">
                                                    <code class="text-center" style="line-height: 1.33">{{ name }}</code>
                                                    <span class="text-right">{{ summary }}</span>
                                                </template>
                                            </div>
                                        </template>
                                    </ui-textarea>
                                </ui-container>
                            </ui-collapse>
                            <ui-button @click="onDeviationRuleCreate">Создать отклонение</ui-button>
                        </ui-container>
                    </ui-panel>
                </template>
            </ui-has-panel>
        </ui-container>
    </w-panel>
</template>
<script>
import { Panel } from '@goodt-wcore/panel';
import { escapeRegExp } from '@goodt-common/utils';
import { PanelDatasetMixin, PanelDatasetMixinTypes } from '../mixins';
import { DEVIATIONS_PROP } from '../consts';
import { DeviationContext, DeviationFormulaAllowedTokens, DEVIATION_RULE_NAME_PREFIX } from '../utils';
import { extractQueryModelsParams } from '../mixins/utils';

export default {
    extends: Panel,
    meta: {
        name: 'Отклонения',
        icon: 'vector-selection',
        index: 100
    },
    mixins: [PanelDatasetMixin],
    static: {
        DEVIATIONS_PROP,
        DeviationContext
    },
    computed: {
        datasetRequestsOptions() {
            return [
                { value: null, label: ''},
                ...this.datasetRequests.map(({ name }, index) => ({
                    value: index,
                    label: `${name} [${index}]`
                }))
            ];
        },
        deviationDatasetOptions() {
            const { refDatasetIndex } = this.deviationsProp;
            return refDatasetIndex == null
                ? this.datasetRequestsOptions
                : this.datasetRequestsOptions.filter(({ value }) => value !== refDatasetIndex);
        },
        /** @return {import('../types').IDeviations} */
        deviationsProp() {
            return this.props[this.DEVIATIONS_PROP] ?? {};
        },
        /** @return {number} */
        lastDeviationRuleIndex() {
            return this.deviationsProp.rules
                .map(({ name }) => parseInt(name.replace(DEVIATION_RULE_NAME_PREFIX, ''), 10))
                .reduce((acc, value) => Math.max(acc, value), 0);
        }
    },
    methods: {
        ...PanelDatasetMixinTypes,
        /**
         * @param {string} key
         * @param {string} name
         * @return {string}
         */
        getPropPath(key, name = this.DEVIATIONS_PROP) {
            return `${name}.${key}`;
        },
        /**
         * @param {number} datasetIndex
         * @return {{ label: string, value: string }[]}
         */
        buildDimensionsOptions(datasetIndex) {
            const queryModel = this.queryModels[datasetIndex];
            const dimensions = extractQueryModelsParams([queryModel], ['dimensions']);
            return this.buildOptions(dimensions, { empty: true });
        },
        saveDeviations() {
            this.propChanged(this.DEVIATIONS_PROP);
        },
        onDeviationRuleCreate() {
            const { props, descriptor, DEVIATIONS_PROP, lastDeviationRuleIndex } = this;
            const { rules } = props[DEVIATIONS_PROP];
            const { createRule } = descriptor.props[DEVIATIONS_PROP].options;
            const newDeviationRule = createRule({ name: `${DEVIATION_RULE_NAME_PREFIX} ${lastDeviationRuleIndex + 1}` });
            rules.push(newDeviationRule);
            this.saveDeviations();
        },
        /** @param {import('../types').IDeviationRule} deviation */
        onDeviationRuleCopy(deviation) {
            const { props, DEVIATIONS_PROP, lastDeviationRuleIndex } = this;
            const { rules } = props[DEVIATIONS_PROP];
            rules.push({ ...deviation, name: `${DEVIATION_RULE_NAME_PREFIX} ${lastDeviationRuleIndex + 1}` });
            this.saveDeviations();
        },
        /** @param {number} index */
        onDeviationRuleDelete(index) {
            this.deviationsProp.rules.splice(index, 1);
            this.saveDeviations();
        },
        onDeviationDatasetCreate() {
            const { datasets } = this.deviationsProp;
            const { createDatasetProps } = this.descriptor.props[this.DEVIATIONS_PROP].options;
            const newDeviationDatasetProps = createDatasetProps();
            datasets.push(newDeviationDatasetProps);
            this.saveDeviations();
        },
        /** @param {number} index */
        onDeviationDatasetDelete(index) {
            this.deviationsProp.datasets.splice(index, 1);
            this.saveDeviations();
        },
        /**
         * @param {string} formula
         * @param {number} index
         */
        onFormulaChange(formula, index) {
            this.deviationsProp.rules[index].formula = this.sanitize(formula);
            this.saveDeviations();
        },
        /**
         * @param {string} input
         * @return {string}
         */
        sanitize(input) {
            const escapedDynamicTokens = [
                ...Object.values(DeviationContext).map(({ name }) => name),
                ...this.metrics
            ].map(escapeRegExp);
            const replaceRegExp = new RegExp(`(?:${[...DeviationFormulaAllowedTokens, ...escapedDynamicTokens].join('|')})`, 'g');
            const result = input.match(replaceRegExp);
            return result?.join('') ?? '';
        },
        /**
         * @param {string} newName
         * @param {number} index
         */
        onRuleNameChange(newName, index) {
            if (this.deviationsProp.rules.map(({ name }) => name).includes(newName)) {
                this.$forceUpdate();
                return;
            }
            this.deviationsProp.rules[index].name = newName;
            this.saveDeviations();
        }
    }
};
</script>
<style scoped>
.grid {
    display: grid;
    grid-template-columns: auto 1fr;
    gap: 0.75rem 1rem;
}
</style>
