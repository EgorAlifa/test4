/**
 * @typedef {import('@goodt-wcore/elem').StoreOperationType} StoreOperationType
 */
export default {
    computed: {
        /**
         * @return {string[]}
         */
        dimensions() {
            // use 'elementInstance' members
            // because it may have accessor 'datasetRequests'
            // from multiple dataset-related props (not only from 'props.dataset')
            // so there 'metrics', 'dimensions', 'fields', '$drilldown' are merged
            const { elementInstance: { dimensions, $drilldown = { dimensions: []} }} = this;
            return [...dimensions, ...$drilldown.dimensions]
        },
        /**
         * @return {string[]}
         */
        metrics() {
            const { elementInstance: { metrics } } = this;
            return metrics;
        },
        /**
         * @return {string[]}
         */
        fields() {
            const { elementInstance: { fields } } = this;
            return fields;
        },
        /**
         * @return {string[]}
         */
        variables() {
            const { elementInstance: { variables } } = this;
            return variables;
        }
    },
    methods: {
        /**
         * @param {string} requestName
         * @return {function(*, *): number}
         */
        $createVarAliasSortForDatasetRequest(requestName) {
            const { elementInstance: { requests } } = this;
            const { dimensions, metrics, variableNames, order } = requests.filter(Boolean).find(({ name }) => name === requestName).query;
            const params = [...dimensions, ...metrics];
            const getIndex = ({ name }) => {
                if (variableNames.includes(name)) {
                    return Number.NEGATIVE_INFINITY;
                }
                if (params.includes(name)) {
                    return order.indexOf(name);
                }
                return Number.POSITIVE_INFINITY;
            };
            return (a, b) => getIndex(a) - getIndex(b);
        },
        $restoreAutoMapVarAliases() {
            const { descriptor } = this;
            const varsMeta = descriptor.dataset?.vars;
            // if no dataset vars defined in descriptor
            // use dimensions
            if (varsMeta == null) {
                this.$storeAutoMapVarAliases(this.dimensions, this.StoreOperation.ALL);
            }
            if (varsMeta != null) {
                const {
                    metric: { operation: metricOperations = [] } = {},
                    dimension: { operation: dimensionOperations = [] }
                } = varsMeta;
                if (metricOperations.length > 0) {
                    this.$storeAutoMapVarAliases(this.metrics, metricOperations);
                }
                if (dimensionOperations.length > 0) {
                    this.$storeAutoMapVarAliases(this.dimensions, dimensionOperations);
                }
            }
        },

        /**
         * Update this.props.varAliases mapping in elemInstance
         *
         * @param {string[]} params
         * @param {StoreOperationType} operations
         */
        $storeAutoMapVarAliases(params, operations) {
            params.forEach((paramName) => {
                this.$storeMeta.setVar({ varAlias: paramName, operation: operations });
            });
            this.$storeMeta.saveVars();
        }
    }
};
