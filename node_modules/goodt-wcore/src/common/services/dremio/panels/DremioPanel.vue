<template>
    <ui-panel-container>
        <template v-if="datasetName">
            <div class="row row-collapse">
                <div class="col col-10-12">
                    <div
                        class="btn btn-small btn-ghost shadow text-truncate"
                        :title="datasetName"
                        @click="isEditorOpen = true">
                        <div class="icon mar-right-2">
                            <i class="mdi mdi-database" />
                        </div>
                        <div class="text-truncate">
                            {{ datasetName }}
                        </div>
                    </div>
                </div>
                <div class="col col-vmid text-right">
                    <div class="btn btn-icon btn-small" @click="onDeleteQueryClick">
                        <div class="icon">
                            <i class="mdi mdi-delete" />
                        </div>
                    </div>
                </div>
            </div>
        </template>
        <template v-else>
            <div class="row row-gap-3">
                <div class="col">
                    <div class="btn btn-small btn-primary text-truncate w-100" @click="isEditorOpen = true">
                        Настроить источник данных
                    </div>
                </div>
                <div class="col col-auto">
                    <button class="btn btn-small btn-primary btn-icon" @click="showDatasetImportPopup = true">
                        <div class="icon">
                            <i class="mdi mdi-database-import" />
                        </div>
                    </button>
                </div>
            </div>
        </template>

        <ui-portal v-if="isEditorOpen">
            <ui-query-editor
                v-bind="{
                    initQuery: query,
                    initDimensionList: dimensionList,
                    initLimit: limit,
                    initDataProviderId: dataProviderId
                }"
                @close="onEditorClose"
                @save="onEditorSave" />
        </ui-portal>

        <ui-import-dataset-popup
            :show="showDatasetImportPopup"
            @close="showDatasetImportPopup = false"
            @import="importDataset" />
    </ui-panel-container>
</template>
<script>
import { Portal as UiPortal } from '@goodt-wcore/components';
import { Query } from 'goodt-dremio-sdk';
import { Panel } from '@goodt-wcore/panel';
import UiQueryEditor from './QueryEditor.vue';
import UiImportDatasetPopup from './ImportDatasetPopup.vue';

const { KEY } = Query;

export default {
    meta: { name: 'Источник', icon: 'database' },
    components: {
        UiPortal,
        UiQueryEditor,
        UiImportDatasetPopup
    },
    extends: Panel,
    data() {
        return {
            isEditorOpen: false,
            showDatasetImportPopup: false
        };
    },
    computed: {
        query() {
            return this.props.dremio?.query ?? null;
        },
        dimensionList() {
            return this.props.dremio?.dimensionList ?? {};
        },
        limit() {
            return this.props.dremio?.limit ?? 60;
        },
        dataProviderId() {
            return this.props.dremio?.dataProviderId ?? null;
        },
        datasetName() {
            if (!this.query) {
                return null;
            }
            const from = this.query[KEY.FROM];
            return from[from.length - 1];
        }
    },
    methods: {
        onEditorClose() {
            this.isEditorOpen = false;
        },
        onEditorSave({ query, dimensionList, limit, dataProviderId }) {
            this.props.dremio = { query, dimensionList, limit, dataProviderId };
            this.propChanged('dremio');
            this.isEditorOpen = false;
        },
        importDataset(val) {
            this.props.dremio = JSON.parse(val);
            this.propChanged('dremio');
            this.showDatasetImportPopup = false;
        },
        onDeleteQueryClick() {
            this.props.dremio = null;
            this.propChanged('dremio');
        }
    }
};
</script>
