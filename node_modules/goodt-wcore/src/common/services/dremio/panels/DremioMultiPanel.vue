<template>
    <ui-panel-container>
        <div class="datasource-grid">
            <div class="datasource-item">
                <button class="btn btn-small btn-primary text-truncate w-100" @click="onDatasourceCreate">
                    Настроить источник данных
                </button>
                <button class="btn btn-small btn-primary btn-icon" @click="isDatasourceImportShown = true">
                    <div class="icon">
                        <i class="mdi mdi-database-import" />
                    </div>
                </button>
            </div>

            <div class="datasource-item" v-for="(datasource, i) in datasources" :key="i">
                <button
                    class="btn btn-small btn-secondary color-primary text-left text-truncate"
                    :title="getDatasourceName(datasource)"
                    @click="onDatasourceEdit(datasource, i)">
                    <div class="icon mar-right-2">
                        <i class="mdi mdi-database" />
                    </div>
                    <div class="text-truncate flex-grow">
                        {{ getDatasourceName(datasource) }}
                    </div>
                </button>
                <button class="btn btn-icon btn-secondary btn-small" @click="onDatasourceDelete(i)">
                    <div class="icon">
                        <i class="mdi mdi-delete" />
                    </div>
                </button>
            </div>
        </div>

        <ui-portal v-if="isDatasourceEditorShown">
            <ui-datasource-editor
                v-bind="datasourceEditorBinds"
                @close="onEditorClose"
                @save="onDatasourceEditorSave" />
        </ui-portal>

        <ui-import-datasource-popup
            :show="isDatasourceImportShown"
            @close="isDatasourceImportShown = false"
            @import="importDatasource" />
    </ui-panel-container>
</template>
<script>
import { Panel } from '@goodt-wcore/panel';
import { Query } from 'goodt-dremio-sdk';
import { Portal as UiPortal } from '@goodt-wcore/components';
import UiDatasourceEditor from './QueryEditor.vue';
import UiImportDatasourcePopup from './ImportDatasetPopup.vue';

const { KEY } = Query;

export default {
    components: {
        UiPortal,
        UiDatasourceEditor,
        UiImportDatasourcePopup
    },
    extends: Panel,
    data() {
        return {
            $meta: { name: 'Источник', icon: 'database' },
            isDatasourceEditorShown: false,
            isDatasourceImportShown: false,
            editDatasource: null,
            editDatasourceIndex: -1
        };
    },
    computed: {
        datasources: {
            set(val) {
                this.props.dremio = val;
                this.emitPropChange();
            },
            get() {
                return this.props.dremio;
            }
        },
        datasourceEditorBinds() {
            const {
                query: initQuery = null,
                dimensionList: initDimensionList = {},
                limit: initLimit = 60,
                dataProviderId: initDataProviderId = null
            } = this.editDatasource || {};
            return { initQuery, initDataProviderId, initDimensionList, initLimit };
        }
    },
    methods: {
        getDatasourceName(datasource) {
            const from = datasource.query[KEY.FROM];
            return from[from.length - 1];
        },
        emitPropChange() {
            this.propChanged('dremio');
        },
        importDatasource(val) {
            this.datasources.push(JSON.parse(val));
            this.emitPropChange();
            this.isDatasourceImportShown = false;
        },
        onEditorClose() {
            this.isDatasourceEditorShown = false;
        },
        onDatasourceEditorSave(datasource) {
            const { editDatasourceIndex } = this;
            if (editDatasourceIndex >= 0) {
                this.datasources.splice(editDatasourceIndex, 1, datasource);
            } else {
                this.datasources.push(datasource);
            }
            this.emitPropChange();
            this.isDatasourceEditorShown = false;
        },
        onDatasourceDelete(index) {
            this.datasources.splice(index, 1);
            this.emitPropChange();
        },
        onDatasourceEdit(datasource, index) {
            this.editDatasource = datasource;
            this.editDatasourceIndex = index;
            this.isDatasourceEditorShown = true;
        },
        onDatasourceCreate() {
            this.editDatasource = null;
            this.editDatasourceIndex = -1;
            this.isDatasourceEditorShown = true;
        }
    }
};
</script>
<style lang="pcss" scoped>
.datasource-grid {
    display: grid;
    gap: 1rem;
}
.datasource-item {
    display: grid;
    grid-template-columns: 1fr auto;
    gap: 1rem;
}
</style>
