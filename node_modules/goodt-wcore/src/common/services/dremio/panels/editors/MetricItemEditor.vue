<template>
    <div>
        <div class="row row-collapse">
            <div class="col">
                <ui-input
                    :class="{ invalid: !nameValid }"
                    v-model="nameEdit"
                    class="p"
                    @change="changed"
                >
                    Название
                </ui-input>
            </div>
            <div v-if="deletable" class="col col-auto col-vmid">
                <ui-button icon type="" @click="onDelete">
                    <div class="icon">
                        <i class="mdi mdi-minus-circle-outline mdi-18px" />
                    </div>
                </ui-button>
            </div>
        </div>
        <div class="row">
            <div class="col text-truncate">
                <template v-if="typeEdit === typeExpression">
                    <ui-has-panel auto-width>
                        <div class="form-label form-label-xsmall">Выражение</div>
                        <template #panel>
                            <ui-panel :groups="[{ name: nameEdit, slot: 'default' }]">
                                <ui-textarea class="min-w-f3" resize-both v-model="fieldEdit" @change="changed" />
                            </ui-panel>
                        </template>
                    </ui-has-panel>
                    <ui-input v-model="fieldEdit" @change="changed"></ui-input>
                </template>

                <div v-else class="form-control w-100">
                    <div class="form-label form-label-xsmall">
                        Поле
                    </div>
                    <select
                        v-model="fieldEdit"
                        class="select select-small w-100"
                        :class="{ invalid: !fieldEdit }"
                        :title="fieldEdit"
                        @change="changed"
                    >
                        <option v-for="n in fieldNames" :key="n" :value="n">
                            {{ n }}
                        </option>
                    </select>
                </div>
            </div>
            <div class="col col-6-12">
                <div class="form-label form-label-xsmall">
                    Агрегация
                </div>
                <select v-model="typeEdit" class="select select-small w-100" @change="changed">
                    <option v-for="({ type, name }) in metricTypes" :key="type" :value="type">
                        {{ name }}
                    </option>
                </select>
            </div>
        </div>
    </div>
</template>
<script>
import { Query } from 'goodt-dremio-sdk';
import { UiButton, UiInput, UiHasPanel, UiPanel, UiTextarea } from '@goodt-wcore/panel-ui';

export default {
    components: {
        UiButton, UiInput, UiHasPanel, UiPanel, UiTextarea
    },
    props: {
        name: {
            type: String,
            default: ''
        },
        type: {
            type: String,
            default: ''
        },
        field: {
            type: String,
            default: ''
        },
        fieldNames: {
            type: Array,
            default() {
                return [];
            }
        },
        metricNames: {
            type: Array,
            default() {
                return [];
            }
        },
        metricTypes: {
            type: Array,
            default() {
                return [];
            }
        },
        deletable: {
            type: Boolean,
            default: true
        }
    },
    data() {
        return {
            nameEdit: this.name,
            typeEdit: this.type,
            fieldEdit: this.field,
            typeExpression: Query.METRIC_TYPE.EXPRESSION
        };
    },
    computed: {
        nameValid() {
            return this.validateName();
        }
    },
    methods: {
        validateName() {
            const val = this.nameEdit.trim();
            const i = this.metricNames.indexOf(val);
            return val.length > 0 && i < 0;
        },
        validateType() {
            return this.metricTypes.find((el) => el.type === this.typeEdit) != null;
        },
        changed() {
            if (this.validateName() && this.validateType()) {
                const { nameEdit: name, typeEdit: type, fieldEdit: field } = this;
                this.$emit('change', { name: name.trim(), type, field });
            } else {
                this.$emit('invalid');
            }
        },
        onDelete() {
            this.$emit('delete');
        }
    }
};
</script>
