<template>
    <div>
        <div class="row row-collapse">
            <div class="col col-vbot text-truncate">
                <div class="form-control w-100">
                    <div class="form-label form-label-xsmall">поле</div>
                    <select
                        v-model="filterEdit.name"
                        class="select select-small w-100"
                        :class="{ invalid: !nameValid }"
                        :title="filterEdit.name"
                        @change="onChange">
                        <option v-for="name in namesAvailable" :key="name" :value="name">
                            {{ name }}
                        </option>
                    </select>
                </div>
            </div>
            <div class="col col-vbot col-3-12">
                <ui-select
                    v-model="filterEdit.type"
                    :class="{ invalid: !typeValid }"
                    :title="filterTypes[filterEdit.type] ? filterTypes[filterEdit.type].name : ''"
                    :options="filterTypeOptions"
                    @change="onChange">
                    тип
                </ui-select>
            </div>
            <div class="col">
                <ui-has-panel auto-width>
                    <div class="form-label form-label-xsmall">значения</div>
                    <template #panel>
                        <ui-panel :groups="[{ name: '', slot: 'default' }]">
                            <ui-has-two-columns class="p">
                                <template #left>
                                    <div class="form-label form-label-xsmall">поле</div>
                                    <select
                                        v-model="filterEdit.name"
                                        class="select select-small w-100"
                                        :class="{ invalid: !nameValid }"
                                        :title="filterEdit.name"
                                        @change="onChange">
                                        <option v-for="name in namesAvailable" :key="name" :value="name">
                                            {{ name }}
                                        </option>
                                    </select>
                                </template>
                                <template #right>
                                    <ui-select
                                        v-model="filterEdit.type"
                                        :class="{ invalid: !typeValid }"
                                        :title="filterTypes[filterEdit.type] ? filterTypes[filterEdit.type].name : ''"
                                        :options="filterTypeOptions"
                                        @change="onChange">
                                        тип
                                    </ui-select>
                                </template>
                            </ui-has-two-columns>
                            <ui-textarea v-model="value" resize-both class="min-w-f3" @change="onChange" />
                        </ui-panel>
                    </template>
                </ui-has-panel>
                <div class="form-control form-control-icon-right">
                    <input
                        v-model="value"
                        class="input input-small w-100"
                        :class="{ invalid: !valueValid }"
                        :title="value"
                        @change="onChange" />
                    <div class="icon cursor-pointer" @click.stop="showValueOptions = !showValueOptions">
                        <i class="mdi mdi-variable" />
                    </div>
                    <ui-datalist
                        v-if="showValueOptions"
                        :cursor-index.sync="filtersListCursorIndex"
                        :options="valueOptions"
                        class="pos-abs pos-bot-right pos-offset-bot text-xsmall"
                        @select-option="selectValueOption"></ui-datalist>
                </div>
            </div>
            <div v-if="deletable" class="col col-auto col-vbot">
                <ui-button icon type="" @click="onDelete">
                    <div class="icon">
                        <i class="mdi mdi-minus-circle-outline mdi-18px" />
                    </div>
                </ui-button>
            </div>
        </div>
    </div>
</template>
<script>
import { cloneDeep } from 'lodash';
import { Query } from 'goodt-dremio-sdk';
import { UiButton, UiHasPanel, UiPanel, UiTextarea, UiHasTwoColumns, UiSelect } from '@goodt-wcore/panel-ui';
import { Datalist as UiDatalist } from 'goodteditor-ui';

export default {
    components: {
        UiButton, UiHasPanel, UiPanel, UiTextarea, UiHasTwoColumns, UiSelect,
        UiDatalist
    },
    props: {
        filterNamesAvailable: {
            type: Array,
            default() {
                return [];
            }
        },
        filterTypes: {
            type: Object,
            default() {
                return {};
            }
        },
        filter: {
            type: Object,
            default() {
                return { name: '', type: '', value: [''] };
            }
        },
        deletable: {
            type: Boolean,
            default: true
        }
    },
    data() {
        return {
            filterEdit: null,
            valueOptions: Object.values(Query.FILTER_VALUE),
            showValueOptions: false,
            filtersListCursorIndex: -1
        };
    },
    computed: {
        value: {
            set(val) {
                this.filterEdit.value = val.split(',');
            },
            get() {
                return this.filterEdit.value.join(',');
            }
        },
        namesAvailable() {
            const arr = this.filterNamesAvailable.slice(0);
            arr.sort((a, b) => a.localeCompare(b));
            return arr;
        },
        nameValid() {
            return this.validateName();
        },
        typeValid() {
            return this.validateType();
        },
        valueValid() {
            return this.validateValues();
        },
        filterTypeOptions() {
            return Object.entries(this.filterTypes).map(([key, { name }]) => ({ value: key, label: name }));
        }
    },
    watch: {
        filter: {
            handler(val) {
                this.filterEdit = cloneDeep(val);
            },
            immediate: true
        }
    },
    created() {
        document.addEventListener('click', this.onDocClick);
    },
    beforeDestroy() {
        document.removeEventListener('click', this.onDocClick);
    },
    methods: {
        validateName() {
            return this.filterEdit.name.length > 0;
        },
        validateType() {
            return this.filterEdit.type.length > 0;
        },
        validateValues() {
            const t = this.filterTypes[this.filterEdit.type];
            return t ? t.validator(this.filterEdit.value) : false;
        },
        selectValueOption({ option }) {
            this.value += option;
            this.showValueOptions = false;
            this.onChange();
        },
        onChange() {
            if (!this.validateName() || !this.validateType() || !this.validateValues()) {
                return;
            }
            this.$emit('change', this.filterEdit);
        },
        onDelete() {
            this.$emit('delete', this.filterEdit);
        },
        onDocClick() {
            this.showValueOptions = false;
        }
    }
};
</script>