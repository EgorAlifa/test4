import Adapter from './Adapter';
import { UserProfileWithAttributes } from './utils/jwt';

export interface KeycloakConfigCookies {
    init: boolean;
    tokenKey: string;
    refreshTokenKey: string;
}

export interface KeycloakConfigCustomUrl {
    login: string;
    logout: string;
}

export interface KeycloakConfig {
    url: string;
    realm: string;
    clientId: string;
    flow?: 'code' | 'code-pkce' | 'rop';
    cookies?: KeycloakConfigCookies;
    customUrl?: KeycloakConfigCustomUrl;
    postMessageInit: boolean;
}

export interface Session {
    token: string;
    idToken: string;
}

class Keycloak extends Adapter {
    /**
     * @param config
     */
    constructor(config: KeycloakConfig);
    /**
     * Return auth status
     *
     * @type {boolean}
     */
    public authenticated: boolean;

    /**
     * Return token
     *
     * @type {string}
     */
    public token: string;

    /**
     * Return parsed token
     *
     * @type {?object}
     */
    public tokenParsed: Record<string, unknown>;

    /**
     * Returns default config
     *
     * @type {Record<string, any>}
     */
    public configDefault: KeycloakConfig;

    /**
     * Init adapter
     *
     * @return {Promise}
     */
    init(): Promise;

    /**
     * Login method
     *
     * @param {Record<string, any>} [credentials={}]  user credentials
     * @return {Promise<void>}
     */
    login(credentials = {}): Promise<void>;

    /**
     * Logout method
     *
     * @return {Promise<void>}
     */
    logout(): Promise<void>;

    /**
     * If the token expires within minValidity seconds the token is refreshed.
     *
     * @param {number} [minValidity=5]
     * @return {Promise<boolean>}  Promise; resolve(refreshed) if token is valid/update; reject() if session expired
     */
    updateToken(minValidity: number = 5): Promise<boolean>;

    /**
     * Returns user profile (depends on the adapter)
     *
     * @return {Promise<UserProfileWithAttributes>}   Promise; resolve(profile); reject() on error
     */
    getUserProfile(): Promise<UserProfileWithAttributes>;

    /**
     * Returns true if the token has less than minValidity seconds left before it expires (minValidity is optional, if not specified 0 is used).
     *
     * @param {number} [minValidity=5]
     * @return {boolean}
     */
    isTokenExpired(minValidity: number = 5): Promise<boolean>;
}

export default Keycloak;
