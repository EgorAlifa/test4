<template>
    <ui-panel-container>
        <ui-collapse class="p">
            <template #header>Пост-действие</template>
            <ui-input-url class="p" v-model="props.url" @change="propChanged('url')">
                {{ descriptor.props.url.label }}
            </ui-input-url>
            <ui-input class="p" v-model="props.event" @change="propChanged('event')">
                {{ descriptor.props.event.label }}
            </ui-input>
            <ui-collapse>
                <template #header>{{ descriptor.props.storeFilters.label }}</template>
                <div class="p" v-for="(filter, i) in props.storeFilters" :key="i">
                    <div class="row row-collapse">
                        <div class="col">
                            <ui-input v-model="filter.key" @change="onStoreFilterChange(filter, i)">имя</ui-input>
                        </div>
                        <div class="col">
                            <ui-input
                                class="mar-left-3"
                                :value="getStoreFilterValue(filter)"
                                @input="(val) => setStoreFilterValue(filter, val)"
                                @change="onStoreFilterChange(filter, i)">
                                значение
                            </ui-input>
                        </div>
                        <div class="col col-auto col-vbot">
                            <ui-button type="ghost" inline icon @click="onStoreFilterDelete(filter)">
                                <i class="mdi mdi-delete"></i>
                            </ui-button>
                        </div>
                    </div>
                </div>
                <ui-button @click="onStoreFilterAdd">Добавить</ui-button>
            </ui-collapse>
        </ui-collapse>
        <ui-collapse>
            <template #header>{{ descriptor.props.fields.label }}</template>
            <div class="p" v-for="[name, { type, options, isRequired }] in Object.entries(schema)" :key="name">
                <ui-has-panel v-if="isFieldValueAllowed({ type, options })">
                    <span class="text-small">
                        {{ name }}:
                        <code>{{ type }}</code>
                        <span class="color-red" v-if="isRequired">*</span>
                    </span>
                    <template #panel>
                        <ui-panel :groups="[{ name, slot: 'default' }]">
                            <ui-switch
                                class="p"
                                :value="getFieldHaveValue(name)"
                                @change="(val) => setFieldHaveValue(name, val)">
                                Использовать значение
                            </ui-switch>
                            <ui-has-two-columns v-if="getFieldHaveValue(name)">
                                <template #left>
                                    <ui-select
                                        :value="getFieldValueType(name)"
                                        :options="fieldValueTypeOptions"
                                        @change="(val) => setFieldValueType(name, val)">
                                        Тип
                                    </ui-select>
                                </template>
                                <template #right>
                                    <ui-input-auto
                                        :value="getFieldValueValue(name)"
                                        @input="(val) => setFieldValueValue(name, val)"
                                        @change="propChanged('fields')">
                                        Значение
                                    </ui-input-auto>
                                </template>
                            </ui-has-two-columns>
                        </ui-panel>
                    </template>
                </ui-has-panel>
                <template v-else>
                    <span class="text-small">
                        {{ name }}:
                        <code>{{ type }}</code>
                        <span class="color-red" v-if="isRequired">*</span>
                    </span>

                    <i class="mdi mdi-animation-outline v-mid"></i>
                </template>
            </div>
        </ui-collapse>
    </ui-panel-container>
</template>
<script>
import { Panel } from '@goodt-wcore/core';

export default {
    extends: Panel,
    data: () => ({
        /**
         * @public
         */
        $meta: { name: 'FormPanel', icon: 'form-select' }
    }),
    computed: {
        /**
         * @return {Object.<string, FormModelFieldSchema>}
         */
        schema() {
            const { elementInstance } = this;
            return elementInstance?.context?.schema ?? {};
        },
        /**
         * @return {{ value:any, label:string }[]}
         */
        fieldValueTypeOptions() {
            return this.descriptor.props.fields.valueTypeOptions;
        }
    },
    methods: {
        isFieldValueAllowed({ type, options }) {
            return options == null && type != 'ID';
        },
        getFieldHaveValue(name) {
            const { fields } = this.props;
            return name in fields;
        },
        setFieldHaveValue(name, val) {
            const { valueFactory } = this.descriptor.props.fields;
            const { fields } = this.props;
            if (val) {
                fields[name] = valueFactory();
            } else {
                delete fields[name];
            }
            this.propChanged('fields');
        },
        getFieldValueType(name) {
            const { fields } = this.props;
            return fields[name]?.type;
        },
        setFieldValueType(name, val) {
            const { fields } = this.props;
            if (name in fields) {
                fields[name].type = val;
                this.propChanged('fields');
            }
        },
        getFieldValueValue(name) {
            const { fields } = this.props;
            return fields[name]?.value;
        },
        setFieldValueValue(name, val) {
            const { fields } = this.props;
            if (name in fields) {
                fields[name].value = val;
            }
        },
        /**
         * @param {import('../mixins/form').StoreFilterItem}
         * @param {string} value
         */
        setStoreFilterValue(filter, value) {
            try {
                filter.value = JSON.parse(value);
            } catch (e) {
                // noop
            }
        },
        /**
         * @param {import('../mixins/form').StoreFilterItem}
         */
        getStoreFilterValue({ value }) {
            try {
                return JSON.stringify(value);
            } catch (e) {
                return String(value);
            }
        },
        saveStoreFilters() {
            const { storeFilters } = this.props;
            this.props.storeFilters = storeFilters.filter(({ key }) => key.length > 0);
            this.propChanged('storeFilters');
        },
        /**
         * @param {import('../mixins/form').StoreFilterItem} filter
         * @param {number} index
         */
        onStoreFilterChange({ key }, index) {
            const { storeFilters } = this.props;
            if (!key) {
                return;
            }
            const foundIndex = storeFilters.findIndex((el) => el.key === key);
            if (foundIndex !== index && foundIndex >= 0) {
                storeFilters.splice(foundIndex, 1);
            }
            this.saveStoreFilters();
        },
        /**
         * @param {import('../mixins/form').StoreFilterItem} filter
         */
        onStoreFilterDelete(filter) {
            this.props.storeFilters = this.props.storeFilters.filter((el) => el !== filter);
            this.saveStoreFilters();
        },
        onStoreFilterAdd() {
            const { storeFilters } = this.descriptor.props;
            this.props.storeFilters.push(storeFilters.factory());
        }
    }
};
</script>
