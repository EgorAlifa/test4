<template>
    <w-panel>
        <div v-for="event in events" :key="event.name" class="pad-v-1">
            <div class="d-flex flex-v-center">
                <div
                    class="mdi mdi-arrow-down pad-left-2"
                    :class="{ 'text-muted': !event.listen }"
                    :title="`listen: ${event.listen}`" />
                <div
                    class="mdi mdi-arrow-up"
                    :class="{ 'text-muted': !event.trigger }"
                    :title="`trigger: ${event.trigger}`" />
                <div
                    class="text-small pad-left-2"
                    :class="{ 'color-green': hits[event.name] }"
                    :title="event.description">
                    {{ event.name }}
                </div>
            </div>
        </div>
    </w-panel>
</template>
<script>
import { get as getByPath } from 'lodash';
import { Panel } from '@goodt-wcore/panel';

export default {
    extends: Panel,

    meta: {
        name: 'events',
        icon: 'swap-vertical',
        isHidden: ({ descriptor }) => Object.keys(descriptor.events ?? {}).length === 0,
        index: 200
    },

    data() {
        return {
            hits: {}
        };
    },
    computed: {
        /**
         * @return {{name: string, listen: string, triger: string}[]}
         */
        events() {
            /**
             *
             * @var {import('@goodt-wcore/elem').ElemDescriptorEventsMap | Object} events
             */
            const events = this.elementInstance?.descriptor.events ?? {};
            return Object.entries(events).map(([eventType, descriptor]) => {
                if (Array.isArray(descriptor)) {
                    const accessor = eventType;
                    const listen = descriptor.includes('listen') ? eventType : undefined;
                    const trigger = descriptor.includes('trigger') ? eventType : undefined;
                    return {
                        name: getByPath(this.props.events, accessor) ?? accessor ?? listen ?? trigger,
                        listen,
                        trigger
                    };
                }

                const { listen, trigger } = descriptor;
                const name =
                    getByPath(this.props.events, listen ?? trigger) ??
                    getByPath(this.props, listen ?? trigger) ??
                    listen ??
                    trigger;
                return { name, listen, trigger };
            });
        }
    },
    created() {
        this.onListenedBound = this.onListened.bind(this);
        this.events.forEach(({ name }) => {
            this.elementInstance.$eventBus.listen(name, this.onListenedBound);
        });
    },
    beforeDestroy() {
        this.events.forEach(({ name }) => {
            this.elementInstance.$eventBus.unlisten(name, this.onListenedBound);
        });
    },
    methods: {
        onListened(event) {
            this.hits = {
                ...this.hits,
                [event.type]: true
            };
            setTimeout(() => {
                this.hits = {
                    ...this.hits,
                    [event.type]: false
                };
            }, 2000);
        }
    }
};
</script>
