<template>
    <ui-container>
        <ui-collapse>
            <template #header>Фон</template>
            <draggable
                v-if="backgrounds.length > 0"
                v-model="backgrounds"
                @change="moveBackgrounds"
                v-bind="dragOptions">
                <ui-has-panel v-for="(background, index) in backgrounds" :key="index" class="p">
                    <i class="mdi mdi-drag cursor-move"></i>
                    <ui-label label-size="small" class="inline-block">Фон {{ index + 1 }}</ui-label>
                    <template #panel>
                        <ui-panel :groups="[{ name: 'Настройки фона', slot: 'background-settings' }]">
                            <template #background-settings>
                                <ui-container>
                                    <ui-select v-model="background.type" :options="BackgroundTypeOptions">
                                        Тип
                                    </ui-select>
                                    <ui-input-cp
                                        v-if="background.type === BackgroundType.COLOR"
                                        v-model="background.color"
                                        @change="backgroundHandler(index, background)">
                                        Цвет
                                    </ui-input-cp>
                                    <template v-if="background.type === BackgroundType.GRADIENT">
                                        <ui-select
                                            v-model="background.gradientType"
                                            :options="GradientTypeOptions"
                                            @change="backgroundHandler(index, background)">
                                            Тип градиента
                                        </ui-select>
                                        <ui-input-cp
                                            v-model="background.gradientFirstColor"
                                            @change="backgroundHandler(index, background)">
                                            Первый цвет
                                        </ui-input-cp>
                                        <ui-input
                                            type="number"
                                            v-model="background.gradientFirstColorOffset"
                                            @change="backgroundHandler(index, background)">
                                            Смещение первого цвета
                                        </ui-input>
                                        <ui-input-cp
                                            v-model="background.gradientSecondColor"
                                            @change="backgroundHandler(index, background)">
                                            Второй цвет
                                        </ui-input-cp>
                                        <ui-input
                                            type="number"
                                            v-model="background.gradientSecondColorOffset"
                                            @change="backgroundHandler(index, background)">
                                            Смещение второго цвета
                                        </ui-input>
                                        <ui-input
                                            type="number"
                                            v-model="background.gradientDirection"
                                            @change="backgroundHandler(index, background)">
                                            Направление
                                        </ui-input>
                                        <template v-if="background.gradientType === GradientType.RADIAL">
                                            <ui-input
                                                type="number"
                                                v-model="background.centerX"
                                                @change="backgroundHandler(index, background)">
                                                Центр по X
                                            </ui-input>
                                            <ui-input
                                                type="number"
                                                v-model="background.centerY"
                                                @change="backgroundHandler(index, background)">
                                                Центр по Y
                                            </ui-input>
                                            <ui-input
                                                type="number"
                                                v-model="background.radius"
                                                @change="backgroundHandler(index, background)">
                                                Радиус
                                            </ui-input>
                                        </template>
                                    </template>
                                    <template v-if="background.type === BackgroundType.FILE">
                                        <ui-input-browse
                                            v-model="background.file"
                                            @change="backgroundHandler(index, background)">
                                            Поле для ввода (url, file)
                                        </ui-input-browse>
                                        <ui-select
                                            v-model="background.repeat"
                                            :options="BackgroundRepeatOptions"
                                            @change="backgroundHandler(index, background)">
                                            Повтор
                                        </ui-select>
                                        <ui-input-units
                                            v-model="background.size"
                                            :units="SizeUnits"
                                            @change="backgroundHandler(index, background)">
                                            Размер
                                        </ui-input-units>
                                        <ui-select
                                            v-model="background.position"
                                            :options="BackgroundPositionOptions"
                                            @change="backgroundHandler(index, background)">
                                            Позиция
                                        </ui-select>
                                    </template>
                                    <ui-button type="error" @click="deleteBackground(index)">Удалить фон</ui-button>
                                </ui-container>
                            </template>
                        </ui-panel>
                    </template>
                </ui-has-panel>
            </draggable>
            <ui-button @click="addBackground">Добавить фон</ui-button>
        </ui-collapse>

        <ui-collapse>
            <template #header>Стилизация</template>
            <ui-container>
                <ui-input
                    type="number"
                    step="0.1"
                    min="0"
                    max="1"
                    v-model="primitiveStyle.opacity"
                    @change="onStylePropChanged(CssStyleName.OPACITY)">
                    Прозрачность
                </ui-input>
                <ui-has-panel>
                    <label class="form-label form-label-small">Граница</label>
                    <template #panel>
                        <ui-panel
                            :groups="[
                                { name: 'Граница', slot: 'group1' },
                                { name: 'Скругление', slot: 'group2' }
                            ]">
                            <template #group1>
                                <ui-container>
                                    <div class="border-wrapper">
                                        <div class="border-sides">
                                            <img
                                                class="border-sides__img"
                                                v-for="borderSide in BorderSides"
                                                :key="borderSide.key"
                                                :style="{ gridArea: borderSide.id }"
                                                :src="
                                                    getImageUrl(
                                                        borderSideModel === borderSide.key
                                                            ? borderSide.imgChecked
                                                            : borderSide.img
                                                    )
                                                "
                                                @click="setBorderSideModel(borderSide.key)"
                                                alt="" />
                                        </div>
                                        <div v-for="borderSide in BorderSides" :key="borderSide.key">
                                            <template v-if="borderSideModel === borderSide.key">
                                                <ui-input-units
                                                    :units="BorderWidthUnits"
                                                    v-model="border[borderSide.width]"
                                                    @change="borderHandler(borderSide.key)">
                                                    Толщина
                                                </ui-input-units>
                                                <ui-select
                                                    :options="BorderStyleOptions"
                                                    v-model="border[borderSide.type]"
                                                    @change="borderHandler(borderSide.key)">
                                                    Стиль
                                                </ui-select>
                                                <ui-input-cp
                                                    v-model="border[borderSide.color]"
                                                    @change="borderHandler(borderSide.key)">
                                                    Цвет
                                                </ui-input-cp>
                                            </template>
                                        </div>
                                    </div>
                                </ui-container>
                            </template>
                            <template #group2>
                                <ui-container>
                                    <ui-has-two-columns>
                                        <template #left>
                                            <div class="border-radiuses-options">
                                                <img
                                                    class="border-radiuses-options__img"
                                                    v-for="borderRadiusSide in BorderRadiusSidesOptions"
                                                    :key="borderRadiusSide.key"
                                                    :src="
                                                        getImageUrl(
                                                            borderRadiusModel === borderRadiusSide.key
                                                                ? borderRadiusSide.imgChecked
                                                                : borderRadiusSide.img
                                                        )
                                                    "
                                                    @click="setBorderRadiusModel(borderRadiusSide.key)"
                                                    alt="" />
                                            </div>
                                        </template>
                                        <template #right>
                                            <ui-input-units
                                                v-if="borderRadiusModel === BorderRadiusSidesOption.FULL"
                                                :units="SizeUnits"
                                                v-model="border.radius"
                                                @change="borderRadiusHandler(RADIUS_NAME)">
                                                Скругление
                                            </ui-input-units>
                                        </template>
                                    </ui-has-two-columns>
                                    <div
                                        class="border-radiuses-wrapper"
                                        v-if="borderRadiusModel === BorderRadiusSidesOption.SEPARATELY">
                                        <div
                                            v-for="borderRadius in BorderRadiusSides"
                                            :key="borderRadius.key"
                                            class="border-radiuses">
                                            <img
                                                class="border-radiuses__img"
                                                :src="getImageUrl(borderRadius.img)"
                                                alt="" />
                                            <ui-input-units
                                                :units="SizeUnits"
                                                v-model="border[borderRadius.key]"
                                                @change="borderRadiusHandler(borderRadius.key)">
                                                Скругление
                                            </ui-input-units>
                                        </div>
                                    </div>
                                </ui-container>
                            </template>
                        </ui-panel>
                    </template>
                </ui-has-panel>
                <ui-has-panel>
                    <label class="form-label form-label-small">Тень</label>
                    <template #panel>
                        <ui-panel :groups="[{ name: 'Тень', slot: 'group1' }]">
                            <template #group1>
                                <ui-container>
                                    <ui-has-two-columns>
                                        <template #left>
                                            <ui-input-units
                                                :units="BorderWidthUnits"
                                                v-model="boxShadow.offsetX"
                                                @change="boxShadowHandler">
                                                Сдвиг по X
                                            </ui-input-units>
                                        </template>
                                        <template #right>
                                            <ui-input-units
                                                :units="BorderWidthUnits"
                                                v-model="boxShadow.offsetY"
                                                @change="boxShadowHandler">
                                                Сдвиг по Y
                                            </ui-input-units>
                                        </template>
                                    </ui-has-two-columns>
                                    <ui-has-two-columns>
                                        <template #left>
                                            <ui-input-units
                                                :units="BorderWidthUnits"
                                                v-model="boxShadow.blurRadius"
                                                @change="boxShadowHandler">
                                                Размытие
                                            </ui-input-units>
                                        </template>
                                        <template #right>
                                            <ui-input-units
                                                :units="BorderWidthUnits"
                                                v-model="boxShadow.spreadRadius"
                                                @change="boxShadowHandler">
                                                Растяжение
                                            </ui-input-units>
                                        </template>
                                    </ui-has-two-columns>
                                    <ui-input-cp v-model="boxShadow.color" @change="boxShadowHandler">Цвет</ui-input-cp>
                                    <ui-select
                                        :options="BoxShadowOptions"
                                        v-model="boxShadow.type"
                                        @change="boxShadowHandler">
                                        Тип
                                    </ui-select>
                                </ui-container>
                            </template>
                        </ui-panel>
                    </template>
                </ui-has-panel>
                <ui-select
                    :options="OverflowOptions"
                    v-model="primitiveStyle[CssStyleName.OVERFLOW_X]"
                    @change="onStylePropChanged(CssStyleName.OVERFLOW_X)">
                    Overflow X
                </ui-select>
                <ui-select
                    :options="OverflowOptions"
                    v-model="primitiveStyle[CssStyleName.OVERFLOW_Y]"
                    @change="onStylePropChanged(CssStyleName.OVERFLOW_Y)">
                    Overflow Y
                </ui-select>
                <ui-select
                    :options="CursorOptions"
                    v-model="primitiveStyle.cursor"
                    @change="onStylePropChanged(CssStyleName.CURSOR)">
                    Курсор
                </ui-select>
                <ui-input type="number" v-model="transformAngle" @change="transformAngleHandler">Поворот</ui-input>
            </ui-container>
        </ui-collapse>

        <ui-collapse>
            <template #header>Размерность</template>
            <ui-container>
                <ui-has-two-columns>
                    <template #left>
                        <ui-input-units
                            v-model="primitiveStyle[CssStyleName.MIN_WIDTH]"
                            :units="SizeUnits"
                            :options="WidthHeightTypeOptions"
                            @change="onStylePropChanged(CssStyleName.MIN_WIDTH)">
                            Мин. ширина
                        </ui-input-units>
                    </template>
                    <template #right>
                        <ui-input-units
                            v-model="primitiveStyle[CssStyleName.MAX_WIDTH]"
                            :units="SizeUnits"
                            :options="WidthHeightTypeOptions"
                            @change="onStylePropChanged(CssStyleName.MAX_WIDTH)">
                            Макс. ширина
                        </ui-input-units>
                    </template>
                </ui-has-two-columns>

                <ui-has-two-columns>
                    <template #left>
                        <ui-input-units
                            v-model="primitiveStyle[CssStyleName.MIN_HEIGHT]"
                            :units="SizeUnits"
                            :options="WidthHeightTypeOptions"
                            @change="onStylePropChanged(CssStyleName.MIN_HEIGHT)">
                            Мин. высота
                        </ui-input-units>
                    </template>
                    <template #right>
                        <ui-input-units
                            v-model="primitiveStyle[CssStyleName.MAX_HEIGHT]"
                            :units="SizeUnits"
                            :options="WidthHeightTypeOptions"
                            @change="onStylePropChanged(CssStyleName.MAX_HEIGHT)">
                            Макс. высота
                        </ui-input-units>
                    </template>
                </ui-has-two-columns>
            </ui-container>
        </ui-collapse>
    </ui-container>
</template>

<script>
import { merge } from 'lodash';
import draggable from 'vuedraggable';
import { PanelUi } from '@goodt-wcore/components';
import { backgroundFactory, parseCss, filterObjectByKey } from './utils';
import { SizeUnits, BorderWidthUnits, BorderStyleOptions } from '../utils';
import {
    BackgroundTypeOptions,
    BackgroundType,
    GradientType,
    GradientTypeOptions,
    OverflowOptions,
    CursorOptions,
    BackgroundRepeatOptions,
    BackgroundPositionOptions,
    WidthHeightTypeOptions,
    BorderKey,
    BorderVariationKeys,
    BorderSides,
    BorderRadiusSidesOptions,
    BorderRadiusSides,
    CssStyleName,
    CssStylePropertyPart,
    BoxShadowOptions,
    BoxShadowType,
    DEFAULT_COLOR,
    BorderRadiusSidesOption,
    RADIUS_NAME,
    ROTATE_NAME
} from './constants';

export default {
    components: { draggable, ...PanelUi },
    props: { cssStyle: { type: Object, default: () => ({}) } },
    data() {
        return {
            componentStyle: null,
            transformAngle: 0,
            backgrounds: [],
            primitiveStyle: {},
            border: {},
            boxShadow: {},
            borderSideModel: CssStyleName.BORDER,
            borderRadiusModel: BorderRadiusSidesOption.FULL
        };
    },
    static: {
        BackgroundTypeOptions,
        BackgroundType,
        GradientType,
        GradientTypeOptions,
        dragOptions: {
            animation: 200,
            group: 'background',
            handle: '.mdi-drag'
        },
        OverflowOptions,
        CursorOptions,
        BackgroundRepeatOptions,
        SizeUnits,
        BorderWidthUnits,
        BackgroundPositionOptions,
        WidthHeightTypeOptions,
        SizeUnits,
        BorderStyleOptions,
        BorderRadiusSidesOption,
        BorderSides,
        BorderRadiusSidesOptions,
        BorderRadiusSides,
        CssStyleName,
        CssStylePropertyPart,
        BoxShadowOptions,
        RADIUS_NAME
    },
    watch: {
        cssStyle: {
            handler() {
                this.componentStyle = this.cssStyle;
                this.resolveCssStyle();
            },
            deep: true,
            immediate: true
        }
    },
    methods: {
        getImageUrl(img) {
            return `data:image/svg+xml;base64,${img}`;
        },
        setBorderSideModel(key) {
            this.borderSideModel = key;
        },
        setBorderRadiusModel(key) {
            this.borderRadiusModel = key;
        },
        backgroundHandler(index, background) {
            if (background.type === null) {
                this.backgrounds[index].output = '';
                this.mutateBackgroundProps();
                return;
            }
            if (background.type === BackgroundType.COLOR && background.color === '') {
                this.backgrounds[index].output = '';
            }
            if (background.type === BackgroundType.COLOR && background.color !== '') {
                this.backgrounds[index].output = background.color;
            }
            if (background.type === BackgroundType.GRADIENT && background.gradientType === GradientType.LINEAR) {
                this.backgrounds[index].output = `${CssStylePropertyPart.LINEAR_GRADIENT}(${
                    background.gradientDirection || 0
                }deg, ${background?.gradientFirstColor || DEFAULT_COLOR} ${
                    background.gradientFirstColorOffset || 0
                }%, ${background.gradientSecondColor || DEFAULT_COLOR} ${background.gradientSecondColorOffset || 0}%)`;
            }
            if (background.type === BackgroundType.GRADIENT && background.gradientType === GradientType.RADIAL) {
                this.backgrounds[index].output = `${CssStylePropertyPart.RADIAL_GRADIENT}(at ${
                    background.centerX || 0
                }% ${background.centerY || 0}%, ${background.gradientFirstColor || DEFAULT_COLOR} ${
                    background.radius || 0
                }%, ${background.gradientFirstColor || DEFAULT_COLOR} ${background.gradientFirstColorOffset || 0}%, ${
                    background.gradientSecondColor || DEFAULT_COLOR
                } ${background.gradientSecondColorOffset || 0}%)`;
            }
            if (background.type === BackgroundType.FILE && background.file !== '') {
                this.backgrounds[
                    index
                ].output = `${CssStylePropertyPart.URL}(${background.file}) ${background.repeat} ${background.position} / ${background.size}`;
            }
            if (background.type === BackgroundType.FILE && background.file === '') {
                this.backgrounds[index].output = '';
            }
            this.mutateBackgroundProps();
        },
        borderHandler(key) {
            if (key === CssStyleName.BORDER) {
                this.componentStyle.border = `${this.border.width} ${this.border.type} ${
                    this.border.color ?? DEFAULT_COLOR
                }`;
                this.componentStyle = Object.fromEntries(
                    Object.entries(this.componentStyle).filter(([key, _]) => !BorderVariationKeys.includes(key))
                );
                const { border } = parseCss({ css: this.componentStyle });
                this.border = border;
                this.$emit('prop-was-changed', this.componentStyle);
                return;
            }
            if (key === BorderKey.TOP_BORDER) {
                this.componentStyle[CssStyleName.BORDER_TOP] = `${this.border.topWidth} ${this.border.topType} ${
                    this.border.topColor ?? DEFAULT_COLOR
                }`;
                this.componentStyle = filterObjectByKey(this.componentStyle, CssStyleName.BORDER);
            }
            if (key === BorderKey.LEFT_BORDER) {
                this.componentStyle[CssStyleName.BORDER_LEFT] = `${this.border.leftWidth} ${this.border.leftType} ${
                    this.border.leftColor ?? DEFAULT_COLOR
                }`;
                this.componentStyle = filterObjectByKey(this.componentStyle, CssStyleName.BORDER);
            }
            if (key === BorderKey.BOTTOM_BORDER) {
                this.componentStyle[CssStyleName.BORDER_BOTTOM] = `${this.border.bottomWidth} ${
                    this.border.bottomType
                } ${this.border.bottomColor ?? DEFAULT_COLOR}`;
                this.componentStyle = filterObjectByKey(this.componentStyle, CssStyleName.BORDER);
            }
            if (key === BorderKey.RIGHT_BORDER) {
                this.componentStyle[CssStyleName.BORDER_RIGHT] = `${this.border.rightWidth} ${this.border.rightType} ${
                    this.border.rightColor ?? DEFAULT_COLOR
                }`;
                this.componentStyle = filterObjectByKey(this.componentStyle, CssStyleName.BORDER);
            }
            const { border } = parseCss({ css: this.componentStyle });
            this.border = border;
            this.$emit('prop-was-changed', this.componentStyle);
        },
        borderRadiusHandler(key) {
            if (key === RADIUS_NAME) {
                this.componentStyle[CssStyleName.BORDER_RADIUS] = this.border.radius;
                this.border = merge(this.border, {
                    topRightRadius: '',
                    topLeftRadius: '',
                    bottomLeftRadius: '',
                    bottomRightRadius: ''
                });
                this.$emit('prop-was-changed', this.componentStyle);
                return;
            }
            this.border = merge(this.border, { radius: '' });
            this.componentStyle[CssStyleName.BORDER_RADIUS] = `${this.border.topLeftRadius || 0} ${
                this.border.topRightRadius || 0
            } ${this.border.bottomRightRadius || 0} ${this.border.bottomLeftRadius || 0}`;
            this.$emit('prop-was-changed', this.componentStyle);
        },
        boxShadowHandler() {
            const boxShadow = `${this.boxShadow.offsetX} ${this.boxShadow.offsetY} ${this.boxShadow.blurRadius} ${this.boxShadow.spreadRadius} ${this.boxShadow.color}`;
            this.boxShadow.type === BoxShadowType.INSET
                ? (this.componentStyle[CssStyleName.BOX_SHADOW] = `${BoxShadowType.INSET} ${boxShadow}`)
                : (this.componentStyle[CssStyleName.BOX_SHADOW] = boxShadow);
            this.$emit('prop-was-changed', this.componentStyle);
        },
        mutateBackgroundProps() {
            this.componentStyle.background = this.backgrounds
                .filter(({ output }) => output !== '')
                .map(({ output }) => output)
                .join(', ');
            if (this.backgrounds.length === 0) {
                this.componentStyle = filterObjectByKey(this.componentStyle, CssStyleName.BACKGROUND);
            }
            this.$emit('prop-was-changed', this.componentStyle);
        },
        moveBackgrounds() {
            this.mutateBackgroundProps();
        },
        addBackground() {
            this.backgrounds.push(backgroundFactory());
        },
        deleteBackground(index) {
            this.backgrounds.splice(index, 1);
            this.mutateBackgroundProps();
        },
        transformAngleHandler() {
            this.componentStyle.transform = `${ROTATE_NAME}(${this.transformAngle}deg)`;
            this.$emit('prop-was-changed', this.componentStyle);
        },
        onStylePropChanged(styleName) {
            this.componentStyle[styleName] = this.primitiveStyle[styleName];
            this.componentStyle = Object.fromEntries(Object.entries(this.componentStyle).filter(([_, v]) => v !== ''));
            this.$emit('prop-was-changed', this.componentStyle);
        },
        resolveCssStyle() {
            const { backgrounds, primitiveStyle, border, boxShadow, transformAngle } = parseCss({
                css: this.componentStyle
            });
            this.backgrounds = backgrounds;
            this.primitiveStyle = primitiveStyle;
            this.border = border;
            this.boxShadow = boxShadow;
            this.transformAngle = transformAngle;
        }
    }
};
</script>

<style lang="less" scoped>
.border-wrapper {
    display: flex;
}
.border-sides {
    margin-right: 10px;
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    grid-template-rows: 1fr 1fr 1fr;
    gap: 5px 5px;
    grid-template-areas:
        '. b .'
        'a e c'
        '. d .';
    &__img {
        cursor: pointer;
    }
}
.border-radiuses-options {
    display: grid;
    grid-template-columns: 1fr 1fr;
    margin-right: 2rem;
    gap: 10px;
    &__img {
        cursor: pointer;
    }
}
.border-radiuses-wrapper {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
}
.border-radiuses {
    display: grid;
    grid-template-columns: auto 1fr;
    &__img {
        margin-right: 0.5rem;
    }
}
</style>
