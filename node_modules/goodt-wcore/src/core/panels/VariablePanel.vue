<template>
    <w-panel>
        <ui-header-actions @clear="onClear" @restore="onRestore" class="w-100">
        </ui-header-actions>
        <template v-for="(variables, scope) in varsGroups">
            <template v-if="variables.length > 0">
                <div :key="scope" class="scope">
                    <component v-if="scopeTitles[scope]" v-bind="scopeTitles[scope]" class="mar-bot-2"></component>
                    <ui-has-panel
                        v-for="{ name, alias, description, scopes, ...rest } in variables"
                        :key="name"
                        :icon="null">
                        <template #default="{ toggle }">
                            <div class="list-item" @click="toggle">
                                <div class="d-flex">
                                    <i
                                        class="mdi mdi-arrow-down"
                                        :class="{ 'text-muted': !alias.listen }"
                                        :title="`слушает: ${alias.listen}`" />
                                    <i
                                        class="mdi mdi-arrow-up"
                                        :class="{ 'text-muted': !alias.trigger }"
                                        :title="`пишет: ${alias.trigger}`" />
                                </div>
                                <div class="list-item__text">
                                    <component
                                        v-bind="resolveBadge({ name, alias, description, scopes, ...rest })"></component>
                                </div>
                                <template v-if="alias.listen || alias.trigger">
                                    <i
                                        class="mdi cursor-pointer"
                                        :class="{
                                            'mdi-earth-off color-grey': !alias.meta.global,
                                            'mdi-earth color-primary': alias.meta.global
                                        }"
                                        :title="$t(alias.meta.global ? 'global' : 'local')"
                                        @click.stop="toggleAliasMetaGlobal(alias)"></i>
                                </template>
                                <template v-else>
                                    <i class="mdi mdi-earth color-muted" :title="$t('disabled')"></i>
                                </template>
                            </div>
                        </template>
                        <template #panel>
                            <ui-panel
                                :groups="[
                                    {
                                        name,
                                        slot: 'default'
                                    }
                                ]">
                                <template #header>
                                    <component
                                        v-bind="
                                            resolveBadge({ name, alias, description, scopes, ...rest })
                                        "></component>
                                </template>
                                <div v-if="name !== description" class="text-small p">
                                    {{ description }}
                                </div>
                                <ui-input v-model.lazy="alias.listen" class="p" @change="exportAliases">
                                    Читает
                                    <i class="mdi mdi-arrow-down" />
                                </ui-input>
                                <ui-input v-model.lazy="alias.trigger" @change="exportAliases">
                                    Пишет
                                    <i class="mdi mdi-arrow-up" />
                                </ui-input>
                            </ui-panel>
                        </template>
                    </ui-has-panel>
                </div>
            </template>
        </template>
    </w-panel>
</template>
<script>
import { isEqual } from 'lodash';
import { Panel } from '@goodt-wcore/panel';
import { normalizeDescriptorFormat } from '@goodt-wcore/elem';
import { ValueObject } from '@goodt-wcore/managers';
import { Badge as UiBadge, ScopeTitle as UiScopeTitle, HeaderActions as UiHeaderActions } from './components';

/**
 * @typedef {import('@goodt-wcore/elem').ElemDescriptorVarAlias} ElemDescriptorVarAlias
 * @typedef {import('@goodt-wcore/elem').ElemDescriptorVarMetasMap} ElemDescriptorVarMetasMap
 * @typedef {{ alias: ElemDescriptorVarAlias, scopes?: string[], name: string, description?: string, type?: string | null}} VariableModel
 *
 */

/**
 * Var alias factory
 * @param {ElemDescriptorVarAlias} input
 * @return {ElemDescriptorVarAlias}
 */
const varAlias = ({ listen = '', trigger = '', meta = null } = {}) => ({
    listen,
    trigger,
    meta: meta ?? ValueObject.defaultMeta()
});

export default {
    extends: Panel,
    components: {
        UiBadge,
        UiScopeTitle,
        UiHeaderActions
    },
    implicitCssModule: true,

    meta: {
        name: 'variables',
        icon: 'variable-box',
        isMuted: ({ descriptor }) => Object.keys(descriptor.vars).length === 0,
        index: 300
    },

    data() {
        return {
            /**
             * @type {ElemDescriptorVarMetasMap}
             */
            descriptorVars: {},
            scopes: [],
            hasRestore: false
        };
    },
    computed: {
        /**
         *
         * @return {Record<string, VariableModel[]>}
         */
        varsGroups() {
            const { varAliases } = this.props;
            const varInfos = Object.entries(this.descriptorVars).flatMap(([name, { type, scopes, ...restVarDefinition }]) => {
                const info = {
                    name,
                    scopes,
                    ...restVarDefinition,
                    alias: varAlias({
                        ...varAliases[name]
                    }),
                    type: type != null ? type.name.toLowerCase() : null
                };

                if (scopes === undefined) {
                    scopes = [undefined];
                }

                return scopes.map((scope) => ({ ...info, scope }));
            });

            const varGroupsByScope = Object.groupBy(varInfos, ({ scope }) => scope);

            const varGroupsByScopePairs = Object.entries(varGroupsByScope).map(([scope, variableInfos]) => {
                const sort = this.createSortVariableInfos(scope);
                variableInfos.sort(sort);
                return [scope, variableInfos];
            }).sort(([scope]) => scope === 'undefined' ? Number.NEGATIVE_INFINITY : 0);

            return Object.fromEntries(varGroupsByScopePairs);
        },
        scopeTitles() {
            return Object.keys(this.varsGroups).reduce((acc, scope) => {
                const bindData = this.resolveScopeTitle(scope);
                return {
                    ...acc,
                    ...bindData && { [scope]: bindData }
                };
            }, {});
        }
    },
    watch: {
        'elementInstance.descriptor.vars': {
            handler() {
                this.descriptorVars = this.getDescriptorVars();
            },
            immediate: true
        },
        varsGroups: {
            handler(varsGroups) {
                this.scopes = Object.keys(varsGroups);
            },
            immediate: true
        }
    },
    methods: {
        /**
         *
         * @return {ElemDescriptorVarMetasMap}
         */
        getDescriptorVars() {
            return {
                ...normalizeDescriptorFormat(this.descriptor).vars,
                ...this.elementInstance?.descriptor.vars
            };
        },
        exportAliases() {
            this.props.varAliases = Object.values(this.varsGroups)
                .flat()
                .reduce((acc, { name, alias }) => {
                    const { listen, trigger, meta } = alias;
                    if (listen === '' && trigger === '') {
                        return acc;
                    }
                    return {
                        ...acc,
                        [name]: {
                            ...(listen && { listen }),
                            ...(trigger && { trigger }),
                            ...(isEqual(meta, ValueObject.defaultMeta()) || { meta })
                        }
                    };
                }, {});

            this.$storeMeta.saveVars();
        },
        clearVarAliases() {
            this.props.varAliases = {};
            this.$storeMeta.saveVars();
        },
        /**
         * @param {ElemDescriptorVarAlias} alias
         */
        toggleAliasMetaGlobal(alias) {
            alias.meta.global = !alias.meta.global;
            this.exportAliases();
        },
        /**
         * to extend in descendants
         * @param {VariableModel} variable
         * @return {{description: string, is: object, text: string, type: string}}
         */
        resolveBadge(variable) {
            return {
                is: this.$options.components.UiBadge,
                text: variable.name,
                description: this.$t(variable.description),
                type: 'default'
            };
        },
        /**
         * to extend in descendants
         * @param {string} scope
         * @return {null}
         */
        resolveScopeTitle(scope) {
            return null;
        },
        /**
         * @param {string} scope
         * @return {function(a, b): number}
         */
        createSortVariableInfos(scope) {
            return (a, b) => 0;
        },
        /**
         *
         */
        onClear() {
            this.clearVarAliases();
        },
        /**
         *
         */
        onRestore() {
           /* to implement */
        }
    }
};
</script>
<style module>
.scope {
    composes: d-flex flex-col mar-bot-4 gap-1 0.5 pad-h-2 from global;
}

.scope + .scope {
    margin-top: var(--spacer4);
}

@b list-item {
    display: grid;
    grid-template-columns: auto 1fr auto;
    composes: cursor-pointer gap-2 from global;
    @e text {
        composes: overflow-hidden w-100 from global;
    }
}
</style>
