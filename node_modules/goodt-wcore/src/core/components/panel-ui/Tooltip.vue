<template>
    <ui-has-panel>
        <ui-checkbox v-model="model.isEnabled">Настраиваемый тултип</ui-checkbox>

        <template #panel>
            <ui-panel :groups="TooltipPanelGroups">
                <template #settings>
                    <ui-container>
                        <ui-switch v-model="model.isSlotShown">Отобразить слот</ui-switch>
                        <ui-collapse>
                            <template #header>Настройки заголовка</template>
                            <ui-container>
                                <ui-input v-model.trim="model.title.text">Заголовок тултипа</ui-input>
                                <ui-select v-model="model.title.textAlign" :options="TextAlignOptions">
                                    Выравнивание заголовка
                                </ui-select>
                                <ui-input-cp v-model="model.title.color">Цвет заголовка</ui-input-cp>
                                <ui-input-units v-model="model.title.fontSize" :units="SizeUnits">
                                    Размер заголовка
                                </ui-input-units>
                                <ui-input v-model="model.title.fontFamily">Шрифт заголовка</ui-input>
                                <ui-select v-model="model.title.fontWeight" :options="FontWeightOptions">
                                    Насыщенность шрифта заголовка
                                </ui-select>
                            </ui-container>
                        </ui-collapse>

                        <ui-collapse>
                            <template #header>Настройки тултипа</template>
                            <ui-container>
                                <ui-switch v-model="model.shouldFollowPointer">Следовать за курсором</ui-switch>
                                <ui-switch v-model="model.shouldRespondToPointerEvents">
                                    <span class="text-xsmall">Реагировать на события курсора</span>
                                </ui-switch>
                                <ui-select v-model="model.position" :options="TooltipPositionOptions">
                                    Позиция тултипа
                                </ui-select>
                                <ui-input v-model.number="model.positionOffsets[1]" type="number">
                                    Вертикальный внешний отступ
                                </ui-input>
                                <ui-input v-model.number="model.positionOffsets[0]" type="number">
                                    Горизонтальный внешний отступ
                                </ui-input>
                                <ui-input-units v-model="model.style.vPadding" :units="SizeUnits">
                                    Вертикальный внутренний отступ
                                </ui-input-units>
                                <ui-input-units v-model="model.style.hPadding" :units="SizeUnits">
                                    Горизонтальный внутренний отступ
                                </ui-input-units>
                                <ui-input-cp v-model="model.style.backgroundColor">Цвет фона</ui-input-cp>
                                <ui-input-units v-model="model.style.borderWidth" :units="BorderWidthUnits">
                                    Толщина границы
                                </ui-input-units>
                                <ui-input-cp v-model="model.style.borderColor">Цвет границы</ui-input-cp>
                                <ui-select v-model="model.style.borderStyle" :options="BorderStyleOptions">
                                    Стиль границы
                                </ui-select>
                                <ui-input-units v-model="model.style.borderRadius" :units="BorderWidthUnits">
                                    Скругление углов
                                </ui-input-units>
                                <ui-input v-model="model.style.boxShadow">Тень</ui-input>
                            </ui-container>
                        </ui-collapse>
                        <slot></slot>
                    </ui-container>
                </template>
                <template #data>
                    <ui-draggable v-if="model.data.length > 0" v-model="model.data" handle=".drag-handle" class="p">
                        <ui-collapse v-for="(item, idx) of model.data" :key="idx" class="p">
                            <template #header>
                                <span class="icon drag-handle mar-right-3 cursor-move">
                                    <i class="mdi mdi-drag mdi-18px"></i>
                                </span>
                                <span>{{ item.value }}</span>
                            </template>
                            <ui-container>
                                <ui-select v-model="item.value" :options="options">Значение</ui-select>
                                <ui-select v-model="item.type" :options="TooltipDataItemValueTypeOptions">
                                    Тип значения
                                </ui-select>
                                <ui-input v-model="item.outputFormat">
                                    <ui-hint>
                                        <template #label>Формат вывода</template>
                                        <div>Где:</div>
                                        <div>{n} - наименование выбранного значения</div>
                                        <div>{v} - его фактическое значение</div>
                                    </ui-hint>
                                </ui-input>
                                <ui-select v-model="item.style.textAlign" :options="TextAlignOptions">
                                    Выравнивание
                                </ui-select>
                                <ui-input-cp v-model="item.style.color">Цвет</ui-input-cp>
                                <ui-input-units v-model="item.style.fontSize" :units="SizeUnits">Размер</ui-input-units>
                                <ui-input v-model="item.style.fontFamily">Шрифт</ui-input>
                                <ui-select v-model="item.style.fontWeight" :options="FontWeightOptions">
                                    Насыщенность шрифта
                                </ui-select>
                                <template v-if="item.type === TooltipDataItemValueType.NUMBER">
                                    <ui-number-format v-model="item.valueFormat">Формат числа</ui-number-format>
                                    <ui-switch v-model="item.shouldShowSign">Положительные числа</ui-switch>
                                </template>
                                <template v-if="item.type === TooltipDataItemValueType.DATE">
                                    <ui-input v-model="item.valueFormat">Формат даты</ui-input>
                                </template>

                                <ui-has-panel>
                                    <div class="form-label form-label-small">Префикс/Постфикс</div>
                                    <template #panel>
                                        <ui-panel :groups="PrfPsfGroups">
                                            <template v-for="({ slot, option }) of PrfPsfGroups" #[slot]>
                                                <ui-container :key="option">
                                                    <ui-input v-model="item[option].value">Значение</ui-input>
                                                    <ui-input-cp v-model="item[option].color">Цвет</ui-input-cp>
                                                    <ui-input-units v-model="item[option].fontSize" :units="SizeUnits">
                                                        Размер
                                                    </ui-input-units>
                                                    <ui-input v-model="item[option].fontFamily">Шрифт</ui-input>
                                                    <ui-select
                                                        v-model="item[option].fontWeight"
                                                        :options="FontWeightOptions">
                                                        Насыщенность шрифта
                                                    </ui-select>
                                                    <ui-input-units v-model="item[option].offset" :units="SizeUnits">
                                                        Отступ
                                                    </ui-input-units>
                                                </ui-container>
                                            </template>
                                        </ui-panel>
                                    </template>
                                </ui-has-panel>

                                <ui-button type="error" @click="removeTooltipDataItem(idx)">Удалить</ui-button>
                            </ui-container>
                        </ui-collapse>
                    </ui-draggable>
                    <ui-button @click="addTooltipDataItem">Добавить значение</ui-button>
                </template>
                <template #vars>
                    <ui-select v-if="hasWidgetDataset" v-model="tooltipVars" :options="options" multiple>
                        Измерения/метрики
                    </ui-select>
                    <ui-container v-else>
                        <div v-for="(fieldName, varName) in tooltipVars" :key="varName" class="row row-gap-1">
                            <div class="col col-vmid">
                                <ui-input :value="varName" @change="setVariable(varName, $event)">Переменная</ui-input>
                            </div>
                            <div class="col col-5-12 col-vmid">
                                <ui-select
                                    :value="fieldName"
                                    :options="options"
                                    @change="setFieldName(varName, $event)">
                                    Поле датасета
                                </ui-select>
                            </div>
                            <div class="col col-auto col-vbot">
                                <ui-button type="error" icon @click="removeVariable(varName)">
                                    <i class="mdi mdi-trash-can-outline mdi-18px"></i>
                                </ui-button>
                            </div>
                        </div>
                        <ui-button @click="addVariable">Добавить переменную</ui-button>
                    </ui-container>
                </template>
            </ui-panel>
        </template>
    </ui-has-panel>
</template>

<script>
import UiDraggable from 'vuedraggable';
import { cloneDeep } from 'lodash';

import { ControlMixin, ObjectControlMixin } from './utils';
import UiButton from './Button.vue';
import UiCheckbox from './Checkbox.vue';
import UiCollapse from './Collapse.vue';
import UiInput from './Input.vue';
import UiInputCp from './InputCp.vue';
import UiInputUnits from './InputUnits.vue';
import UiNumberFormat from './NumberFormat.vue';
import UiPanel from './Panel.vue';
import UiSelect from './Select.vue';
import UiSwitch from './Switch.vue';
import UiHasPanel from './HasPanel.vue';
import UiContainer from './Container.vue';
import UiHint from './Hint.vue';

import { TooltipDefaultFactory, TooltipDataItemFactory } from '../ui/tooltip/utils';
import { TooltipDataItemValueType } from '../ui/tooltip/constants';
import * as Config from '../ui/tooltip/config';

export default {
    components: {
        UiHasPanel,
        UiPanel,
        UiCollapse,
        UiCheckbox,
        UiButton,
        UiInput,
        UiInputCp,
        UiInputUnits,
        UiNumberFormat,
        UiSelect,
        UiSwitch,
        UiDraggable,
        UiContainer,
        UiHint
    },
    mixins: [ControlMixin, ObjectControlMixin],
    props: {
        options: {
            type: Array,
            default: () => []
        }
    },
    computed: {
        hasWidgetDataset() {
            return this.panel?.elementInstance?.hasDataset ?? null;
        },
        tooltipVars: {
            get() {
                const { vars } = this.model;
                if (this.hasWidgetDataset == null) {
                    return vars;
                }
                return Array.isArray(vars) ? vars : Object.values(vars);
            },
            set(vars) {
                this.model.vars = Array.isArray(vars)
                    ? vars.reduce((acc, varName) => ({ ...acc, [varName]: varName }), {})
                    : vars;
            }
        }
    },
    static: { ...Config, TooltipDataItemValueType },
    methods: {
        /**
         * @public
         */
        createSettings(settings = TooltipDefaultFactory()) {
            return cloneDeep(settings);
        },
        addTooltipDataItem() {
            this.model.data.push(TooltipDataItemFactory());
        },
        removeTooltipDataItem(index) {
            this.model.data.splice(index, 1);
        },
        addVariable() {
            const NEW_VAR = 'newVar';

            if (this.canSetVariable(NEW_VAR)) {
                this.$set(this.model.vars, NEW_VAR, null);
            }
        },
        canSetVariable(newVarName) {
            return Object.keys(this.model.vars).some((varName) => varName === newVarName) === false;
        },
        setVariable(varName, newVarName) {
            const { [varName]: changedVarValue } = this.model.vars;

            if (this.canSetVariable(newVarName)) {
                this.$set(this.model.vars, newVarName, changedVarValue);
                this.removeVariable(varName);
                return;
            }
            // необходимо для того, чтобы инпут показывал реальное значение,
            // если по факту переменная не была переименована
            this.model.vars = { ...this.model.vars };
        },
        setFieldName(varName, fieldName) {
            this.$set(this.model.vars, varName, fieldName);
        },
        removeVariable(varName) {
            this.$delete(this.model.vars, varName);
        }
    }
};
</script>
