<template>
    <div>
        <div class="row row-collapse">
            <div class="col col-vmid">
                <div class="form-label form-label-small text-truncate">
                    <!--
                    @slot label slot
                    -->
                    <slot />
                </div>
            </div>
            <div class="col col-auto col-vmid">
                <div class="icon cursor-pointer color-grey" @click="isPopupOpen = true">
                    <i class="mdi mdi-pencil" />
                </div>
            </div>
        </div>
        <ui-popup :visible.sync="isPopupOpen" fullscreen>
            <template #close="{ close }">
                <div class="d-flex flex-h-end pad-l2 pad-bot-none">
                    <button class="btn btn-ghost shadow mar-right-l1" @click="onCancel(close)">Отменить</button>
                    <button class="btn btn-primary" @click="onSave(close)">Сохранить</button>
                </div>
            </template>
            <template #body>
                <div class="d-flex flex-col h-100">
                    <ul class="tabs mar-bot-l1">
                        <li :class="{ active: activeTab === Tab.WYSIWYG }">
                            <a href="#" @click.prevent="activeTab = Tab.WYSIWYG">Редактор</a>
                        </li>
                        <li :class="{ active: activeTab === Tab.RAW_HTML }">
                            <a href="#" @click.prevent="activeTab = Tab.RAW_HTML">HTML</a>
                        </li>
                    </ul>
                    <keep-alive>
                        <ui-wysiwyg-editor
                            v-if="activeTab === Tab.WYSIWYG"
                            :class="controlCl"
                            class="w-100 flex-grow"
                            v-bind="editorOptions"
                            v-on="listeners">
                            <!--
                            @slot toolbar slot
                            @binding {Array[]} toolGroups               array of using tools
                            @binding {Function} buildToolBinds          build tool binds function(tool:Record<string,any>)
                            -->
                            <template #toolbar="{ toolGroups, buildToolBinds }">
                                <slot name="toolbar" v-bind="{ toolGroups, buildToolBinds }" />
                            </template>
                            <!--
                            @slot group header slot
                            @binding {number} groupIndex                index of the tools group
                            @binding {string} title                     tools group title
                            -->
                            <template #group-header="{ groupIndex, title }">
                                <slot name="group-header" v-bind="{ groupIndex, title }" />
                            </template>
                            <!--
                            @slot tool slot
                            @binding {Record<string, any>} tool         tool already bound to editor context
                            -->
                            <template #tool="tool">
                                <slot name="tool" v-bind="tool" />
                            </template>
                        </ui-wysiwyg-editor>
                        <textarea
                            v-else
                            ref="textarea"
                            v-bind="attrs"
                            class="textarea textarea-small h-100 w-100"
                            @change="onTextareaChange"/>
                    </keep-alive>
                </div>
            </template>
        </ui-popup>
    </div>
</template>

<script>
import { FileManager } from '@goodt-wcore/managers';
import { WysiwygEditor as UiWysiwygEditor } from 'goodteditor-ui';
import { Popup as UiPopup } from '../ui';

import { ControlMixin } from './utils';

const Tab = {
  WYSIWYG: 'wysiwyg',
  RAW_HTML: 'raw html'
};

export default {
    components: {
        UiPopup,
        UiWysiwygEditor
    },
    mixins: [ControlMixin],
    props: {
        /** @public  */
        // eslint-disable-next-line vue/no-unused-properties
        tools: {
            type: Array,
            default: () => []
        },
    },
    data: () => ({
        isPopupOpen: false,
        valueOriginal: null,
        activeTab: Tab.WYSIWYG
    }),
    static: {
        Tab
    },
    computed: {
        editorOptions() {
            return {
                ...this.attrs,
                getImageUrl: this.getImageUrl,
                editorContent: { class: ['h-100', 'pad-3', 'scroll-y'] }
            };
        }
    },
    watch: {
        isPopupOpen(isOpen) {
            if (isOpen) {
                this.valueOriginal = this.value;
            }
        },
        activeTab(activeTab) {
            if (activeTab === Tab.RAW_HTML) {
                this.$nextTick(() => {
                    this.$refs.textarea.focus();
                });
            }
        }
    },
    methods: {
        async getImageUrl() {
            const [file] = await FileManager.instance
                .browse({ selectEnabled: true, selectMultiple: false });

            return file?.url ?? null;
        },
        onTextareaChange(event) {
            const { value } = event.target;

            this.onInput(value);
            this.onChange(value);
        },
        onCancel(close) {
            const { valueOriginal } = this;

            this.onInput(valueOriginal);
            this.onChange(valueOriginal);

            close();
        },
        onSave(close) {
            const { value } = this;

            this.onInput(value);
            this.onChange(value);

            close();
        }
    }
};
</script>
