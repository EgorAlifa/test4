<template>
    <div>
        <ui-draggable v-model="model" v-bind="DragOptions">
            <ui-collapse v-for="(item, index) in model" :key="index" class="collapse">
                <template #heading="{ isOpen, toggle }">
                    <div class="row row-collapse row-hgap-1">
                        <div class="col col-auto col-vmid">
                            <div class="icon w-auto opacity-60 drag-handle">
                                <i class="mdi mdi-drag mdi-18px" />
                            </div>
                        </div>
                        <div class="col col-auto col-vmid">
                            <div class="icon w-auto opacity-60">
                                <i class="mdi mdi-chevron-right" :class="{ 'mdi-rotate-90': isOpen }" />
                            </div>
                        </div>
                        <div class="col col-vmid text-small text-truncate">
                            <slot name="header" v-bind="{ isOpen, toggle, item, index }"></slot>
                        </div>
                        <div class="col col-auto col-vmid">
                            <div
                                v-if="isShownToolbox"
                                class="icon w-auto opacity-60"
                                @click.stop="showPopoverState({ target: $event.target, index })">
                                <i class="mdi mdi-dots-vertical mdi-18px" />
                            </div>
                        </div>
                    </div>
                </template>
                <slot v-bind="{ item, index }">
                    <pre>{{ item }}</pre>
                </slot>
            </ui-collapse>
        </ui-draggable>
        <ui-popover v-bind="popovertBinds" :show.sync="isShownPopover">
            <div class="menu menu-small">
                <ul>
                    <template v-for="({ label, icon, handler }, index) in toolbox">
                        <li v-if="index !== 0" :key="'hr' + index">
                            <hr />
                        </li>
                        <li :key="index">
                            <a href="#" @click.stop="performPopoverHandler(handler)">
                                <i class="mdi mar-right-2" :class="icon" />
                                <span>{{ label }}</span>
                            </a>
                        </li>
                    </template>
                </ul>
            </div>
        </ui-popover>
    </div>
</template>

<style lang="pcss" scoped>
.collapse {
    & + & {
        margin-top: var(--spacer4);
    }
}
</style>

<script>
import { cloneDeep } from 'lodash';
import UiDraggable from 'vuedraggable';
import { Popover as UiPopover } from 'goodteditor-ui';
import { ControlMixin, ObjectControlMixin } from './utils';
import UiCollapse from './Collapse.vue';

const DragOptions = {
    handle: '.drag-handle',
    animation: 500
};

export default {
    components: { UiDraggable, UiCollapse, UiPopover },
    mixins: [ControlMixin, ObjectControlMixin],
    static: {
        DragOptions
    },
    props: {
        /**
         * @model
         *
         * Options Array[any]
         */
        value: {
            type: Array,
            default: () => []
        },
        /**
         * Allow toolbox to be displayed
         */
        isShownToolbox: {
            type: Boolean,
            default: true
        },
        /**
         * Options Array[Object] ~ [ { icon:'', label: '', handler: (index) => {} } ]
         */
        toolboxControls: {
            type: Array,
            default: () => []
        }
    },
    data: () => ({
        popoverTarget: null,
        popoverIndex: null,
        isShownPopover: false
    }),
    computed: {
        popovertBinds() {
            return {
                target: this.popoverTarget,
                appendToBody: true,
                autoWidth: false,
                position: 'bottom-end'
            };
        },
        toolbox() {
            return this.toolboxControls.length > 0
                ? this.toolboxControls
                : [
                      { icon: 'mdi-minus-box-outline', label: 'Удалить', handler: this.remove },
                      { icon: 'mdi-content-copy', label: 'Копировать', handler: this.copy }
                  ];
        }
    },
    methods: {
        /** @public */
        createSettings(settings = []) {
            return [...settings];
        },
        showPopoverState({ index, target }) {
            this.popoverTarget = target;
            this.popoverIndex = index;
            this.isShownPopover = index != null;
        },
        performPopoverHandler(handler) {
            handler(this.popoverIndex);
            this.isShownPopover = false;
        },
        remove(index) {
            this.model.splice(index, 1);
        },
        copy(index) {
            this.model.splice(index, 0, cloneDeep(this.model[index]));
        }
    }
};
</script>
