<template>
    <div>
        <div class="row row-hgap-3">
            <div class="col col-vmid">
                <!--
                @slot content slot
                -->
                <slot v-bind="{ toggle: togglePanel }"/>
            </div>
            <div v-if="icon" class="col col-auto col-vmid">
                <i
                    class="mdi cursor-pointer"
                    :class="[showPanel ? '' : 'color-grey', `mdi-${icon}`]"
                    @click="togglePanel" />
            </div>
        </div>
        <ui-portal>
            <div
                v-if="showPanel"
                ref="panel"
                class="panel"
                :class="panelClass"
                :style="panelStyle"
                tabindex="0"
                @mousedown="onPanelMouseDown">
                <div class="pos-rel">
                    <div class="panel-dragger d-flex flex-center" @mousedown="onPanelDraggerMouseDown" />
                    <div class="close pos-abs pos-top-right mar-2" @click="togglePanel">
                        <i class="mdi mdi-close color-grey" />
                    </div>
                </div>

                <div ref="panelbody" class="panel-body pad-top-none">
                    <!--
                    @slot panel slot (accepts <a href="#panel">Panel</a> instance as a child)
                    -->
                    <slot name="panel" />
                </div>
            </div>
        </ui-portal>
    </div>
</template>
<script>
import { Portal as UiPortal } from '../ui';

const mouse = (e) => ({ x: e.pageX, y: e.pageY });
let ID = 1;

export default {
    components: {
        UiPortal
    },
    props: {
        /**
         * Panel x/y offset
         */
        panelOffset: {
            type: Object,
            default() {
                return { x: 10, top: 0 };
            }
        },
        /**
         * Auto width
         */
        autoWidth: {
            type: Boolean,
            default: false
        },
        icon: {
            type: String,
            default: 'pencil'
        }
    },
    data() {
        return {
            panelId: `panel${ID++}`,
            showPanel: false,
            animatePanel: false,
            panelPos: { x: 0, y: 0 },
            panelDragOffset: { x: 0, y: 0 },
            panelDragging: false,
            panelHasFocus: false
        };
    },
    computed: {
        panelClass() {
            const { animatePanel, panelHasFocus, autoWidth } = this;
            return { animate: animatePanel, focus: panelHasFocus, 'width-auto': autoWidth };
        },
        panelStyle() {
            const { x, y } = this.panelPos;
            return {
                left: `${x | 0}px`,
                top: `${y | 0}px`
            };
        }
    },
    created() {
        this.observer = null;
    },
    destroyed() {
        this.destroyObserver();
        this.removeMouseListeners();
        this.removeWinListeners();
        this.removeFocusListeners();
    },
    methods: {
        addFocusListeners() {
            document.addEventListener('focus', this.onDocFocusin);
            document.addEventListener('focusin', this.onDocFocusin);
        },
        removeFocusListeners() {
            document.removeEventListener('focus', this.onDocFocusin);
            document.removeEventListener('focusin', this.onDocFocusin);
        },
        addMouseListeners() {
            document.addEventListener('mousemove', this.onDocMouseMove);
            document.addEventListener('mouseup', this.onDocMouseUp);
        },
        removeMouseListeners() {
            document.removeEventListener('mousemove', this.onDocMouseMove);
            document.removeEventListener('mouseup', this.onDocMouseUp);
        },
        addWinListeners() {
            window.addEventListener('resize', this.onWinResize, { passive: true });
        },
        removeWinListeners() {
            window.removeEventListener('resize', this.onWinResize);
        },
        createObserver() {
            if (this.observer) {
                return;
            }
            const cfg = { attributes: true, childList: true, subtree: true };
            this.observer = new MutationObserver(() => this.$nextTick(this.fixPanelPos));
            this.observer.observe(this.$refs.panelbody, cfg);
        },
        destroyObserver() {
            if (this.observer) {
                this.observer.disconnect();
                this.observer = null;
            }
        },
        togglePanel() {
            this.showPanel = !this.showPanel;
            this.destroyObserver();
            this.removeWinListeners();
            if (this.showPanel) {
                this.animatePanel = false;
                // @NOTE @see https://portal-vue.linusb.org/guide/caveats.html#refs
                this.$nextTick(() => {
                    this.$nextTick(() => {
                        this.placePanelInitPos();
                        this.createObserver();
                        this.addFocusListeners();
                        this.panelHasFocus = true;
                    });
                });
                this.addWinListeners();
            } else {
                this.removeFocusListeners();
            }

        },
        placePanelInitPos() {
            const r = this.$el.getBoundingClientRect();
            const p = this.$refs.panel.getBoundingClientRect();
            this.panelPos.x = r.x - p.width - this.panelOffset.x;
            this.panelPos.y = r.y + r.height / 2 - p.height / 2;
            setTimeout(() => {
                this.animatePanel = true;
                this.fixPanelPos();
            });
        },
        fixPanelPos() {
            const r = this.$refs.panel.getBoundingClientRect();
            const { innerWidth: width, innerHeight: height } = window;
            if (r.x < 0) {
                this.panelPos.x = 0;
            } else if (r.right > width) {
                this.panelPos.x = width - r.width;
            }
            if (r.y < 0) {
                this.panelPos.y = 0;
            } else if (r.bottom > height) {
                this.panelPos.y = height - r.height;
            }
        },
        onPanelMouseDown(e) {
            this.$refs.panel.focus();
        },
        onPanelDraggerMouseDown(e) {
            const m = mouse(e);
            const r = e.currentTarget.getBoundingClientRect();
            this.animatePanel = false;
            this.panelDragOffset = { x: r.x - m.x, y: r.y - m.y };
            this.panelDragging = true;
            this.addMouseListeners();
        },
        onDocMouseMove(e) {
            const m = mouse(e);
            this.panelPos = {
                x: m.x + this.panelDragOffset.x,
                y: m.y + this.panelDragOffset.y
            };
        },
        onDocMouseUp(e) {
            this.removeMouseListeners();
            this.animatePanel = true;
            this.panelDragging = false;
            setTimeout(this.fixPanelPos);
        },
        onDocFocusin(e) {
            this.panelHasFocus = this.$refs.panel.contains(e.target);
        },
        onWinResize(e) {
            this.fixPanelPos();
        }
    }
};
</script>
<style lang="less" scoped>
@z: 900;
@w: 20rem;
.panel {
    position: fixed;
    z-index: inherit;
    width: @w;
    &-dragger {
        cursor: move;
        height: 2rem;
    }
    &.animate {
        transition: left 0.25s ease, top 0.25s ease;
    }
    &.focus {
        z-index: @z;
    }
    &.width-auto {
        width: auto;
    }
}
</style>
