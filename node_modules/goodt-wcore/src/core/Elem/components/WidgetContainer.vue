<template functional>
    <component
        v-bind="{
            is: (data.attrs && data.attrs.tag) || 'div',
            ...injections.resolveRootNodeProps({ data, parent, props })
        }"
        v-on="listeners">
        <slot v-if="injections.hasPlaceholder({ data, listeners, parent })" name="placeholder">
            <component
                :is="injections.placeholder"
                v-on="{
                    ...listeners.placeholder && {
                        click: (...args) => listeners.placeholder(...args)
                    }
                }">
                <template #slot v-if="injections.hasSlot({ scopedSlots, parent })">
                    <slot name="slot">
                        <component :is="injections.parentSlotDefault"></component>
                    </slot>
                </template>
                <template>
                    <slot name="placeholder-content">
                        <template v-if="data.attrs && data.attrs.placeholder && typeof data.attrs.placeholder.content === 'string'">
                            {{ parent.$t(data.attrs.placeholder.content) }}
                        </template>
                        <template v-else-if="data.attrs && data.attrs.placeholder && typeof data.attrs.placeholder.content === 'object'">
                            <component :is="data.attrs.placeholder.content"></component>
                        </template>
                    </slot>
                </template>
            </component>
        </slot>
        <template v-if="parent.isEditorMode && scopedSlots['editor-mode'] != null">
            <div class="w-100 d-flex">
                <slot name="editor-mode"></slot>
            </div>
        </template>

        <slot
            v-if="injections.isShowDefaultSlot({ injections, data, listeners, parent })"
            v-bind="injections.resolveRootNodeProps({ data, parent })">
        </slot>
    </component>
</template>

<script>
import WidgetPlaceholder from './WidgetPlaceholder.vue';

export default {
    inject: {
        placeholder: {
            from: Symbol('placeholder'),
            default: WidgetPlaceholder
        },
        hasSlot: {
            from: Symbol('hasSlot'),
            default:
                () =>
                ({ parent: { isChildAllowed, getSlotNames, slotDefault, $scopedSlots }, scopedSlots }) =>
                    $scopedSlots[slotDefault] != null ||
                    (isChildAllowed() && (scopedSlots.slot != null || getSlotNames().includes(slotDefault)))
        },
        resolveRootNodeProps: {
            from: Symbol('resolveRootNodeProps'),
            default:
                () =>
                ({ data: { attrs: { placeholder, ...restAttrs } = {}, style = {}, class: bindClass = '', staticClass = '' }, parent }) => ({
                    class: [parent.cssClass, staticClass].concat([bindClass].flat()),
                    // eslint-disable-next-line no-restricted-syntax
                    style: [parent.cssStyle, style].flat(),
                    iseditormode: undefined,
                    ...restAttrs
                })
        },
        hasPlaceholder: {
            from: Symbol('isPlaceholderMode'),
            default:
                () =>
                ({ data: { attrs: { placeholder } = {} }, listeners, parent }) =>
                    parent.isEditorMode
                    && (typeof placeholder === 'object'
                        ? placeholder?.show === true
                        : [false, null, undefined].includes(placeholder) === false
                    || listeners?.placeholder != null)
        },
        isShowDefaultSlot: {
            from: Symbol('isShowDefaultSlot'),
            default:
                () =>
                ({ injections, data, listeners, parent }) =>
                    data.attrs?.placeholder?.toggle === true
                        ? injections.hasPlaceholder({ data, listeners, parent }) === false
                        : true

        },
        parentSlotDefault: {
            from: Symbol('parentSlotDefault'),
            default: () => ({
                functional: true,
                render: (_, { parent }) => {
                    const { $scopedSlots, slotDefault } = parent;
                    return $scopedSlots[slotDefault]?.() || ['default slot'];
                }
            })
        }
    }
};
</script>
