<template>
    <w-env-emulator v-if="isInitialized" v-bind="{ ...config.emulator, services: config.services }" ref="emulator">
        <template #header>
            <button class="btn btn-ghost pull-right" @click="toggleStorePopup">store</button>
            <button class="btn btn-ghost pull-right" @click="toggleEventBusPopup">eventbus</button>
            <button class="btn pull-right" :class="{ 'btn-ghost': isPanelsVisible }" @click="togglePanels">
                panels
            </button>
            <button
                class="btn btn-primary pull-right"
                :class="{ 'btn-primary': $root.isEditorMode, 'btn-success': $root.isEditorMode === false }"
                @click="toggleEditorMode">
                {{ $root.isEditorMode ? 'editor ' : 'player' }}
            </button>
            <ui-portal-target name="header-right-area" class="pull-right mar-right-l1"></ui-portal-target>
            <ui-popup :visible.sync="isStorePopupOpen">
                <template #body>
                    <div class="w-f2">
                        <div class="p">
                            <ui-textarea v-model="store.stateJson" :invalid="store.error != null">
                                store.state json
                            </ui-textarea>
                            <div class="alert alert-error" v-if="store.error" @click="store.error = null">
                                <div class="alert-body text-xsmall">{{ store.error }}</div>
                            </div>
                        </div>
                        <ui-button @click="storeCommit">commit</ui-button>
                    </div>
                </template>
            </ui-popup>
            <ui-popup :visible.sync="isEventBusPopupOpen">
                <template #body>
                    <div class="w-f2">
                        <ui-input class="p" v-model="event.name">event.name</ui-input>
                        <div class="p">
                            <ui-textarea v-model="event.dataJson" :invalid="event.error != null">
                                event.data json
                            </ui-textarea>
                            <div class="alert alert-error" v-if="event.error" @click="event.error = null">
                                <div class="alert-body text-xsmall">{{ event.error }}</div>
                            </div>
                        </div>
                        <ui-button @click="eventBusTrigger">trigger</ui-button>
                    </div>
                </template>
            </ui-popup>
        </template>
        <template #header-right>
            <ui-select :options="WidgetFilesOptions" @change="onWidgetConfigChanged" class="mar-left-l1 w-32"></ui-select>
        </template>
        <template #default="{ initialized }">
            <div class="pad-l3" v-if="initialized">
                <w-widget-preview
                    v-for="(elem, i) in widgets"
                    v-bind="{ elem, showPanels }"
                    :key="`${elem.type}${i}`"></w-widget-preview>
            </div>
            <div v-else class="preloader"></div>
            <w-error-notifier></w-error-notifier>
        </template>
    </w-env-emulator>
</template>
<script>
// eslint-disable-next-line no-restricted-syntax
import { PortalTarget as UiPortalTarget } from 'portal-vue';
import { EB, StoreManager } from '@goodt-wcore/managers';
import { PanelUi, Popup as UiPopup } from '@goodt-wcore/components';
import WWidgetPreview from './WidgetPreview.vue';
import WEnvEmulator from './EnvEmulator.vue';
import WErrorNotifier from './ErrorNotifier.vue';

const { useEventBus, EventBusEvent } = EB;
const { store, ValueObject } = StoreManager;

/**
 * Creates elemInfo factory method
 */
const createElemInfoFactory = ({ componentFactory }) => {
    /**
     * Creates elemInfo factory
     * @param {{ type:string, props:object, children:array }} options
     * @return {object}
     */
    const createElemInfo = ({ type, props, children }) => {
        const name = type.split('/').pop();
        const component = () => componentFactory({ type, name });
        const childrenElemInfos = children.map(createElemInfo);

        return { component, type, props, children: childrenElemInfos };
    };

    return createElemInfo;
};

/**
 * Transforms object prop values to VOs
 *
 * @param {Record<string, any>} record
 * @return {Record<string, ValueObject>}
 */
const toVO = (record) =>
    Object.entries(record).reduce(
        (result, [key, value]) => ({
            [key]: new ValueObject(value),
            ...result
        }),
        {}
    );

export default {
    name: 'Sandbox',
    components: { WWidgetPreview, WEnvEmulator, UiPopup, WErrorNotifier, UiPortalTarget, ...PanelUi },
    static: {
        // eslint-ignore-next-line
        WidgetFilesOptions: process.env.WIDGET_FILES.map((file) => ({
            label: file.replace(/(widgets\.?|\.?json)/g, '') || 'default',
            value: file
        }))
    },
    data() {
        return {
            // eslint-disable-next-line unicorn/prevent-abbreviations
            isInitialized: false,
            isPanelsVisible: null,
            isStorePopupOpen: false,
            isEventBusPopupOpen: false,
            isTokenPopupOpen: false,
            isRuntimeErrorsPopupOpen: false,
            store: {
                stateJson: '',
                error: null
            },
            event: {
                name: '',
                dataJson: '',
                error: null
            }
        };
    },
    computed: {
        showPanels() {
            return this.isPanelsVisible ?? this.configInstance.settings?.showPanels ?? true;
        },
        /**
         * @return {object[]}
         */
        widgets() {
            const { widgets = [] } = this.config;
            return widgets.map ? widgets.map(this.createElemInfo) : [];
        },
        config() {
            return this.configInstance.config ?? {};
        },
        configInstance() {
            return this.$root.configInstance;
        }
    },
    created() {
        this.init();
    },
    methods: {
        init() {
            const { componentFactory } = this.$root.$options.sandbox;
            this.createElemInfo = createElemInfoFactory({ componentFactory });
            this.isInitialized = true;
        },
        toggleEditorMode() {
            this.$root.isEditorMode = !this.$root.isEditorMode;
            this.$forceUpdate();
        },
        storeCommit() {
            try {
                const { stateJson } = this.store;
                if (stateJson) {
                    store.commit(toVO(JSON.parse(this.store.stateJson)));
                }
                this.toggleStorePopup();
                this.store.error = null;
            } catch (e) {
                this.store.error = e;
            }
        },
        eventBusTrigger() {
            try {
                const { name, dataJson } = this.event;
                if (name) {
                    const { eventBus } = useEventBus();
                    eventBus.trigger(new EventBusEvent(name), dataJson ? JSON.parse(dataJson) : {});
                }
                this.toggleEventBusPopup();
                this.event.error = null;
            } catch (e) {
                this.event.error = e;
            }
        },
        togglePanels() {
            this.isPanelsVisible = !this.isPanelsVisible;
        },
        toggleStorePopup() {
            this.isStorePopupOpen = !this.isStorePopupOpen;
        },
        toggleEventBusPopup() {
            this.isEventBusPopupOpen = !this.isEventBusPopupOpen;
        },
        onWidgetConfigChanged(file) {
            this.configInstance.loadProp('widgets', file);
        }
    }
};
</script>
