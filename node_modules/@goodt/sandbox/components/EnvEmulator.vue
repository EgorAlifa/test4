<template>
    <div>
        <div class="tile header-fixed pad-3">
            <div class="row row-collapse">
                <div class="col col-vmid">
                    <slot name="header"></slot>
                </div>
                <div class="d-flex col col-auto col-vmid">
                    <button class="btn btn-ghost" @click="toggleTokenPopup">auth</button>
                    <button class="btn btn-ghost" @click="toggleConsole">$env</button>
                    <slot name="header-right"></slot>
                </div>
            </div>
        </div>
        <slot v-bind="{ authenticated: auth.authenticated, initialized }"></slot>
        <ui-popup :visible.sync="isEnvOpen" :dialog="consolePopupDialog">
            <template #body>
                <div class="p">
                    <code>store.state</code>
                    <pre class="text-xsmall">{{ storeState }}</pre>
                </div>
                <div class="p">
                    <code>RouteManager.route</code>
                    <pre class="text-xsmall">{{ routeManagerRoute }}</pre>
                </div>
            </template>
        </ui-popup>
        <ui-popup :visible.sync="isTokenPopupOpen">
            <template #body>
                <div class="w-f2">
                    <div v-if="!auth.isRedirect">
                        <ui-input v-model="auth.user.username">Имя пользователя</ui-input>
                        <ui-input v-model="auth.user.password">Пароль</ui-input>
                    </div>
                    <ui-button @click="onAuth" class="mar-top-l1 w-100">
                        {{ auth.authenticated ? 'Выйти' : 'Войти' }}
                    </ui-button>

                    <div v-if="auth.authenticated" class="mar-v-l1">
                        auth.token
                        <ui-textarea :value="auth.token" readonly></ui-textarea>
                        <div class="mar-v-l1">
                            user profile
                            <pre class="text-xsmall">{{ auth.user.profile }}</pre>
                        </div>
                    </div>
                </div>
            </template>
        </ui-popup>
        <ui-portal-target :id="PORTAL_TARGET_NAME_POPUP" :name="PORTAL_TARGET_NAME_POPUP" multiple></ui-portal-target>
    </div>
</template>

<script>
// eslint-disable-next-line no-restricted-syntax
import { PortalTarget } from 'portal-vue';
import { ServiceProvider } from '@goodt-common/service-provider';
import { ServiceSetupConfigs } from '@goodt-common/services';
import { ProjectDataProviderRepository } from '@goodt-common/dremio';
// eslint-disable-next-line import/no-cycle
import { PanelUi, Popup } from '@goodt-wcore/components';
import { AuthManager, ConstManager, FileManager, EB, RouteManager, StoreManager } from '@goodt-wcore/managers';
import { Adapters } from '@goodt-common/auth';
import { AdapterLogoutStrategyType, AdapterLoginStrategyType } from '@goodt-common/auth/const';
import { Const as Globals } from '@goodt-wcore/core';

const { store, ValueObject } = StoreManager;
const { useEventBus, EventBusEvent } = EB;

/**
 * remove non global keys from store state
 */
const clearStoreState = () => {
    const { state } = store;

    const stateNew = Object.entries(state).reduce((acc, [key, val]) => {
        const meta = val instanceof ValueObject ? val.meta : null;
        if (meta && meta.global) {
            acc[key] = val;
        }
        return acc;
    }, {});

    store.replace(stateNew);
};

/**
 * @param {Record<string, any>} obj
 * @return {Record<string, ValueObject>}
 */
const buildStoreState = (obj) =>
    Object.entries(obj).reduce(
        (acc, [key, val]) => ({ ...acc, [key]: val instanceof ValueObject ? val : new ValueObject(val) }),
        {}
    );

const MODULES = {};
const MODULE_KEYS = {
    AUTH_MANAGER: 'AuthManager',
    CONST_MANAGER: 'ConstManager',
    FILE_MANAGER: 'FileManager',
    ROUTE_MANAGER: 'RouteManager',
    STORE_MANAGER: 'StoreManager',
    CONST: 'Const',
    EVENT_BUS: 'EB'
};

export default {
    name: 'EnvEmulator',
    components: { ...PanelUi, UiPopup: Popup, UiPortalTarget: PortalTarget },
    props: {
        authAdapter: {
            type: Object,
            default() {
                return { name: 'Simple', config: {} };
            }
        },
        envConstants: {
            type: Object,
            default() {
                return { ...Globals };
            }
        },
        appConstants: {
            type: Object,
            default() {
                return {};
            }
        },
        storeInitState: {
            type: Object,
            default() {
                return {};
            }
        },
        modulesExportEnabled: {
            type: Boolean,
            default: true
        },
        modulesExportNS: {
            type: String,
            default: '$core',
            validator(v) {
                return !!v.length;
            }
        },
        /** @type {import('vue').PropOptions<import('../managers/FileManager').FileInfo[]>} */
        demoFiles: {
            type: Array,
            default() {
                return [
                    {
                        hash: '1',
                        name: 'test',
                        type: 'image/png',
                        size: 1,
                        url: 'https://vuejs.org/images/logo.png'
                    }
                ];
            }
        },
        /** @type {import('vue').PropOptions<import('../managers/RouteManager').RouteObject>} */
        demoRoute: {
            type: Object,
            default() {
                return {
                    path: '/',
                    query: {},
                    meta: {}
                };
            }
        },
        services: {
            type: Array,
            default: () => []
        },
        dataProviders: {
            type: Array,
            default: () => []
        }
    },

    data() {
        return {
            PORTAL_TARGET_NAME_POPUP: Globals.PORTAL_TARGET_NAME_POPUP,
            /** @type {EventBus} */
            ebi: null,

            consolePopupDialog: {
                class: {},
                style: { width: '100%', 'max-width': '1000px' }
            },
            initialized: false,
            isEnvOpen: false,
            isTokenPopupOpen: false,
            auth: {
                authenticated: false,
                token: null,
                strat: null,
                isRedirect: false,
                user: {
                    username: null,
                    password: null,
                    profile: {}
                }
            }
        };
    },
    computed: {
        /** @return {Record<string, any>} */
        storeState() {
            return store.state;
        },
        /** @return {import('../managers/RouteManager').RouteObject} */
        routeManagerRoute() {
            return RouteManager.instance.route;
        }
    },
    watch: {
        modulesExportEnabled: {
            handler() {
                this.exportModules();
            },
            immediate: true
        }
    },
    created() {
        Promise.all([
            this.initServices(),
            this.initAuthManager(),
            this.initDataProviders(),
            this.initConst(),
            this.initEventBus(),
            this.initConstManager(),
            this.initFileManager(),
            this.initRouteManager(),
            this.initStoreManager()
        ]).finally(() => {
            this.initialized = true;
        });
    },
    methods: {
        /**
         * Registers core module
         * @param {string} key
         * @param {Record<string, any>} m
         */
        registerModule(key, m) {
            MODULES[key] = m;
        },
        async initServices() {
            ServiceProvider.setup({ configs: ServiceSetupConfigs });

            const { services } = this;
            ServiceProvider.init(services);
        },
        /**
         * Init Constants
         */
        initConst() {
            const { envConstants } = this;
            // eslint-disable-next-line no-restricted-syntax
            for (const constant in Globals) {
                if (Object.prototype.hasOwnProperty.call(envConstants, constant)) {
                    Globals[constant] = envConstants[constant];
                }
            }

            this.registerModule(MODULE_KEYS.CONST, Globals);
        },
        /**
         * Init auth manager
         */
        async initAuthManager() {
            this.registerModule(MODULE_KEYS.AUTH_MANAGER, AuthManager);

            const { name, config } = this.authAdapter;
            const { auth } = this;
            const { instance: authManager } = AuthManager;
            authManager.setAdapters(Adapters);

            await authManager.init(name, config);
            const { adapter } = authManager;
            auth.strat = adapter.getLoginStrategy();
            auth.isRedirect = auth.strat.type === AdapterLoginStrategyType.REDIRECT;

            if (adapter.authenticated) {
                this.initAuthData(adapter);
            }
        },
        async initAuthData(adapter) {
            this.auth.authenticated = adapter.authenticated;
            this.auth.token = adapter.token;
            try {
                this.auth.user.profile = await adapter.getUserProfile();
            } catch {
                this.auth.user.profile = {};
            }
        },
        /**
         * Init const manager
         */
        initConstManager() {
            const { appConstants } = this;
            const mi = ConstManager.instance;
            mi.setConstantsHash(appConstants);
            this.registerModule(MODULE_KEYS.CONST_MANAGER, ConstManager);
        },
        /**
         * Init file manager
         */
        initFileManager() {
            const { demoFiles } = this;
            const { instance } = FileManager;
            const dispose = instance.onBrowse(({ resolve }) => {
                // eslint-disable-next-line no-alert
                const r = window.confirm('Select demo files?');
                resolve(r ? demoFiles : []);
            });
            this.$on('hook:destroyed', dispose);
            this.registerModule(MODULE_KEYS.FILE_MANAGER, FileManager);
        },
        /**
         * Init route manager
         */
        initRouteManager() {
            const { demoRoute } = this;
            const { instance } = RouteManager;
            const dispose = instance.onNavigate(({ path, query }) => {
                clearStoreState();
                store.commit(buildStoreState(query));
                instance.setRoute({ path, query, meta: {} });
            });

            store.commit(buildStoreState(demoRoute.query));
            instance.setRoute(demoRoute);

            this.$on('hook:destroyed', dispose);
            this.registerModule(MODULE_KEYS.ROUTE_MANAGER, RouteManager);
        },
        /**
         * Init state manager
         */
        initStoreManager() {
            const { storeInitState } = this;
            const state = Object.entries(storeInitState).reduce((acc, [key, val]) => {
                acc[key] = new ValueObject(val);
                return acc;
            }, {});
            store.commit(state);
            this.registerModule(MODULE_KEYS.STORE_MANAGER, StoreManager);
        },
        /**
         * Init eventbus
         */
        initEventBus() {
            const { eventBus: instance } = useEventBus();
            this.registerModule(MODULE_KEYS.EVENT_BUS, {
                instance,
                EventBusEvent
            });
        },
        initDataProviders() {
            ProjectDataProviderRepository.set(this.dataProviders);
        },
        /**
         * Exports regitered modules
         */
        exportModules() {
            const { modulesExportEnabled, modulesExportNS } = this;
            if (!modulesExportEnabled) {
                return;
            }
            window[modulesExportNS] = MODULES;
            console.info(`[${this.$options.name}]`, `modules export enabled -> window.${modulesExportNS}`);
        },
        /**
         * Toggles the console
         */
        toggleConsole() {
            this.isEnvOpen = !this.isEnvOpen;
        },
        toggleTokenPopup() {
            this.isTokenPopupOpen = !this.isTokenPopupOpen;
        },
        onAuth() {
            this.auth.authenticated ? this.onLogout() : this.onLogin();
        },
        async onLogin() {
            const {
                auth: { strat, user }
            } = this;
            const { adapter } = AuthManager.instance;
            // redirect
            if (strat.type === AdapterLoginStrategyType.REDIRECT) {
                window.location.href = strat.options.url;
            }
            // credentials
            else {
                const { username, password } = user;
                await adapter.login({ username, password });
                if (adapter.authenticated) {
                    this.initAuthData(adapter);
                }
            }
        },
        async onLogout() {
            const { adapter } = AuthManager.instance;
            const strat = adapter.getLogoutStrategy();
            // redirect
            if (strat.type === AdapterLogoutStrategyType.REDIRECT) {
                window.location.href = strat.options.url;
            }
            // credentials
            else {
                await adapter.logout();
                if (!adapter.authenticated) {
                    this.initAuthData(adapter);
                }
            }
        }
    }
};
</script>

<style scoped lang="pcss">
.header-fixed {
    position: fixed;
    width: 100%;
    z-index: 1;
}
</style>
