<template>
    <div>
        <ui-popup :visible="isOpen" @close="toggleVisible">
            <template #body>
                <div class="w-f5">
                    <div v-for="({ name, message, filename, stack, scope }, i) in errors" :key="i" class="pad-v-2">
                        <div class="color-red">
                            <b>{{ name }}:</b>
                            {{ message }}
                        </div>
                        <div class="text-xsmall text-truncate" :title="filename">
                            {{ stack }}
                        </div>
                        <code v-if="scope" class="text-xsmall">{{ scope }}</code>
                        <button class="btn btn-ghost pull-right" @click="onErrorRemove(i)">Скрыть</button>
                    </div>
                </div>
            </template>
        </ui-popup>
        <ui-mounting-portal
            to="header-right-area">
            <div
                v-if="errors.length > 0"
                class="btn btn-error pull-right"
                @click="toggleVisible">
                errors ({{ errors.length }})
            </div>
        </ui-mounting-portal>
    </div>
</template>

<script>
import { Portal as UiMountingPortal } from 'portal-vue';
import { Popup as UiPopup } from '@goodt-wcore/components';
import { useErrorInfoSubscriber } from '@goodt-common/error-service';

export default {
    name: 'ErrorNotifier',
    components: {
        UiPopup,
        UiMountingPortal
    },
    mixins: [useErrorInfoSubscriber()],
    data: () => ({
        errors: [],
        isVisible: false
    }),
    computed: {
        isOpen() {
            return this.errors.length > 0 && this.isVisible;
        }
    },
    methods: {
        // eslint-disable-next-line vue/no-unused-properties
        /**
         * @public
         * @param {import('@goodt-wcore/managers/ErrorManager').ErrorInfo} errorInfo
         */
        onError(errorInfo) {
            const { error: { name, message, stack }, scope, type } = errorInfo;
            const filename = stack.split('\n').shift();
            this.errors.push(Object.freeze({ name, message, filename, scope, stack }));
            this.isVisible = [this.errorTypes.CoreError].includes(type);
        },
        onErrorRemove(i) {
            this.errors = this.errors.splice(i, 1);
            this.isVisible = false
        },
        toggleVisible() {
            this.isVisible = !this.isVisible;
        }

    }
};
</script>
