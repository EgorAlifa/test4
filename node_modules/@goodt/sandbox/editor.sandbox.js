#!/usr/bin/env node
const express = require('express');
const { join } = require('path');
const { createProxyMiddleware } = require('http-proxy-middleware');

const BASE_DIR = process.cwd();
const PLATFORM_CONFIG_PATH = 'sandbox/config/platform.json';
const PLATFORM_LOCAL_CONFIG_PATH = 'sandbox/config/platform.local.json';

/**
 * @typedef {object} Config
 * @property {string} host
 * @property {{ url:string, remotesUrl:string }} platform
 * @property {Record<string, string>} assets
 * @property {Record<string, { url:string }>} widgets
 */
/** @type {Config} */
let config = {};
try {
    config = require(join(BASE_DIR, PLATFORM_CONFIG_PATH));
} catch {
    throw new Error(`Unable to load config "${PLATFORM_CONFIG_PATH}"`);
}
try {
    config = require(join(BASE_DIR, PLATFORM_LOCAL_CONFIG_PATH));
} catch {
    /**/
}

const HOST = config.host?.split(':')[0] ?? 'localhost';
const PORT = config.host?.split(':')[1] ?? 3000;
const app = express();
const startLogs = [];

// widgets urls proxying by namespace
// @example
// 'http://localhost/widgets/<vendor>/remoteEntry.js' -> '<config.platform.remotesUrl>/<vendor>/...'
Object.entries(config.widgets ?? {}).forEach(([key, options]) => {
    const pathPattern = `${config.platform.remotesUrl}${key}/`;
    const proxyOptions = {
        target: options.url,
        changeOrigin: true,
        pathRewrite: { [`.*${pathPattern}`]: '/' }
    };

    app.use(createProxyMiddleware((pathname) => pathname.includes(pathPattern), proxyOptions));
    startLogs.push(['Widgets proxy enabled:', pathPattern, '->', options.url]);
});

// assets files urls serving from local files or proxying
Object.entries(config.assets ?? {}).forEach(([remoteAssetUrl, proxyAssetsPath]) => {
    if (proxyAssetsPath.startsWith('http')) {
        const proxyOptions = {
            target: proxyAssetsPath.replace(remoteAssetUrl, ''),
            changeOrigin: true
        };
        app.use(remoteAssetUrl, createProxyMiddleware(remoteAssetUrl, proxyOptions));
        return;
    }
    const remoteAssetUrlUsed = remoteAssetUrl.startsWith('*') ? remoteAssetUrl : `*${remoteAssetUrl}`;
    app.get(remoteAssetUrlUsed, (_, res) => {
        res.sendFile(join(BASE_DIR, proxyAssetsPath));
    });
    startLogs.push(['Assets proxy enabled:', remoteAssetUrlUsed, '->', proxyAssetsPath]);
});

// platform (editor/player) root url proxying
const appProxyOptions = {
    target: config.platform.url,
    changeOrigin: true,
    pathRewrite: { [`^/`]: '/' }
};
app.use('/', createProxyMiddleware(appProxyOptions));

app.listen(PORT, HOST, () => {
    console.log('--------');
    startLogs.forEach((r) => console.log(...r));
    console.log(`Sandbox started at http://${HOST}:${PORT}`);
});
