<template>
    <w-panel>
        <ui-container>
            <!-- your panel goes here -->
            <ui-select prop="metric" :options="metrics"></ui-select>
            <ui-select prop="dimension" :options="dimensions"></ui-select>
            <ui-select prop="dimensionOrMetric" :options="dimensionsMetricsOptions"></ui-select>
            <ui-select prop="field" :options="fields"></ui-select>
            [[#drilldown]]
            <ui-select prop="drilldownName" :options="drilldowns"></ui-select>
            <ui-select :options="drilldownDimensionsOptions">
                Выберите измерение из дриллдауна
            </ui-select>
            [[/drilldown]]
            [[#multiple]]
            <ui-select prop="mainDatasetIndex" :options="datasetOptions"></ui-select>
            <ui-select
                prop="mainDimensionOrMetric"
                :options="dimensionsMetricsByDataset[props.mainDatasetIndex]">
            </ui-select>
            [[/multiple]]
        </ui-container>
    </w-panel>
</template>

<script>
import { Panel } from '@goodt-wcore/panel';
import { usePanelDatasetMixin, PanelDatasetMixinTypes } from '@goodt-common/data';
import { PanelInstanceTypeDescriptor } from '../types';

export default {
    extends: Panel,
    mixins: [usePanelDatasetMixin()],

    meta: { name: 'Настройки виджета', icon: 'widgets' },

    data: () => ({}),
    computed: {
        dimensionsMetricsOptions() {
            return this.buildOptions(this.dimensionsMetrics, { empty: true });
        },
    [[#drilldown]]
        drilldownDimensionsOptions() {
            return this.$drilldown.getDimensions(this.props.drilldown).map((dimension, index) => ({
                label: dimension,
                value: index
            }));
        },
    [[/drilldown]]
    [[#multiple]]
        // измерения/метрики по датасетам
        dimensionsMetricsByDataset() {
            return this.queryModels.map((queryModel) => {
                const { metrics = [], dimensions = [] } = queryModel;
                return [...metrics, ...dimensions];
            });
        },
        // название датасета / индекс
        datasetOptions() {
            return [
                { value: null, label: '-' },
                ...this.datasetRequests.map(({ name }, idx) => ({ value: idx, label: name }))
            ];
        }
    [[/multiple]]
    },
    watch: {
        dimensions: {
            handler(dimensions) {
                if (dimensions.includes(this.props.dimension) === false) {
                    this.props.dimension = dimensions[0] ?? '';
                    this.propChanged('dimension');
                }
            },
            immediate: true
        }
    },
    methods: {
        ...PanelInstanceTypeDescriptor,
        ...PanelDatasetMixinTypes
    }
};
</script>

