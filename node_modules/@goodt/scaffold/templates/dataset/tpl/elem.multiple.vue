<template>
    <w-elem :placeholder="$placeholder">
        <h3>Индекс главного датасета: {{ props.mainDatasetIndex }}</h3>
        <h3>Заданная метрика/измерение главного датасета: {{ props.mainDimensionOrMetric }}</h3>
        [[#drilldown]]
        <div class="d-flex gap-1 mar-bot-1 mar-top-1">
            <button
                class="btn btn-secondary btn-small"
                :class="{ disabled: !drilldownCanPush }"
                :disabled="!drilldownCanPush"
                @click="drilldownPush">
                push: {{ drilldownCanPush }}
            </button>
            <button
                class="btn btn-secondary btn-small"
                :class="{ disabled: !drilldownCanPop }"
                :disabled="!drilldownCanPop"
                @click="drilldownPop">
                pop: {{ drilldownCanPop }}
            </button>
        </div>
        [[/drilldown]]
        <template v-if="results">
            <div v-for="(result, r) in results" :key="r">
                <h3>Result #{{ r }}</h3>
                <pre v-for="(item, i) in result.rows" :key="i">{{ { ...item } }}</pre>
            </div>
        </template>
        <div v-if="isLoading">loading...</div>
        <div v-if="error">{{ error }}</div>
        <!-- {/demo} -->
    </w-elem>
</template>

<script>
import { Elem } from '@goodt-wcore/elem';
import { useElemDatasetBaseMixin, ElemDatasetBaseMixinTypes } from '@goodt-common/data';
import { meta  } from './descriptor';
import { ElemInstanceTypeDescriptor } from './types';

const DatasetMixin = useElemDatasetBaseMixin({
    [[#drilldown]]
    drilldown: true,
    [[/drilldown]]
    [[#customPanel]]
    panel: false
    [[/customPanel]]
});

export default {
    extends: Elem,
    mixins: [DatasetMixin],

    meta,

    hooks: {
        then(results) {
            this.processResults(results);
        },
        [[#tips]]
        // @todo: delete if unused
        // before – optional hook
        before(cancel) { /* use cancel() to prevent loading */ },
        // then – optional hook
        catch(error) {},
        // finally – optional hook
        finally() {}
        [[/tips]]
    },

    data: (/* vm */) => ({}),

    [[#drilldown]]
    computed: {
        drilldownState() {
            return {
                canPop: false,
                canPush: false,
                ...this.$drilldown.state[this.props.drilldownName]
            };
        },
        drilldownCanPop() {
            return this.drilldownState.canPop;
        },
        drilldownCanPush() {
            return this.drilldownState.canPush;
        },
        drilldownDimension() {
            return this.drilldownState.dimension;
        }
    },
    [[/drilldown]]

    methods: {
        // IDE suggestion helper
        ...ElemInstanceTypeDescriptor,
        ...ElemDatasetBaseMixinTypes,
        /**
         *
         * @param {(import('@goodt-common/data').IDatasetResult|null)[]} results
         */
        processResults(results) {
            results.forEach((result, index) => {
                console.log(`result #${index}:`);
                if (result == null) {
                    console.log(`empty`);
                    return;
                }
                result.rows.forEach((row) => {
                    console.log({ ...row });
                })
            });
        },
        [[#drilldown]]
        drilldownPush() {
            const { drilldownName } = this.props;
            if (this.drilldownCanPush) {
                // or without using computed this.drilldownCanPush
                // if (this.$drilldown.canPush(drilldownName)) {
                const dimensionValue = this.result.rows[0][drilldownName];
                // commit before push using drilldownName
                this.$storeCommit({ [drilldownName]: dimensionValue });
                this.$drilldown.push(drilldownName, dimensionValue);
            }
        },
        drilldownPop() {
            const { drilldownName } = this.props;
            if (this.drilldownCanPop) {
                // или если без computed
                // if (this.$drilldown.canPop(drilldownName)) {
                this.$drilldown.pop(drilldownName);
                // commit after pop
                this.$storeCommit({ [drilldownName]: null });
            }
        }
        [[/drilldown]]
    }
};
</script>
