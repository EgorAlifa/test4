#!/usr/bin/env node
const { writeFileSync } = require('fs');
const { resolve } = require('path');

const BASE_DIR = process.cwd();
const args = process.argv.slice(2);

const packageLockJson = require(resolve(BASE_DIR, './package-lock.json'));

const widgetsRootPath = args[0] != null
    ? resolve(BASE_DIR, args[0])
    : BASE_DIR;

const packageJson = require(resolve(widgetsRootPath, './package.json'));

const reportPackages = [
    ...new Set([
        'goodt-dremio-sdk',
        'goodt-framework-css',
        'goodteditor-ui',
        '@goodt/webpack',
        ...Object.keys(packageJson.dependencies ?? {}),
        ...Object.keys(packageJson.devDependencies ?? {}),
        ...Object.keys(packageJson.peerDependencies ?? {})
    ])].sort((a, b) => a.localeCompare(b));

const reportDeps = reportPackages.reduce((acc, name) => {
    const info = packageLockJson.packages[`node_modules/${name}`];
    if (info == null) {
        return acc;
    }
    const { version } = info;
    return { ...acc, [name]: version };
}, {});

const version = packageJson.version === '0.0.0-dev' ? packageJson.repository : packageJson.version;

const widgetsDepsReport = {
    version,
    name: packageJson.name,
    date: new Date(),
    dependencies: reportDeps,
};

const targetReportPath = args[1] != null
    ? resolve(widgetsRootPath, args[1])
    : resolve(widgetsRootPath, 'public');

writeFileSync(resolve(targetReportPath, 'report.json'), JSON.stringify(widgetsDepsReport, null, 2));
