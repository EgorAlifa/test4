/**
 * Global Scope Shared functions
 * related with WMF
 */

/**
 * Import (load) remote module with specified `url`
 * using native `import` or esm-shim depending on global `__GOODT__.ENV_CONFIG`
 *
 * @param {string} url
 * @returns {*|Promise<*>}
 */
const importModule = (url) => {
    return window.__GOODT__.WMF.ENV_CONFIG.isEsmShim
      ? window.importShim(url)
      : import(/* webpackIgnore: true */url);
}

const $container = () => window.document.querySelector('head');

/**
 * Load script by adding
 * `script` tag with defined `url`, `type` to document head
 * with extra tag attrs data-wmf-scope, data-wmf-scope required by Global Scope Remotes
 *
 * @param {string} url
 * @param {string} type
 * @param {string} scope
 * @param {string} module
 * @returns {Promise<unknown>}
 */
const appendScript = (url, { type = 'text/javascript', scope, module } = {}) => new Promise((resolve) => {
    const script = document.createElement('script');
    script.defer = true;
    script.src = url;
    if (typeof scope === 'string') {
        script.setAttribute(window.__GOODT__.WMF.SCOPE_ATTR, scope);
    }
    if (typeof module === 'string') {
        script.setAttribute(window.__GOODT__.WMF.MODULE_ATTR, module);
    }
    script.type = type;
    script.onload = function (src) {
        resolve();
    };
    $container().appendChild(script);
});

/**
 * Get current scope from `document.currentScript` attr `data-wfm-scope`
 * @returns {string}
 */
const getCurrentScope = () => {
    const { SCOPE_ATTR } = window.__GOODT__.WMF;
    return document.currentScript.getAttribute(SCOPE_ATTR);
};

/**
 * Get current module from `document.currentScript` attr `data-wfm-module`
 * Required only by Global Scope Remotes
 *
 * @returns {string}
 */
const getCurrentModule = () => {
    const { MODULE_ATTR, getCurrentScope, buildModuleScopedName } = window.__GOODT__.WMF;
    const scope = getCurrentScope();
    const module = document.currentScript.getAttribute(MODULE_ATTR);

    return buildModuleScopedName(scope, module);
};

/**
 * Registers remote module in Global Scope
 * Required only by Global Scope Remotes
 *
 * @returns {string}
 */
const registerModule = (module) => {
    window[getCurrentModule()] = module;
};

/**
 * Build module's scoped name to achieve module id uniqueness in Global Scope
 * Required only by Global Scope Remotes * @param {string} scope
 *
 * @param {string} module
 * @returns ${string}
 */
const buildModuleScopedName = (scope, module = 'Server') => {
    return `${scope}_${module}`;
};

/**
 * Resolves module's `remoteEntry.js` by `scopeName` and `moduleName` from Global Scope
 *
 * @param {string} scopeName
 * @param {string} moduleName
 * @returns {string}
 */
const resolveScopeModuleRemoteEntry = (scopeName, moduleName) => {
    return window.__GOODT__.WMF.ENTRIES_MAP[scopeName][window.__GOODT__.WMF.ENV].url.concat(`/${moduleName}/remoteEntry.js`)
}

window.__GOODT__.WMF = Object.assign({
    appendScript,
    importModule,
    getCurrentScope,
    getCurrentModule,
    buildModuleScopedName,
    resolveScopeRemoteEntry,
    resolveScopeModuleRemoteEntry,
    registerModule,
    WMF_HOST_APP: 'host',
    SCOPE_ATTR: 'data-wfm-scope',
    MODULE_ATTR: 'data-wfm-module',
    REMOTE_ENTRY_FILENAME: 'remoteEntry.js'
}, window.__GOODT__.WMF);

