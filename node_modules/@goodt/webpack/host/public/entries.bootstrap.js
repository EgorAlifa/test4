// @todo keep for reference
// @todo not used since @goodt/webpack@2.0.0
// safe reassign
window.__GOODT__.WMF.ENV_CONFIG = Object.assign({}, window.__GOODT__.WMF.ENV_CONFIG);

const {
    isEsm = true,
    isEsmShim = false,
    isDebug = false,
    // entriesConfigFilename,
    endpointsConfigUrl
} = window.__GOODT__.WMF.ENV_CONFIG;

// environment context
const environment = () => (location.host.includes('localhost') ? 'localhost' : 'production');

const basePath = environment() === 'localhost' ? './' : '/';

const SCRIPT_TYPE = isEsm ? (isEsmShim ? 'module-shim' : 'module') : undefined;

const console = {
    log: isDebug ? (...args) => globalThis.console.log(...args) : () => {}
};

/*
  Reference our configuration files against the global window so that
  'DynamicPublicPathPlugin' can grab them when initializing our bundles
*/
globalThis.__GOODT__.WMF.ENV = /* environment */ environment();
globalThis.__GOODT__.WMF.ENTRIES_MAP = {};

let chunks = { entrypoints: ['host'] };

const init = async () => {
    /**
     * Extra flexibility
     * if configs globally defined
     */
    /*
    @todo keep for reference. actually not used, cause map config described via widgets.json -> widgets.packages section
    if (/!* typeof entriesConfigFilename === 'string' || *!/ typeof endpointsConfigUrl === 'string') {
        const configs = [
            // environment context set by our build pipelines
            // './environment.config.json',

            // global reference of endpoints
            endpointsConfigUrl
            /!*
              An array of entry points required for initializing this app and remotes
              Note: if this is a remote app, include 'remoteEntry' for 'entrypoint'
              so the host can point to it and grab the remotes
            *!/
            // `${basePath}${entriesConfigFilename}`
        ];

        // get the configuration files in parallel
        const [mapFromConfig /!*chunksFromConfig*!/] = await Promise.all(
            configs.map((config) => fetch(config).then((response) => response.json()))
        ).catch(() => null);

        if (mapFromConfig != null) {
            globalThis.__GOODT__.WMF.ENTRIES_MAP = mapFromConfig;
        }
        /!*
        if (chunksFromConfig != null) {
          chunks = chunksFromConfig;
        }
        *!/
    }
    */

    isDebug && globalThis.console.group('WMF: Bootstrap Entries');
    console.log(`Debug LOGGING`);

    console.log(`Local chunk base path: ${basePath}`);

    const assetsManifest = await fetch('./assets-manifest.json', { cache: 'no-cache' }).then((response) =>
        response.json()
    );

    console.log('Generated Manifest File:');
    console.log(assetsManifest);

    // debugging
    console.log(`Current Environment: '${/* environment */ environment()}'`);
    console.log(`List of local entry points to use: [${chunks.entrypoints}]`);
    if (chunks.remotes) {
        console.log(`List of remote apps to bootstrap: [${chunks.remotes}]`);
    }

    const MandatoryChunks = [].reduce((acc, chunk) => acc.concat(assetsManifest[chunk] ?? []), []);

    await Promise.all([
        ...MandatoryChunks.map((chunk) => window.__GOODT__.WMF.appendScript(`./${chunk}`)),
        // get entry points required for initializing this app
        ...(chunks.entrypoints || []).map((chunk) => {
            console.log(`Getting '${chunk}' entry point`);
            const scriptUrl = chunk !== 'remoteEntry' ? `./${assetsManifest[`${chunk}.js`]}` : `${chunk}.js`;

            return globalThis.__GOODT__.WMF.appendScript(scriptUrl, { type: SCRIPT_TYPE });
        })
    ]);
    /*
      // @todo keep for reference. actually not used
      // cause remotes entry loading id on-demand by @goodt/package-loader + @goodt/webpack npm packages
      // possible to load mandatory remoteEntries after host entries
      .then(() => {
        // get the remotes we're consuming
        (chunks.remotes || []).map(chunk => {
          const { url } = map[chunk][/!* environment *!/ environment()];
          console.log(
              `Remote '${chunk}' address for environment '${
                  /!* environment *!/ environment()
              }' is: ${url}/remoteEntry.js`
          );
          return appendScript(`${url}/remoteEntry.js`);
        });
    
        console.log('entries bootstrapped');
      });
    */

    isDebug && globalThis.console.groupEnd();
};

init();
