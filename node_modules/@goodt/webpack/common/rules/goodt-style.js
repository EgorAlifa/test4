const webpack = require('webpack');
const path = require('path');

/**
 * @param {import('webpack-chain')} config
 * @param {object} loaderOptions
 */
module.exports = function(config, loaderOptions = { ns: '$css' }) {
    // @see https://github.com/vuejs/vue-cli/blob/v4.5.13/packages/%40vue/cli-service/lib/config/css.js
    const goodtStyleLoader = {
        name: 'goodt-style-loader',
        loader: path.resolve('./../loaders/goodt-style-loader.js'),
        options: loaderOptions
    };
    const rules = ['css', 'less'];
    const types = ['vue', 'vue-modules'];

    rules.forEach(rule => {
        types.forEach(type => {
            const { name, loader, options } = goodtStyleLoader;
            config.module
                .rule(rule)
                .oneOf(type)
                .use(name)
                .before('vue-style-loader')
                .loader(loader)
                .options(options);
        });
    });
    config.plugin('define-plugin').use(
        new webpack.DefinePlugin({
            WIDGET_CSS_NS: JSON.stringify(goodtStyleLoader.options.ns)
        })
    );
};
