const loaderUtils = require('loader-utils');
const ModuleCtor = require('module');

function evalModuleCode(loaderContext, code, filename) {
    const m = new ModuleCtor(filename, loaderContext);
    m.paths = ModuleCtor._nodeModulePaths(loaderContext.context);
    m.filename = filename;
    m._compile(code, filename);
    return m.exports;
}

/*
https://webpack.js.org/api/loaders/#thisemitfile

cssRule
    .use(goodtStyleLoader.name)
    .before(beforeLoaderName)
    .loader(goodtStyleLoader.loader)
    .options(goodtStyleLoader.options);
lessRule
    .use(goodtStyleLoader.name)
    .before(beforeLoaderName)
    .loader(goodtStyleLoader.loader)
    .options(goodtStyleLoader.options);
*/
module.exports = function(source) {
    const params = loaderUtils.parseQuery(this.resourceQuery);
    // scoped styles only
    if (params.type === 'style' && params.scoped) {
        const exports = evalModuleCode(this, source, this.request);
        const css = exports.toString();
        const filename = `css/scoped/${params.id}.css`;
        this.emitFile(filename, css);
    }
    return source;
};
