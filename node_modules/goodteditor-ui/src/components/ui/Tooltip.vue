<template>
    <div class="ui-tooltip">
        <!--
        @slot Target slot
        @binding {Object} binds         tooltip props (use v-bind)
        @binding {Object} events        tooltip events (use v-on)
        @binding {boolean} visible      whether tooltip is visible
        -->
        <slot name="target" v-bind="{ events: targetEvents, binds: targetBinds, visible }"></slot>
        <ui-popover
            v-bind="popoverOptions"
            :show.sync="popoverShow"
            ref="popover"
            @mouseenter.native="onPopoverMouseEnter"
            @mouseleave.native="onPopoverMouseLeave"
        >
            <!--
            @slot Tooltip slot
            @binding {Function} hide    function to hide tooltip
            -->
            <slot name="tooltip" v-bind="{ hide }">
                <div class="tooltip">
                    <!--
                    @slot Tooltip content slot
                    @binding {Function} hide    function to hide tooltip
                    -->
                    <slot v-bind="{ hide }"></slot>
                </div>
            </slot>
        </ui-popover>
    </div>
</template>
<style lang="less" scoped>
.ui-tooltip {
    display: contents;
}
</style>
<script>
import UiPopover from './Popover.vue';
import { Position, TriggerOn } from './utils/Helpers';
import WithPopover from './utils/WithPopover';

export default {
    components: { UiPopover },
    mixins: [WithPopover],
    props: {
        /**
         * Whether to show the tooltip
         */
        show: {
            type: Boolean,
            default: false,
        },
        /**
         * Hide delay in ms
         */
        hideDelay: {
            type: Number,
            default: 150,
        },
        position: {
            type: String,
            default: Position.TOP,
        },
        positionOffset: {
            type: Array,
            default() {
                return [0, 5];
            },
        },
        /**
         * Conditions to trigger tooltip
         * @default mousemove
         * @values mousemove,click
         */
        triggerOn: {
            type: String,
            default: TriggerOn.MOUSE_MOVE
        }
    },
    data() {
        return {
            timeout: null,
        };
    },
    computed: {
        targetEvents() {
            if (this.triggerOn === TriggerOn.MOUSE_MOVE) {
                return {
                    mouseenter: this.onTargetMouseEnter,
                    mouseleave: this.onTargetMouseLeave,
                };
            }
            return {
                click: this.onTargetClick,
            };
        },
        targetBinds() {
            return {
                'data-popover': this.popoverTargetId,
            };
        },
        visible() {
            return this.popoverShow;
        }
    },
    watch: {
        show: {
            handler(v) {
                this.setShow(v);
            },
            immediate: true,
        },
    },
    methods: {
        setShow(val) {
            const { timeout, hideDelay } = this;
            if (timeout) {
                clearTimeout(timeout);
            }
            if (val) {
                this.popoverShow = true;
            } else {
                this.timeout = setTimeout(this.hide, hideDelay);
            }
        },
        onTargetMouseEnter(e) {
            this.setShow(true);
        },
        onTargetMouseLeave(e) {
            this.setShow(false);
        },
        onTargetClick(e) {
            this.setShow(!this.popoverShow);
        },
        onPopoverMouseEnter(e) {
            this.setShow(true);
        },
        onPopoverMouseLeave(e) {
            this.setShow(false);
        },
        hide() {
            this.popoverShow = false;
            /**
             * Event emitted after tooltip is hidden
             */
            this.$emit('hidden');
        }
    },
};
</script>
