<template>
    <div
        class="ui-input-color-picker form-elem"
        :class="cssClass"
        @focus="onRootFocus"
        tabindex="0"
        :data-popover="popoverTargetId"
    >
        <div class="ui-input-color-picker-wrapper d-flex flex-v-center w-100">
            <div style="flex: 1 0 0">
                <!--
                @slot Custom input slot
                @binding {String} id    input id attribute value
                @binding {String} value    input value
                @binding {Object} inputBinds    input props (use v-bind)
                @binding {Object} inputEvents    input events (use v-on)
                -->
                <slot name="input" v-bind="{ id: inputId, value, inputBinds, inputEvents }">
                    <input
                        :id="inputId"
                        class="ui-input-color-picker-input w-100"
                        type="text"
                        :value="value"
                        v-bind="inputBinds"
                        v-on="inputEvents"
                    />
                </slot>
            </div>
            <!--
            @slot Icon slot
            @binding {String} value     current value
            @binding {Function} toggle  function that toggles the color picker
            -->
            <slot name="icon" v-bind="{ value, toggle: togglePopover }">
                <div
                    class="ui-input-color-picker-icon-preview mar-left-2"
                    :class="[ readonly ? 'events-none': 'cursor-pointer' ]"
                    :style="{ ...(isValid && { background: value }) }"
                    @click="togglePopover"
                ></div>
            </slot>
        </div>
        <ui-popover v-if="popoverShow" :show.sync="popoverShow" v-bind="popoverOptions">
            <color-picker
                class="ui-input-color-picker-cp pull-left"
                v-bind="{
                    value,
                    colorsDefault,
                    showSubmit: true,
                }"
                @close="onColorPickerClose"
                @submit="onColorPickerSubmit"
                @valid="emitValid"
            ></color-picker>
        </ui-popover>
    </div>
</template>
<style lang="less" scoped>
.ui-input-color-picker {
    display: inline-flex;
    /* unset default FormComponent mixin */
    &.disabled {
        pointer-events: none;
    }
    /* override default FormComponent mixin adding for "readonly" ".events-none" */
    &.readonly {
        pointer-events: all;
    }

    &-wrapper {
        display: flex;
    }

    &-icon-preview {
        width: 1em;
        height: 1em;
        border: 1px solid var(--color-border);
        background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAKAQMAAAC3/F3+AAAAA3NCSVQICAjb4U/gAAAABlBMVEXM1dv///9zs4+jAAAACXBIWXMAAAsSAAALEgHS3X78AAAAHHRFWHRTb2Z0d2FyZQBBZG9iZSBGaXJld29ya3MgQ1M26LyyjAAAABFJREFUCJljYD/AgIx+MCAjAHyDCLzvUxo8AAAAAElFTkSuQmCC');
    }

    &-input {
        border: none;
        margin: 0;
        padding: 0;
        line-height: 1.5;
        color: inherit;
        background: transparent;
        outline: none;

        &::placeholder {
            color: inherit;
        }
    }
}
</style>
<script>
import { isValidColorString } from './ColorPicker/utils';
import ColorPicker from './ColorPicker.vue';
import UiPopover from './Popover.vue';
import { Key } from './utils/Helpers';
import FormComponent from './utils/FormComponent';
import WithPopover from './utils/WithPopover';

export default {
    mixins: [FormComponent, WithPopover],
    components: { ColorPicker, UiPopover },
    props: {
        /**
         * Whether the input is editable
         */
        editable: {
            type: Boolean,
            default: true
        },
        /**
         * Default colors palette
         */
        colorsDefault: {
            type: Array,
            default() {
                return [];
            }
        }
    },
    data() {
        return {
            isValid: false,
            inputBinds: {
                placeholder: this.placeholder,
                readonly: this.readonly || !this.editable,
                disabled: this.disabled
            },
            inputEvents: {
                input: this.onInputInput,
                change: this.onInputChange,
                focus: this.onInputFocus,
                blur: this.onInputBlur,
                keydown: this.onInputKeydownLocal
            }
        };
    },
    created() {
        this.validateInput(this.value);
    },
    methods: {
        inputColor(val) {
            /**
             * Input event
             * @property {String} color
             */
            this.$emit('input', val);
        },
        changeColor(val) {
            /**
             * Change event
             * @property {String} color
             */
            this.$emit('change', val);
        },
        emitValid(isValid) {
            this.$emit('valid', isValid);
        },
        validateInput(value) {
            const isValid = value === '' ? true : isValidColorString(value);
            this.isValid = isValid;
            this.emitValid(isValid);
        },
        // EVENT HANDLERS
        onRootFocus(e) {
            if (this.disabled) {
                return;
            }
            let input = this.getInputRef();
            input && input.focus();
        },
        onInputChange(e) {
            const { value } = e.target;
            this.validateInput(value);
            this.changeColor(value);
        },
        onInputInput(e) {
            const { value } = e.target;
            this.validateInput(value);
            this.inputColor(e.target.value);
        },
        onInputFocus(e) {
            if (this.disabled) {
                return;
            }
            this.rootHasFocus = true;
        },
        onInputBlur(e) {
            this.rootHasFocus = false;
        },
        onColorPickerSubmit({ value: colorString }) {
            if (this.readonly || this.disabled) {
                return;
            }
            this.inputColor(colorString);
            this.changeColor(colorString);
            this.onColorPickerClose();
        },
        onInputKeydownLocal(e) {
            if (e.key === Key.ESC) {
                if (this.popoverShow) {
                    e.stopImmediatePropagation();
                    this.onColorPickerClose();
                    return;
                }
                this.onInputKeydown(e);
            }
        },
        onColorPickerClose() {
            this.popoverShow = false;
            this.getInputRef().focus();
        }
    }
};
</script>
