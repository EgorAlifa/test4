<template>
    <ui-tooltip @hidden="onHidden">
        <template #target="{ binds, events, visible }">
            <button
                v-bind="binds"
                v-on="events"
                :title="title"
                :class="{ 'btn-outline': !visible }"
                class="btn btn-small btn-icon btn-primary"
                @click="onClick">
                <div class="icon">
                    <i class="mdi" :class="icon"></i>
                </div>
            </button>
        </template>
        <div class="w-f2">
            <div class="row row-hgap-3 mar-bot-l1">
                <div class="col col-vmid text-truncate">
                    <div class="form-label form-label-xsmall text-truncate">Url</div>
                </div>
                <div class="col col-vmid col-12-12">
                    <div class="form-control form-control-icon-right w-12-12">
                        <input-autocomplete
                            v-model.trim.lazy="image.url"
                            :append-to-body="false"
                            size="small"
                            @change="onChange" />
                        <div class="icon" @click="browse">
                            <i class="mdi mdi-folder cursor-pointer color-grey" />
                        </div>
                    </div>
                </div>
            </div>

            <div class="row row-hgap-3 mar-bot-l1">
                <div class="col col-vmid text-truncate">
                    <label for="resp" class="form-label form-label-small text-truncate">
                        Отзывчивое изображение
                    </label>
                </div>
                <div class="col col-vmid col-auto">
                    <input
                        id="resp"
                        v-model="image.isResponsive"
                        type="checkbox"
                        class="switch switch-small pull-right"
                        @change="onChange">
                </div>
            </div>

            <div class="row row-hgap-3 mar-bot-l1">
                <div class="col col-vmid text-truncate">
                    <label class="form-label form-label-xsmall text-truncate">
                        Выровнять изображение
                    </label>
                </div>
                <div class="col col-vmid col-12-12">
                    <ui-select
                        v-model="image.align"
                        :options="$options.static.AlignOptions"
                        :append-to-body="false"
                        size="small"
                        class="w-100"
                        @change="onChange" />
                </div>
            </div>

            <div class="row row-hgap-l1">
                <div class="col">
                    <div class="row row-hgap-3">
                        <div class="col col-vmid text-truncate">
                            <div class="form-label form-label-xsmall text-truncate">Ширина</div>
                        </div>
                        <div class="col col-vmid col-12-12">
                            <input-units
                                v-model="image.width"
                                :units="$options.static.SizeUnits"
                                :disabled="image.isResponsive"
                                :append-to-body="false"
                                size="small"
                                @change="onChange">
                            </input-units>
                        </div>
                    </div>
                </div>
                <div class="col">
                    <div class="row row-hgap-3">
                        <div class="col col-vmid text-truncate">
                            <div class="form-label form-label-xsmall text-truncate">Высота</div>
                        </div>
                        <div class="col col-vmid col-12-12">
                            <input-units
                                v-model="image.height"
                                :units="$options.static.SizeUnits"
                                :disabled="image.isResponsive"
                                :append-to-body="false"
                                size="small"
                                @change="onChange">
                            </input-units>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </ui-tooltip>
</template>

<script>
import InputAutocomplete from '../../InputAutocomplete.vue';
import InputUnits from '../../InputUnits.vue';
import UiSelect from '../../Select.vue';
import UiTooltip from './components/Tooltip.vue';
import { useRender, RenderMixinTypes } from './mixins';

const SizeUnits = ['rem', 'em', '%', 'px', 'vh', 'vw'];
const AlignOptions = [
    { value: null, label: 'По левому краю' },
    { value: 'mar-h-auto', label: 'По центру' },
    { value: 'mar-left-auto', label: 'По правому краю' }
];

const defaultImgSettings = {
    url: '',
    isResponsive: true,
    align: null,
    height: '100%',
    width: '100%',
};

const cssStrToObj = (str) => {
    if (str == null) {
        return {};
    }
    return str.split(';').reduce((obj, style) => {
        const [name, val] = style.split(':').map((el) => el.trim());
        if (name != null && val != null) {
            obj[name] = val;
        }
        return obj;
    }, {});
}

export default {
    components: {
        InputAutocomplete,
        InputUnits,
        UiSelect,
        UiTooltip
    },
    mixins: [useRender()],
    data: () => ({
        image: { ...defaultImgSettings }
    }),
    static: {
        SizeUnits,
        AlignOptions
    },
    methods: {
        ...RenderMixinTypes,
        onClick() {
            this.setImageSettings();
        },
        setImageSettings() {
            const attrs = this.tool.getValue();

            if (JSON.stringify(attrs) === '{}') {
                return;
            }

            const { src: url, class: className, style } = attrs;
            const { width, height } = cssStrToObj(style);
            const align = className.match(/mar-\w+-\w+/);

            this.image = {
                ...defaultImgSettings,
                url,
                isResponsive: className?.includes('responsive') ?? false,
                align: align?.[0] ?? null,
                ...(width && { width }),
                ...(height && { height })
            };
        },
        async browse() {
            await this.tool.exec(this.image);
            const { src: url } = this.tool.getValue();
            this.image = { ...this.image, url };
            this.emitExecuted();
        },
        onChange() {
            this.tool.exec(this.image);
            this.emitExecuted();
        },
        onHidden() {
            this.image = { ...defaultImgSettings };
        }
    }
};
</script>
