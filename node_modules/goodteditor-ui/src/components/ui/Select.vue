<template>
    <div
        class="ui-select form-elem"
        :class="cssClassExt"
        @keydown.prevent="onKeyDown"
        @click="onClick"
        tabindex="0"
        :data-popover="popoverTargetId">
        <div class="ui-select-label u-select-none">
            <template v-if="multiple">
                <template v-if="optionsSelected.length">
                    <!--
                    @slot Label slot for multiple mode
                    @binding {Object} option                option
                    @binding {any} value                    option's value
                    @binding {String} label                 option's label
                    @binding {Function} deselectOption      deselects option function(option:Object)
                    -->
                    <slot
                        name="label-multiple"
                        v-for="(option, index) in optionsSelected"
                        v-bind="{
                            option,
                            value: getOptionValue(option),
                            label: getOptionLabel(option),
                            deselectOption
                        }">
                        <ui-badge
                            class="mar-none mar-right-2"
                            theme="primary"
                            size="small"
                            :key="index"
                            removable
                            @click.native.stop
                            @remove="deselectOption(option)">
                            <span>{{ getOptionLabel(option) }}</span>
                        </ui-badge>
                    </slot>
                </template>
                <div class="ui-select-placeholder events-none" v-else>
                    <!--
                    @slot Placeholder slot
                    -->
                    <slot name="placeholder">
                        <input class="w-100" :placeholder="placeholder" />
                    </slot>
                </div>
            </template>

            <template v-else>
                <!--
                @slot Label slot for single mode
                @binding {Object} option    option
                @binding {any} value        option's value
                @binding {String} label     option's label
                -->
                <slot
                    name="label"
                    v-bind="{
                        option: optionsSelected[0],
                        value: getOptionValue(optionsSelected[0]),
                        label: getOptionLabel(optionsSelected[0]),
                        index: getOptionIndex(optionsSelected[0])
                    }"
                    v-if="optionsSelected.length">
                    {{ getOptionLabel(optionsSelected[0]) }}
                </slot>
                <div class="ui-select-placeholder events-none" v-else>
                    <!--
                    @slot Placeholder slot
                    -->
                    <slot name="placeholder">
                        <input class="w-100" :placeholder="placeholder" />
                    </slot>
                </div>
            </template>
        </div>
        <!--
        @slot Open state icon slot
        -->
        <slot name="icon-open" v-if="popoverShow">
            <div class="icon w-auto h-auto mar-left-2 events-none">
                <i class="mdi mdi-chevron-up"></i>
            </div>
        </slot>
        <!--
        @slot Close state icon slot
        -->
        <slot name="icon-close" v-else>
            <div class="icon w-auto h-auto mar-left-2 events-none">
                <i class="mdi mdi-chevron-down"></i>
            </div>
        </slot>

        <ui-popover :show.sync="popoverShow" v-bind="popoverOptions">
            <ui-datalist
                class="w-100 pull-left"
                @click.native.stop
                @select-option="onDatalistSelectOption"
                v-bind="{ size, options, class: datalistCssClass }"
                :cursorIndex.sync="dataListCursorIndex"
                ref="datalist">
                <template #header>
                    <!--
                    @slot Dropdown header slot
                    -->
                    <slot name="dropdown-header"></slot>
                </template>
                <template #option="{ option, index, cursorIndex }">
                    <!--
                    @slot before option slot
                    @binding {Object} option             option
                    @binding {any} value                 option's value
                    @binding {String} label              option's label
                    @binding {Number} index              option's index
                    @binding {Boolean} isSelected        option selection status
                    @binding {Number} cursorIndex        current cursor index
                    @binding {Function} selectOption     function that selects option
                    @binding {Function} deselectOption   function that deselects option
                    @binding {Function} toggleOption     function that toggles option selection
                    -->
                    <slot
                        name="option:before"
                        v-bind="{
                            option,
                            value: getOptionValue(option),
                            label: getOptionLabel(option),
                            index,
                            cursorIndex,
                            isSelected: isOptionSelected(option),
                            selectOption,
                            deselectOption,
                            toggleOption
                        }"></slot>
                    <!--
                    @slot option slot mode
                    @binding {Object} option             option
                    @binding {any} value                 option's value
                    @binding {String} label              option's label
                    @binding {Number} index              option's index
                    @binding {Boolean} isSelected        option selection status
                    @binding {Number} cursorIndex        current cursor index
                    @binding {Function} selectOption     function that selects option
                    @binding {Function} deselectOption   function that deselects option
                    @binding {Function} toggleOption     function that toggles option selection
                    @binding {Number} optionIndex           option's index
                    @binding {Boolean} isOptionSelected     option selection status
                    -->
                    <slot
                        name="option"
                        v-bind="{
                            option,
                            value: getOptionValue(option),
                            label: getOptionLabel(option),
                            index,
                            isSelected: isOptionSelected(option),
                            cursorIndex,
                            selectOption,
                            deselectOption,
                            toggleOption,
                            // legacy
                            optionIndex: index,
                            isOptionSelected: isOptionSelected(option)
                        }">
                        <li
                            :class="{
                                active: isOptionSelected(option),
                                'bg-grey-lighter': index == cursorIndex
                            }"
                            :key="index"
                            :title="getOptionLabel(option)"
                            @click.stop="toggleOption(option)">
                            <div class="row row-collapse" v-if="multiple">
                                <div class="col col-vmid text-truncate">
                                    <div class="text-truncate" style="min-height: calc(var(--line-height) * 1em)">
                                        <slot
                                            name="option-label"
                                            v-bind="{
                                                option,
                                                value: getOptionValue(option),
                                                label: getOptionLabel(option),
                                                index,
                                                isSelected: isOptionSelected(option),
                                                cursorIndex
                                            }">
                                            {{ getOptionLabel(option) }}
                                        </slot>
                                    </div>
                                </div>
                                <div class="col col-auto col-vmid" v-if="isOptionSelected(option)">
                                    <i class="mdi mdi-check" style="line-height: 1"></i>
                                </div>
                            </div>
                            <div class="text-truncate" style="min-height: calc(var(--line-height) * 1rem)" v-else>
                                <!--
                                @slot option content slot
                                -->
                                <slot
                                    name="option-label"
                                    v-bind="{
                                        option,
                                        value: getOptionValue(option),
                                        label: getOptionLabel(option),
                                        index,
                                        isSelected: isOptionSelected(option),
                                        cursorIndex
                                    }">
                                    {{ getOptionLabel(option) }}
                                </slot>
                            </div>
                        </li>
                    </slot>
                    <!--
                    @slot after option slot
                    @binding {Object} option             option
                    @binding {any} value                 option's value
                    @binding {String} label              option's label
                    @binding {Number} index              option's index
                    @binding {Boolean} isSelected        option selection status
                    @binding {Number} cursorIndex        current cursor index
                    @binding {Function} selectOption     function that selects option
                    @binding {Function} deselectOption   function that deselects option
                    @binding {Function} toggleOption     function that toggles option selection
                    -->
                    <slot
                        name="option:after"
                        v-bind="{
                            option,
                            value: getOptionValue(option),
                            label: getOptionLabel(option),
                            index,
                            isSelected: isOptionSelected(option),
                            cursorIndex,
                            selectOption,
                            deselectOption,
                            toggleOption
                        }"></slot>
                </template>
                <template #footer>
                    <!--
                    @slot Dropdown footer slot
                    -->
                    <slot name="dropdown-footer"></slot>
                </template>
            </ui-datalist>
        </ui-popover>
    </div>
</template>
<style lang="less" scoped>
.ui-select {
    display: inline-flex;
    align-items: center;

    &-label {
        white-space: nowrap;
        text-overflow: ellipsis;
        overflow: hidden;
        flex: 1 0 0;
    }

    &-placeholder {
        input {
            border: none;
            margin: 0;
            padding: 0;
            color: inherit;
            background: transparent;
        }
    }
}
</style>
<script>
import UiBadge from './Badge.vue';
import UiDatalist from './Datalist.vue';
import UiPopover from './Popover.vue';
import FormComponent from './utils/FormComponent';
import WithPopover from './utils/WithPopover';
import { Key } from './utils/Helpers';

export default {
    components: {
        UiBadge,
        UiDatalist,
        UiPopover
    },
    mixins: [FormComponent, WithPopover],
    props: {
        /**
         * @model
         */
        value: {
            default() {
                return null;
            }
        },
        /**
         * Options. Array of Objects (option objects)
         */
        options: {
            type: Array,
            default() {
                return [];
            }
        },
        /**
         * Datalist css classes (optional)
         */
        datalistCssClass: {
            type: [String, Array],
            default: ''
        },
        /**
         * Allow multiple selection
         */
        multiple: {
            type: Boolean,
            default: false
        },
        /**
         * Defines whether 'value' is the option value field or option object
         * @see options
         */
        valueObjects: {
            type: Boolean,
            default: false
        },
        /**
         * Defines the 'value' field of the option Object
         */
        valueField: {
            type: [String, Symbol],
            default: 'value'
        },
        /**
         * Defines the 'label' field of the option Object
         */
        labelField: {
            type: [String, Symbol],
            default: 'label'
        },
        autoWidth: {
            default: true
        },
        /**
         * Alternative function to detect if option Object selected
         * by compare model value with option Object valueField value
         */
        valueOfOptionChecker: {
            type: Function,
            default: null
        }
    },
    data() {
        return {
            optionsSelected: [],
            dataListCursorIndex: -1
        };
    },
    computed: {
        /**
         * @return {object}
         */
        cssClassExt() {
            let obj = { 'u-select-none': this.readonly };
            return { ...this.cssClass, ...obj };
        }
    },
    watch: {
        value: {
            handler(model) {
                this.importModel(model);
            },
            immediate: true
        },
        options() {
            this.importModel(this.value);
        }
    },
    methods: {
        isValueOfOptionDefault(option, modelItem) {
            const modelValue = this.valueObjects ? this.getOptionValue(modelItem) : modelItem;
            const optionValue = this.getOptionValue(option);
            return modelValue === optionValue;
        },
        /**
         * @param option
         * @param modelItem
         * @return {boolean}
         */
        isValueOfOption(option, modelItem) {
            const { valueOfOptionChecker, isValueOfOptionDefault } = this;
            const isTrue = valueOfOptionChecker ?? isValueOfOptionDefault;
            return isTrue(option, modelItem);
        },
        /**
         * @param model
         */
        importModel(model) {
            const { options, isValueOfOption } = this;
            const models = [model].flat();
            const optionsSelected = options.filter((option) =>
                models.some((modelItem) => isValueOfOption(option, modelItem))
            );
            if (optionsSelected.length > 0) {
                this.dataListCursorIndex = this.getOptionIndex(optionsSelected[0]);
                this.optionsSelected = this.multiple ? optionsSelected : [optionsSelected[0]];
            } else {
                this.dataListCursorIndex = -1;
                this.optionsSelected = [];
            }
        },
        exportModel() {
            const model = this.optionsSelected.map((option) =>
                this.valueObjects ? option : this.getOptionValue(option)
            );
            return this.multiple ? model : model[0] ?? null;
        },
        /**
         *
         * @param {function(): void} rollback
         */
        triggerModelChange(rollback) {
            let value = this.exportModel();
            /**
             * Input event
             * @property {any} value
             */
            this.$emit('input', value, { cancel: rollback });
            /**
             * Change event
             * @property {any} model
             * @property {Array} meta
             */
            this.$emit('change', value, { cancel: rollback });
        },
        getOptionLabel(option) {
            let label = option ? option[this.labelField] : null;
            return label == null ? option : label;
        },
        getOptionValue(option) {
            let value = option ? option[this.valueField] : null;
            // @NOTE option.value might be 'null'
            return value === undefined ? option : value;
        },
        getOptionIndex(option) {
            return this.options.indexOf(option);
        },
        isOptionSelected(option) {
            return this.optionsSelected.includes(option);
        },
        createOptionRollback() {
            const optionsSelected = [...this.optionsSelected];
            return () => {
                this.optionsSelected = optionsSelected;
                const rollback = this.createOptionRollback();
                this.triggerModelChange(rollback);
            };
        },
        selectOption(option) {
            if (this.isOptionSelected(option)) {
                return;
            }

            const rollback = this.createOptionRollback();
            if (this.multiple) {
                this.optionsSelected.push(option);
            } else {
                this.optionsSelected = [option];
                this.popoverShow = false;
            }

            this.triggerModelChange(rollback);
        },
        deselectOption(option) {
            if (!this.multiple) {
                this.popoverShow = false;
                return;
            }
            const rollback = this.createOptionRollback();
            this.optionsSelected.splice(this.optionsSelected.indexOf(option), 1);
            this.triggerModelChange(rollback);
        },
        toggleOption(option) {
            if (!this.isOptionSelected(option)) {
                this.selectOption(option);
            } else {
                this.deselectOption(option);
            }
        },
        getDatalistRef() {
            return this.$refs.datalist;
        },
        onClick(e) {
            this.togglePopover();
            this.rootHasFocus = true;
            this.$el.focus();
            if (this.popoverShow && this.optionsSelected.length) {
                this.dataListCursorIndex = this.getOptionIndex(this.optionsSelected[0]);
            }
        },
        onDatalistSelectOption({ option }) {
            this.toggleOption(option);
        },
        onKeyDown(e) {
            let list = this.getDatalistRef();
            if (e.key === Key.ESC) {
                if (this.popoverShow) {
                    e.stopPropagation();
                    this.popoverShow = false;
                    return;
                }
                if (this.rootHasFocus) {
                    e.stopPropagation();
                    this.rootHasFocus = false;
                    this.$el.blur();
                }
                return;
            }
            if (e.key === Key.ENTER && !this.popoverShow) {
                this.popoverShow = true;
            }
            if (this.popoverShow) {
                list && list.onKeyDown(e);
            }
        }
    }
};
</script>
